# Week 05 Context7 查证结果

> 查证日期：2026-02-12
> 查证范围：scipy.stats 概率分布、numpy.random、seaborn 分布可视化、pandas、matplotlib probplot

---

## 1. scipy.stats 概率分布

### 生成随机数（rvs）

**推荐用法**：
```python
from scipy.stats import norm, binom, poisson

# 正态分布生成随机数
samples = norm.rvs(loc=0, scale=1, size=100, random_state=42)

# 二项分布生成随机数
samples = binom.rvs(n=10, p=0.5, size=100, random_state=42)

# 泊松分布生成随机数
samples = poisson.rvs(mu=5, size=100, random_state=42)
```

### 计算概率（pmf/pdf/cdf）

**推荐用法**：
```python
from scipy.stats import norm, binom, poisson

# 正态分布 - 连续分布用 pdf
pdf_value = norm.pdf(x=0, loc=0, scale=1)  # 概率密度
cdf_value = norm.cdf(x=0, loc=0, scale=1)  # 累积概率

# 二项分布 - 离散分布用 pmf
pmf_value = binom.pmf(k=5, n=10, p=0.5)  # P(X=k)
cdf_value = binom.cdf(k=5, n=10, p=0.5)    # P(X<=k)

# 泊松分布 - 离散分布用 pmf
pmf_value = poisson.pmf(k=3, mu=5)  # P(X=k)
cdf_value = poisson.cdf(k=3, mu=5)    # P(X<=k)
```

### 冻结分布对象（Frozen RV）

**推荐用法**（避免重复传参）：
```python
from scipy.stats import norm

# 创建冻结的分布对象
rv = norm(loc=0, scale=1)  # 或直接 norm() 使用默认参数

# 然后直接调用方法，无需重复传参
pdf_values = rv.pdf(x)
cdf_values = rv.cdf(x)
samples = rv.rvs(size=100)
```

**注意事项**：
- **离散分布**（binom, poisson）用 `pmf` 计算概率质量函数
- **连续分布**（norm）用 `pdf` 计算概率密度函数
- 随机种子通过 `random_state` 参数设置（兼容 NumPy Generator）

---

## 2. numpy.random 新 API

### 推荐使用 Generator（新 API）

**推荐用法**：
```python
import numpy as np

# 创建随机数生成器（推荐）
rng = np.random.default_rng(seed=42)

# 从各种分布采样
normal_samples = rng.normal(loc=0, scale=1, size=100)
binomial_samples = rng.binomial(n=10, p=0.5, size=100)
poisson_samples = rng.poisson(lam=5, size=100)
uniform_samples = rng.random(size=100)  # 均匀分布 [0, 1)
```

### 随机种子设置

**推荐用法**：
```python
# 方法1：直接传入种子
rng = np.random.default_rng(seed=42)

# 方法2：使用 secrets 生成大种子（更安全）
import secrets
large_seed = secrets.randbits(128)
rng = np.random.default_rng(large_seed)
```

### 与旧 API 的区别

| 特性 | 旧 API（numpy.random.*） | 新 API（Generator） |
|--------|---------------------------|---------------------|
| 调用方式 | `np.random.normal(...)` | `rng = np.random.default_rng(); rng.normal(...)` |
| 全局状态 | 有全局状态，影响可复现性 | 无全局状态，更独立 |
| 种子设置 | `np.random.seed(42)` | `rng = np.random.default_rng(42)` |
| 推荐度 | 已弃用 | **推荐使用** |

**注意事项**：
- 旧 API 如 `np.random.poisson(lam=5, size=100)` 仍可用，但文档明确说明"新代码应使用 Generator"
- Week 05 教学中应**优先展示新 API**，避免让学生学习已弃用的写法

---

## 3. seaborn 分布可视化

### 推荐函数选择

| 函数 | 类型 | 推荐场景 |
|------|--------|-----------|
| `displot` | figure-level | 需要分面（facet）或多图时使用 |
| `histplot` | axes-level | 单独绘制直方图时使用（可与 matplotlib subplot 结合） |
| `kdeplot` | axes-level | 单独绘制密度曲线时使用 |
| `ecdfplot` | axes-level | 绘制经验累积分布函数 |

**推荐用法**：
```python
import seaborn as sns

# figure-level：适合独立绘图
sns.displot(data=df, x="column", kde=True)  # 自动叠加 KDE
sns.displot(data=df, x="column", kind="kde")  # 纯 KDE
sns.displot(data=df, x="column", kind="ecdf")  # ECDF

# axes-level：适合子图组合
fig, axes = plt.subplots(1, 2)
sns.histplot(data=df, x="column", kde=True, ax=axes[0])
sns.kdeplot(data=df, x="column", ax=axes[1])
```

### 叠加理论分布曲线

**方法 1：使用 seaborn 的 kde=True（简化版）**
```python
import seaborn as sns
import matplotlib.pyplot as plt

# 绘制直方图并自动叠加 KDE
sns.histplot(data=sample, stat="density", kde=True)
plt.show()
```

**方法 2：手动叠加 scipy.stats 理论分布**
```python
import seaborn as sns
import matplotlib.pyplot as plt
from scipy.stats import norm

# 绘制直方图
sns.histplot(data=sample, stat="density", alpha=0.6)

# 手动叠加理论正态分布曲线
x = np.linspace(sample.min(), sample.max(), 100)
rv = norm(loc=sample.mean(), scale=sample.std())
plt.plot(x, rv.pdf(x), 'r-', lw=2, label='理论分布')
plt.legend()
plt.show()
```

**注意事项**：
- `distplot` **已弃用**，不要在教学代码中使用
- `stat="density"` 将直方图归一化为概率密度，便于与理论 PDF 比较

---

## 4. matplotlib probplot（QQ 图）

### 推荐用法

```python
from scipy import stats
import matplotlib.pyplot as plt
import numpy as np

# 生成数据
np.random.seed(42)
data = stats.norm.rvs(loc=0, scale=1, size=100)

# 绘制 QQ 图（默认对比正态分布）
fig, ax = plt.subplots()
stats.probplot(data, plot=ax)
ax.set_title('QQ Plot')
plt.show()

# 指定其他分布
stats.probplot(data, dist=stats.norm, plot=plt)

# 获取结果（不绘图）
osm, osr = stats.probplot(data, plot=None)
```

**注意事项**：
- `probplot` 需要配合 `plt.show()` 或 `plt.savefig()` 才能显示/保存
- 默认对比正态分布（`dist='norm'`）
- 返回值包含理论分位数（osm）和有序响应（osr）

---

## 5. pandas 模拟数据结构

### 推荐用法

```python
import pandas as pd
import numpy as np

# 创建模拟数据
df = pd.DataFrame({
    'group': np.random.choice(['A', 'B', 'C'], size=100),
    'value': np.random.normal(loc=0, scale=1, size=100)
})

# 基本操作
df['new_col'] = df['value'] * 2  # 向量化运算
df_filtered = df[df['group'] == 'A']  # 筛选
group_means = df.groupby('group')['value'].mean()  # 分组统计
```

**注意事项**：
- Week 05 主要用 pandas 存储模拟结果，不需要深入教学 pandas 功能
- 保持简单：创建、筛选、分组统计即可

---

## 6. 综合代码示例

### 模拟 + 可视化 + 理论分布叠加

```python
import numpy as np
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
from scipy.stats import norm

# 1. 设置随机种子
rng = np.random.default_rng(seed=42)

# 2. 模拟数据（正态分布）
n = 1000
mu, sigma = 0, 1
sample = rng.normal(loc=mu, scale=sigma, size=n)

# 3. 存入 DataFrame
df = pd.DataFrame({'value': sample})

# 4. 创建冻结的分布对象
rv = norm(loc=mu, scale=sigma)

# 5. 可视化：直方图 + KDE + 理论分布
fig, ax = plt.subplots(figsize=(10, 6))

# 直方图（归一化）
sns.histplot(data=df, x='value', stat='density', alpha=0.6, ax=ax, label='模拟数据')

# KDE 曲线
sns.kdeplot(data=df['value'], ax=ax, label='KDE')

# 理论 PDF 曲线
x = np.linspace(df['value'].min(), df['value'].max(), 100)
ax.plot(x, rv.pdf(x), 'r--', lw=2, label=f'N({mu}, {sigma}²)')

ax.legend()
ax.set_title('模拟分布 vs 理论分布')
plt.show()

# 6. QQ 图验证
from scipy import stats
fig, ax = plt.subplots()
stats.probplot(df['value'], plot=ax)
ax.set_title('QQ Plot - 正态性检验')
plt.show()
```

---

## 7. Week 05 教学建议

1. **优先展示新 API**：
   - `np.random.default_rng()` 而非 `np.random.seed()`
   - `sns.histplot()` / `sns.displot()` 而非 `sns.distplot()`

2. **冻结分布对象的教学**：
   - 这是 scipy.stats 的重要概念，可以避免重复传参
   - 适合讲解"固定参数的分布"这一抽象

3. **分布可视化层次**：
   - 简单场景：`sns.histplot(kde=True)`
   - 需要理论对比：手动叠加 `scipy.stats` 的 PDF
   - 正态性检验：`scipy.stats.probplot`

4. **代码风格**：
   - 使用 `random_state` / `seed` 参数确保可复现
   - 使用 `stat="density"` 进行归一化比较
   - 注明弃用警告（distplot）

---

## 8. 查证来源

- scipy.stats: `/websites/scipy_doc_scipy`
- numpy.random: `/numpy/numpy`
- seaborn: `/mwaskom/seaborn`
- matplotlib: `/matplotlib/matplotlib`
- pandas: `/websites/pandas_pydata`
