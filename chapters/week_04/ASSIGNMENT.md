# Week 04 作业：探索性数据分析与假设生成

> "数据不会说话，除非你学会提问。"

本周作业要求你从清洗后的数据出发，发现变量间的关系、比较群体差异，并把这些发现转化为可检验的研究假设。

---

## 作业结构

| 层级 | 内容 | 建议时间 |
|------|------|----------|
| 基础作业（必做） | 相关性分析、分组比较、混杂识别、假设清单 | 3-4 小时 |
| 进阶作业（选做） | 交互效应探索、多种相关性方法对比 | 1-2 小时 |
| 挑战作业（选做） | 发现伪相关并解释原因 | 1 小时 |
| AI 协作练习（可选） | 审查 AI 生成的 EDA 报告 | 1 小时 |

---

## 基础作业（必做）

### 任务 1：相关性分析（25 分）

**目标**：计算并解释变量间的相关性，理解"相关不等于因果"。

**步骤**：

1. **计算相关性矩阵**
   - 选择至少 3 个数值型变量
   - 分别计算 Pearson 和 Spearman 相关系数
   - 比较两种方法的结果差异

2. **解读关键发现**
   - 找出相关系数绝对值最大的变量对
   - 解释这个相关在业务上可能意味着什么
   - 思考：这是因果关系吗？有没有可能是混杂变量导致的？

3. **可视化相关性**
   - 绘制相关性热力图
   - （可选）绘制关键变量对的散点图

**预期输出示例**：

```text
=== 相关性分析报告 ===

1. Pearson 相关性矩阵
|           | age   | income | spend |
|-----------|-------|--------|-------|
| age       | 1.000 | 0.423  | 0.215 |
| income    | 0.423 | 1.000  | 0.587 |
| spend     | 0.215 | 0.587  | 1.000 |

2. Spearman 相关性矩阵
|           | age   | income | spend |
|-----------|-------|--------|-------|
| age       | 1.000 | 0.398  | 0.198 |
| income    | 0.398 | 1.000  | 0.612 |
| spend     | 0.198 | 0.612  | 1.000 |

3. 关键发现
- 收入与消费的 Pearson r = 0.587，Spearman ρ = 0.612
- 两种方法结果接近，说明关系较为稳健，不受极端值严重影响
- 年龄与消费的相关性较弱（r = 0.215），可能受收入混杂

4. 业务解读
收入是消费的最强预测因子。年龄与消费的正相关可能是假象——
年龄大的人往往收入也高，真正驱动消费的是收入而非年龄本身。
```

**常见错误**：
- 看到正相关就直接解释为"A 导致 B"
- 不比较 Pearson 和 Spearman 的差异
- 忽略样本量对相关系数的影响

---

### 任务 2：分组比较分析（25 分）

**目标**：使用 groupby 和透视表发现不同群体的系统性差异。

**步骤**：

1. **选择分组变量**
   - 选择至少 1 个分类型变量（如用户等级、城市级别、性别等）
   - 解释为什么选择这个变量进行分组

2. **Groupby 分析**
   - 按分组变量计算描述统计（均值、中位数、标准差、计数）
   - 至少分析 2 个数值变量的组间差异

3. **透视表分析**
   - 创建至少 1 个透视表，展示两个维度的交叉效应
   - 解读：是否存在交互效应？

**预期输出示例**：

```text
=== 分组比较分析报告 ===

1. 按用户等级的消费分析（Groupby）
| 用户等级 | 平均消费 | 中位数 | 标准差 | 用户数 |
|----------|----------|--------|--------|--------|
| 普通     | 820      | 650    | 420    | 450    |
| 银卡     | 1580     | 1400   | 680    | 280    |
| 金卡     | 2850     | 2600   | 1200   | 150    |
| 钻石     | 5200     | 4800   | 2100   | 45     |

发现：用户等级与消费呈明显正相关，钻石用户消费是普通用户的 6 倍以上。

2. 城市级别 × 用户等级透视表（平均消费）
| 城市级别 | 普通  | 银卡  | 金卡  | 钻石  |
|----------|-------|-------|-------|-------|
| 一线     | 950   | 1820  | 3200  | 5800  |
| 二线     | 780   | 1450  | 2600  | 4800  |
| 三线     | 680   | 1280  | 2300  | 4200  |

发现：
- 主效应：一线城市消费普遍高于二三线
- 交互效应：城市级别差异在钻石用户中最明显（5800 vs 4200）
- 提示：城市级别和等级的效应不是简单叠加，而是互相放大
```

**常见错误**：
- 只看均值不看标准差（忽略组内差异）
- 不报告每组的样本量（小样本组的均值不可靠）
- 发现差异就直接下因果结论

---

### 任务 3：混杂变量识别（20 分）

**目标**：识别多变量关系中的潜在混杂，用分层分析检验关联的稳健性。

**步骤**：

1. **识别潜在混杂**
   - 从任务 1 的相关性分析中，找出一个"可能是混杂"的变量
   - 解释：为什么这个变量可能是混杂？（它同时影响 X 和 Y）

2. **分层分析**
   - 将数据按混杂变量分层（如按收入分为低/中/高三组）
   - 在每一层内重新计算 X 和 Y 的关系
   - 比较：分层前后的关系是否一致？

3. **结论**
   - 如果分层后关系消失或逆转，说明存在混杂
   - 如果分层后关系依然稳健，说明可能不是混杂

**预期输出示例**：

```text
=== 混杂变量分析报告 ===

研究问题：性别是否影响消费？

1. 整体分析
- 女性平均消费：2380 元
- 男性平均消费：2050 元
- 差异：+330 元（女性高 16%）

初步结论：女性消费更高？

2. 潜在混杂识别
收入可能是混杂变量：
- 收入影响消费（已知 r = 0.587）
- 收入可能与性别相关（需验证）

3. 按收入分层分析
| 收入层   | 女性平均消费 | 男性平均消费 | 差异   |
|----------|--------------|--------------|--------|
| 低收入   | 980          | 1020         | -40    |
| 中收入   | 1850         | 1820         | +30    |
| 高收入   | 4200         | 4150         | +50    |

4. 结论
- 分层后，性别差异几乎消失（从 330 元降到 50 元以内）
- 收入是混杂变量：女性消费高只是因为女性收入更高
- 原始结论"性别影响消费"不成立
```

**常见错误**：
- 不进行分层分析就直接声称"控制了混杂"
- 分层后样本量太小，结论不可靠
- 只分两层（高/低），中间层的信息丢失

---

### 任务 4：假设清单生成（30 分）

**目标**：从 EDA 发现中提炼 3-5 个可检验的假设，写成 H0/H1 形式。

**要求**：

每个假设必须包含以下字段：
- `id`：假设编号（H1, H2, H3...）
- `description`：假设描述（一句话）
- `H0`：零假设（默认状态，无效应）
- `H1`：备择假设（你想证明的）
- `data_support`：数据支持（引用具体的 EDA 发现）
- `proposed_test`：建议的统计检验方法
- `confounders`：潜在混杂变量
- `priority`：优先级（高/中/低）

**预期输出示例**：

```markdown
## 可检验假设清单

### 假设 H1 [高优先级]
**描述**：用户月收入与月消费金额存在正相关关系

**H0**：收入与消费的 Pearson 相关系数 = 0

**H1**：收入与消费的 Pearson 相关系数 > 0

**数据支持**：Pearson r = 0.587, p < 0.001（初步计算）；Spearman ρ = 0.612，结果稳健

**建议检验**：Pearson 相关性检验（单尾）

**潜在混杂**：年龄、城市级别、职业类型

**业务意义**：如果成立，收入可作为用户价值分层的重要指标

---

### 假设 H2 [高优先级]
**描述**：不同城市级别用户的平均消费存在显著差异

**H0**：一线 = 二线 = 三线城市的平均消费

**H1**：至少有一组城市的平均消费不同

**数据支持**：透视表显示一线城市均值 2850，二线 2150，三线 1780

**建议检验**：单因素方差分析 (ANOVA)，如显著则进行事后检验

**潜在混杂**：收入分布、用户等级构成可能不同

**业务意义**：如果成立，需要针对不同城市制定差异化运营策略

---

### 假设 H3 [中优先级]
**描述**：控制收入后，性别对消费无显著影响

**H0**：相同收入层内，男女消费差异 = 0

**H1**：相同收入层内，男女消费差异 ≠ 0

**数据支持**：分层分析显示层内差异 < 5%，整体差异主要由收入解释

**建议检验**：协方差分析 (ANCOVA) 或分层 t 检验

**潜在混杂**：年龄、职业类型、家庭状况

**业务意义**：如果 H0 成立，说明不应按性别而是按收入进行用户分层

---

### 假设 H4 [中优先级]
**描述**：用户等级与消费的关系受城市级别调节（交互效应）

**H0**：城市级别对用户等级-消费关系的调节效应 = 0

**H1**：城市级别对用户等级-消费关系有显著调节效应

**数据支持**：透视表显示钻石用户在一线 vs 三线消费差异（5800 vs 4200）
        明显大于普通用户在一线 vs 三线差异（950 vs 680）

**建议检验**：双因素方差分析（带交互项）

**潜在混杂**：收入、年龄

**业务意义**：如果成立，高等级用户在一线城市的运营投入 ROI 更高

---

### 假设 H5 [低优先级]
**描述**：年龄与消费的相关性完全由收入中介

**H0**：控制收入后，年龄与消费的偏相关系数 = 0

**H1**：控制收入后，年龄与消费的偏相关系数 ≠ 0

**数据支持**：年龄-消费 r = 0.215，年龄-收入 r = 0.423，收入-消费 r = 0.587

**建议检验**：偏相关分析或中介效应检验

**潜在混杂**：职业阶段、家庭负担

**业务意义**：如果 H0 成立，年龄本身不是运营重点，收入才是
```

**常见错误**：
- 假设描述模糊，无法检验（如"用户行为有差异"）
- H0/H1 写反或写得不互斥
- 没有数据支持，拍脑袋想假设
- 不考虑混杂变量

---

## 进阶作业（选做）

### 任务 5：交互效应探索（+10 分）

选择一个数值型因变量（如消费）和两个分类型自变量（如城市级别、用户等级）。

1. 计算每个组合单元格的均值和标准差
2. 绘制分组柱状图或箱线图，展示交互效应
3. 用文字描述：是否存在交互效应？是"增强型"还是"削弱型"？

---

### 任务 6：多种相关性方法对比（+10 分）

选择一对数值变量，完成以下分析：

1. 绘制散点图，观察关系形状（线性？单调？无明显关系？）
2. 计算 Pearson、Spearman、Kendall 三种相关系数
3. 比较三种系数的大小差异
4. 解释：为什么有差异？哪种方法最适合你的数据？

---

## 挑战作业（选做）

### 任务 7：发现伪相关（+10 分）

在你的数据中（或构造一个例子），找到一个"看起来相关但实际无关"的关系。

要求：
1. 展示两个变量的相关系数（可能还挺高）
2. 解释为什么这是伪相关（找到幕后操纵的第三个变量，或解释巧合原因）
3. 用分层分析或其他方法证明：控制某个变量后，原相关消失

**提示**：
- 可以寻找"时间趋势"导致的伪相关（如两个变量都随时间增长）
- 可以寻找"样本选择"导致的伪相关（如只看了某个子群体）
- 如果实在找不到，可以构造一个模拟数据来说明原理

---

## AI 协作练习（可选）

下面这段代码是某个 AI 工具生成的 EDA 分析报告片段：

```python
import pandas as pd
import seaborn as sns

def quick_eda(df):
    """AI 生成的快速 EDA 函数。"""
    results = {}

    # 1. 计算所有数值列的相关性
    numeric_cols = df.select_dtypes(include=['float64', 'int64']).columns
    corr_matrix = df[numeric_cols].corr()
    results['correlations'] = corr_matrix

    # 2. 找出强相关的变量对
    strong_corr = []
    for i in range(len(corr_matrix.columns)):
        for j in range(i+1, len(corr_matrix.columns)):
            col1, col2 = corr_matrix.columns[i], corr_matrix.columns[j]
            corr_val = corr_matrix.iloc[i, j]
            if abs(corr_val) > 0.5:
                strong_corr.append({
                    'var1': col1,
                    'var2': col2,
                    'correlation': corr_val,
                    'interpretation': f'{col1} 和 {col2} 强相关，建议深入研究'
                })
    results['strong_correlations'] = strong_corr

    # 3. 按第一个类别列分组比较
    cat_cols = df.select_dtypes(include=['object', 'category']).columns
    if len(cat_cols) > 0:
        group_col = cat_cols[0]
        group_stats = df.groupby(group_col)[numeric_cols].mean()
        results['group_comparison'] = group_stats

    return results

# 使用示例
# results = quick_eda(df)
# print(results['strong_correlations'])
```

**请审查这段代码**：

- [ ] 代码能运行吗？有没有潜在的错误？
- [ ] 变量命名清晰吗？输出结果容易理解吗？
- [ ] 有没有缺少错误处理的地方？（如没有数值列或类别列时）
- [ ] 相关性分析有没有问题？（如没有区分 Pearson/Spearman）
- [ ] 分组比较有没有问题？（如自动选择第一个类别列是否合理）
- [ ] "强相关"的阈值 0.5 是合理的吗？
- [ ] 有没有解释"为什么相关"？有没有考虑混杂变量？
- [ ] 你能写一个让它失败的测试用例吗？

**提交**：修复后的代码 + 你发现了哪些问题的简短说明（300 字以内）。

---

## StatLab 作业

在 `report.md` 中添加"探索性数据分析"章节。

### 必须包含的内容

1. **探索目标**（2-3 句话说明本次 EDA 要回答什么问题）
2. **相关性矩阵**（表格形式，至少 3 个变量）
3. **关键发现**（3-5 条 bullet points）
4. **分组比较结果**（至少 1 个 groupby 表格 + 解读）
5. **潜在混杂变量**（列出识别出的混杂及判断依据）
6. **假设清单**（3-5 个假设，H0/H1 形式）
7. **分析局限**（数据局限、方法局限、未控制的混杂）

### 格式参考

```markdown
## 探索性数据分析

> 本章记录从数据中发现的关系、差异与假设，为后续统计推断提供基础。
> 生成时间：2026-02-11

### 探索目标
本次 EDA 旨在回答：
1. 哪些用户特征与消费行为最相关？
2. 不同用户群体是否存在系统性消费差异？
3. 这些差异是否受其他变量（如收入）混杂？

### 变量关系发现
[相关性矩阵表格]

### 关键发现
1. ...
2. ...

### 分组比较发现
[分组统计表格]

### 潜在混杂变量
- ...

### 可检验假设清单
[假设 H1-H5]

### 分析局限
- ...
```

---

## 提交要求

### 文件列表

```
week_04/
├── data/
│   └── processed/        # 清洗后的数据（Week 03 产出）
├── scripts/
│   ├── 01_correlation_analysis.py    # 任务 1
│   ├── 02_group_comparison.py        # 任务 2
│   ├── 03_confounding_analysis.py    # 任务 3
│   └── 04_generate_hypotheses.py     # 任务 4
├── report.md             # 包含 EDA 章节和假设清单
└── README.md             # 运行说明
```

### Git 提交

至少 3 次 commit，建议：

```bash
# 第一次：完成相关性分析
git add scripts/01_correlation_analysis.py
git commit -m "feat: add correlation analysis with Pearson and Spearman"

# 第二次：完成分组比较和混杂分析
git add scripts/02_group_comparison.py scripts/03_confounding_analysis.py
git commit -m "feat: add group comparison and confounding analysis"

# 第三次：完成假设清单和报告
git add scripts/04_generate_hypotheses.py report.md
git commit -m "feat: add hypothesis list and EDA narrative to report"
```

### 提交内容

1. 所有脚本文件
2. 包含 EDA 章节的 report.md
3. README.md（说明如何运行脚本复现分析）
4. （可选）生成的图表文件

---

## 评分标准

详见 `RUBRIC.md`。

---

## 提示与资源

### 关键代码片段

**相关性矩阵**：
```python
# Pearson 相关系数
corr_pearson = df[['age', 'income', 'spend']].corr(method='pearson')

# Spearman 秩相关系数
corr_spearman = df[['age', 'income', 'spend']].corr(method='spearman')
```

**Groupby 分组统计**：
```python
group_stats = df.groupby('user_level').agg({
    'spend': ['mean', 'median', 'std', 'count'],
    'income': ['mean', 'median']
}).round(2)
```

**透视表**：
```python
pivot = pd.pivot_table(df,
                       values='spend',
                       index='city_tier',
                       columns='user_level',
                       aggfunc='mean',
                       margins=True)
```

**分层分析**：
```python
df['income_tier'] = pd.qcut(df['income'], q=3, labels=['低', '中', '高'])
stratified = df.groupby(['income_tier', 'gender'])['spend'].mean().unstack()
```

### 遇到困难？

- 参考 `starter_code/solution.py` 中的示例实现
- 回顾 CHAPTER.md 中的代码示例和角色对话
- 在讨论区提问，附上你的数据概况和具体困惑

---

**截止日期**：本周日 23:59
