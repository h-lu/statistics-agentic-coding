# Week 07 作业：多组比较与多重校正

**作业截止时间**：Week 08 上课前

**提交方式**：将代码和报告提交到你的 Git 仓库

---

## 基础作业（必须完成）

### 题目 1：计算 FWER——你检验了多少次？

小北有个计划："我要检验 10 个不同的假设，这样就能发现更多规律！"

请你帮小北算一下：

1. 如果检验 10 个独立的假设，每个假设的显著性水平 α = 0.05，"至少一个假阳性"的概率是多少？
2. 如果检验 20 个假设呢？
3. 如果检验 50 个假设呢？

**要求**：
- 写一个函数 `calculate_fwer(m, alpha=0.05)`，返回 FWER
- 打印一个表格：检验次数 | FWER | FWER百分比
- 用一句话解释：为什么检验次数越多，假阳性风险越大

**输入示例**：
```python
# m = 检验次数
# alpha = 单次检验的显著性水平
```

**输出示例**：
```
检验次数 | FWER    | FWER百分比
1        | 0.0500  | 5.00%
5        | 0.2262  | 22.62%
10       | 0.4013  | 40.13%
20       | 0.6415  | 64.15%
50       | 0.9231  | 92.31%
```

**提示**：
- FWER = 1 - (1 - α)^m
- 公式解释：m 次检验"全都不犯错"的概率是 (1-α)^m，所以"至少犯错一次"的概率是 1 - (1-α)^m

**常见错误**：
- 混淆"单个检验的假阳性率"和"整个家庭的假阳性率"
- 忘记说明独立性假设（公式只在检验独立时成立）
- 只算数字，不加解释

---

### 题目 2：执行 ANOVA——多组均值比较

你有三组用户数据（A、B、C 三个渠道的转化数据）。请执行单因素 ANOVA，判断三组转化率是否有显著差异。

**数据**（在 `starter_code/assignment_data.py` 中提供）：
```python
# 三组渠道的转化数据（1 = 转化，0 = 未转化）
channel_a = [0, 1, 0, 0, 1, 1, 0, 0, 0, 1, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, ...]
channel_b = [1, 1, 0, 1, 0, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1, ...]
channel_c = [0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, ...]
```

**要求**：
1. 计算三组的描述统计（样本量、均值、标准差）
2. 执行单因素 ANOVA，报告 F 统计量和 p 值
3. 检查前提假设：
   - 正态性（Shapiro-Wilk 检验）
   - 方差齐性（Levene 检验）
4. 根据 p 值得出结论：三组转化率是否有显著差异？

**输出格式**：
```
=== 描述统计 ===
      样本量   均值    标准差
A     100      0.25    0.43
B     100      0.32    0.47
C     100      0.18    0.38

=== 前提假设检查 ===
正态性（Shapiro-Wilk）：
  A组：p = 0.xxx ✅/❌
  B组：p = 0.xxx ✅/❌
  C组：p = 0.xxx ✅/❌
方差齐性（Levene）：p = 0.xxx ✅/❌

=== ANOVA 结果 ===
F 统计量：x.xxx
p 值：0.xxx

结论：p < 0.05，拒绝原假设 / p >= 0.05，无法拒绝原假设
```

**提示**：
- 使用 `scipy.stats.f_oneway` 执行 ANOVA
- 使用 `scipy.stats.shapiro` 检查正态性
- 使用 `scipy.stats.levene` 检查方差齐性
- 如果前提假设不满足，应该使用 Kruskal-Wallis 检验（`scipy.stats.kruskal`）

**常见错误**：
- 忘记检查前提假设
- 只报告 p 值，不报告 F 统计量
- 混淆"拒绝原假设"和"证明原假设"（我们只能拒绝或不拒绝，不能证明）

---

### 题目 3：事后比较——哪一对有差异？

假设题目 2 的 ANOVA 结果显著（p < 0.05）。现在你需要回答：**哪一对渠道有差异？**

**要求**：
1. 使用 Tukey HSD 检验执行事后比较
2. 列出所有两两比较的结果（均值差异、校正后 p 值、95% 置信区间）
3. 找出哪些比较是显著的（校正后 p < 0.05）

**输出格式**：
```
=== Tukey HSD 事后比较 ===
比较    | 均值差异 | 95% CI         | 校正后 p 值 | 显著?
A vs B  | +0.07    | [-0.02, 0.16] | 0.12       | ❌
A vs C  | +0.12    | [0.03, 0.21]  | 0.01       | ✅
B vs C  | +0.19    | [0.10, 0.28]  | 0.00       | ✅

显著比较：
- A vs C：p = 0.01，A 渠道转化率比 C 渠道高 12% [3%, 21%]
- B vs C：p = 0.00，B 渠道转化率比 C 渠道高 19% [10%, 28%]
```

**提示**：
- 使用 `statsmodels.stats.multicomp.pairwise_tukeyhsd`
- 注意：Tukey HSD 已经内置了多重比较校正，不需要再额外校正
- 如果数据不满足 ANOVA 假设，可以用非参数的事后比较（如 Dunn's test）

**常见错误**：
- 使用未校正的 t 检验做两两比较（假阳性率会飙升）
- 只看原始 p 值，不看校正后 p 值
- 忘记解释均值差异的实际意义（比如"高 2%，但商业意义不大"）

---

### 题目 4：校正方法比较——Bonferroni vs FDR

你有 20 个 p 值（在 `starter_code/assignment_data.py` 中提供）。请比较不同校正方法的效果。

**数据**：
```python
p_values = [0.001, 0.003, 0.008, 0.015, 0.023, 0.045, 0.067, 0.089, 0.12, 0.15,
            0.18, 0.22, 0.28, 0.35, 0.42, 0.51, 0.60, 0.72, 0.85, 0.94]
```

**要求**：
1. 计算未校正时有多少个显著（α = 0.05）
2. 计算 Bonferroni 校正后有多少个显著
3. 计算 FDR（Benjamini-Hochberg）校正后有多少个显著
4. 用表格比较三种方法的结果

**输出格式**：
```
=== 校正方法比较 ===
总假设数：20
显著性水平：0.05

方法          | 拒绝数 | 校正后 α 阈值 | 说明
未校正        | 6      | 0.050         | ...
Bonferroni    | 2      | 0.0025        | ...
FDR (BH)      | 4      | 可变          | ...

显著假设列表（FDR BH 校正后）：
- 假设 1：p = 0.001 → 校正后 p = 0.020 ✅
- 假设 2：p = 0.003 → 校正后 p = 0.030 ✅
- 假设 3：p = 0.008 → 校正后 p = 0.053 ❌ (接近边缘)
- 假设 4：p = 0.015 → 校正后 p = 0.075 ❌
```

**提示**：
- 使用 `statsmodels.stats.multitest.multipletests`
- Bonferroni：`method='bonferroni'`
- FDR：`method='fdr_bh'`
- 注意观察：Bonferroni 比 FDR 更保守（拒绝数更少）

**常见错误**：
- 只比较拒绝数量，不解释为什么会有差异
- 混淆"校正后 α 阈值"和"校正后 p 值"
- 忘记说明 FDR 的"可变阈值"特性（BH 方法的阈值随 p 值排序变化）

---

## 进阶作业（选做）

### 题目 5：非参数替代——当 ANOVA 假设不满足时

如果数据严重偏离正态分布，ANOVA 的结论可能不可靠。这时应该使用 Kruskal-Wallis 检验（非参数替代）。

**要求**：
1. 生成一组长尾分布的数据（如指数分布）
2. 对同一组数据分别执行：
   - ANOVA（参数方法）
   - Kruskal-Wallis（非参数方法）
3. 比较两种方法的结论是否一致
4. 解释：什么时候应该用 Kruskal-Wallis？

**输出格式**：
```
=== 数据分布检查 ===
正态性检验：p = 0.001 ❌ （严重偏离正态）

=== ANOVA（参数方法） ===
F = x.xxx, p = 0.xxx
结论：...

=== Kruskal-Wallis（非参数方法） ===
H = x.xxx, p = 0.xxx
结论：...

=== 方法选择建议 ===
当数据偏离正态时（Shapiro-Wilk p < 0.05），应优先使用 Kruskal-Wallis 检验。
```

**提示**：
- 使用 `numpy.random.exponential` 生成长尾数据
- 使用 `scipy.stats.kruskal` 执行非参数检验
- Kruskal-Wallis 检验的是"秩"（rank），不是原始值

**常见错误**：
- 只执行一种方法，不做比较
- 忘记检查数据的分布特征
- 混淆 Kruskal-Wallis 的 H 统计量和 ANOVA 的 F 统计量

---

### 题目 6：效应量计算——η² (Eta Squared)

p 值告诉你"是否有差异"，效应量告诉你"差异有多大"。ANOVA 的常用效应量是 η²（Eta Squared）。

**要求**：
1. 对题目 2 的数据计算 η²
2. 解释 η² 的含义："组间变异占总变异的比例"
3. 给出一个实际意义的解释（比如 "η² = 0.15 表示 15% 的变异可由组别解释"）

**输出格式**：
```
=== 效应量计算 ===
η² = SS_between / SS_total = xxx / xxx = 0.xxx

解释：
- η² = 0.01：小效应
- η² = 0.06：中等效应
- η² = 0.14：大效应

本研究 η² = 0.xxx，属于（小/中等/大）效应。
实际意义：组别可以解释 xxx% 的转化率变异，其余 xxx% 来自其他因素。
```

**提示**：
- SS_between = Σ n_i * (mean_i - grand_mean)²
- SS_total = Σ (x_ij - grand_mean)²
- η² = SS_between / SS_total
- 可以用 `scipy.stats.f_oneway` 返回的 F 统计量推算 η²

**常见错误**：
- 只报告 η² 数值，不解释实际意义
- 混淆 η² 和 Cohen's d（η² 是方差比例，Cohen's d 是标准化均值差）
- 忘报告 η² 的解读标准（小/中/大效应的阈值）

---

## 挑战作业（加分）

### 题目 7：完整分析流程——从数据到报告

使用 `starter_code/challenge_data.csv`（包含 5 个渠道、1000 个用户的转化数据），完成一份完整的多组比较报告。

**要求**：

1. **数据探索**（可视化）
   - 画一张箱线图，展示 5 个渠道的转化率分布
   - 画一张条形图，展示 5 个渠道的平均转化率（带误差线）

2. **假设检验**
   - 执行 ANOVA（检查前提假设）
   - 如果 ANOVA 显著，执行 Tukey HSD 事后比较
   - 计算 η² 效应量

3. **校正策略说明**
   - 说明你做了多少次比较
   - 说明为什么选择 Tukey HSD（而不是 Bonferroni 或未校正的 t 检验）

4. **撰写报告**
   - 用 Markdown 格式写一份 300-500 字的分析报告
   - 包含：结论、效应量、局限性、建议

**输出格式**：
```markdown
# 5 个渠道转化率的多组比较分析

## 数据概览
- 总样本量：1000（每个渠道 200 个用户）
- 转化率范围：x% - y%

## 可视化
[插入箱线图和条形图]

## 统计检验结果

### ANOVA
- F = x.xxx, p = 0.xxx
- η² = 0.xxx
- 结论：...

### Tukey HSD 事后比较
[插入表格]

## 结论与建议
统计结论：...
商业建议：...
局限性：...
```

**提示**：
- 报告应该让非统计专业的人也能看懂
- 不要只堆砌数字，要解释"这意味着什么"
- 诚实报告局限性（如样本量、假设检验的前提）

**评分标准**：
- 分析流程的完整性（20%）
- 报告的可读性（20%）
- 统计方法的正确性（30%）
- 校正策略的合理性（15%）
- 商业建议的合理性（15%）

---

## AI 协作练习（可选）

### 题目 8：审查 AI 生成的多组比较报告

假设你让 AI 分析 4 个渠道（A、B、C、D）的转化率差异，它给你生成了下面这份报告。请审查它，找出其中的问题。

**AI 生成的报告**：

> **4 个渠道转化率分析**
>
> 我们检验了 4 个渠道的转化率差异，结果如下：
>
> **描述统计**：
> - A 渠道：10.2%（500 个用户）
> - B 渠道：11.5%（500 个用户）
> - C 渠道：9.8%（500 个用户）
> - D 渠道：13.2%（500 个用户）
>
> **两两比较结果**（t 检验）：
> - A vs D：p = 0.02 ✅ 显著
> - B vs D：p = 0.04 ✅ 显著
> - C vs D：p = 0.01 ✅ 显著
> - A vs B：p = 0.35 ❌ 不显著
> - A vs C：p = 0.72 ❌ 不显著
> - B vs C：p = 0.28 ❌ 不显著
>
> **结论**：D 渠道显著优于 A、B、C 渠道（p < 0.05），建议全面切换到 D 渠道。

---

**审查清单**：

- [ ] **多重比较问题**：AI 做了多少次比较？是否做了校正？
  - 6 次比较，FWER ≈ 26%（未校正）
  - AI 没有说明是否使用了 Tukey HSD 或 Bonferroni 校正
  - 风险：观察到的"显著"结果可能是假阳性

- [ ] **检验方法选择**：AI 使用了什么检验？是否合适？
  - 转化率是二元数据，t 检验可能不是最佳选择
  - 应该先做 ANOVA（F 检验），再做 Tukey HSD
  - 或者使用比例检验（z 检验）

- [ ] **前提假设检查**：AI 检查了前提假设吗？
  - 报告中没有提到正态性、方差齐性检查
  - 转化率数据通常不服从正态分布

- [ ] **效应量报告**：AI 报告了效应量吗？
  - AI 只报告了 p 值，没有报告效应量（如 Cohen's h 或风险差）
  - D vs C：差异 3.4%，p = 0.01，但实际意义有限

- [ ] **因果推断**：AI 把"相关"说成"因果"了吗？
  - "建议全面切换到 D 渠道" —— 这是因果建议
  - 但观察性研究不能证明因果关系
  - 可能存在混淆变量（如 D 渠道的用户本身质量更高）

**你的任务**：

1. 写一份审查报告（200-300 字），列出你发现的问题
2. 给出修订建议（应该用什么检验、如何校正、如何改写结论）
3. （可选）用 Python 执行你建议的分析流程，验证你的结论

**提交物**：
- 审查报告（Markdown 格式）
- 你发现的 3-5 个问题列表
- 修订后的报告（可选，如果做了代码验证）

**提示**：
- 使用本周学到的知识：多重比较问题、ANOVA + Tukey HSD、校正方法
- 参考正文第 5 节"审查 AI 生成的多组比较结论"
- 如果你遇到困难，可以参考 `starter_code/solution.py`

**评分标准**（如果提交）：
- 识别问题的准确性（40%）
- 审查报告的说服力（30%）
- 修订建议的合理性（30%）

---

## 提交清单

**基础作业**（必须完成）：
- [ ] 题目 1：FWER 计算（代码 + 输出表格 + 解释）
- [ ] 题目 2：ANOVA 执行（代码 + 完整输出 + 结论）
- [ ] 题目 3：Tukey HSD 事后比较（代码 + 结果表格 + 解释）
- [ ] 题目 4：校正方法比较（代码 + 对比表格 + 解释）

**进阶作业**（选做）：
- [ ] 题目 5：Kruskal-Wallis 非参数检验
- [ ] 题目 6：η² 效应量计算

**挑战作业**（加分）：
- [ ] 题目 7：完整分析流程报告（Markdown + 代码）

**AI 协作练习**（可选）：
- [ ] 题目 8：AI 报告审查报告

---

## 常见问题与提示

**Q1：我可以直接复制示例代码吗？**
A：可以，但建议理解后再修改。直接复制可能无法通过不同的测试用例。

**Q2：如果数据不满足 ANOVA 假设怎么办？**
A：使用 Kruskal-Wallis 检验（非参数替代）。详见题目 5。

**Q3：Tukey HSD 和 Bonferroni 有什么区别？**
A：Tukey HSD 是专门为 ANOVA 事后比较设计的，比 Bonferroni 更高效（功效更高）。两者都控制 FWER，但 Tukey HSD 利用了"所有组样本量相同"的结构信息。

**Q4：FDR 和 Bonferroni 什么时候用？**
A：检验次数少（< 10）用 Bonferroni；检验次数多（> 20）用 FDR；探索性研究用 FDR，确认性研究用 Bonferroni。

**Q5：如果我遇到困难怎么办？**
A：可以参考 `starter_code/solution.py`，或者回顾本周的 `CHAPTER.md` 和示例代码。

---

## 学习目标自查

完成作业后，你应该能够：

- [ ] 解释为什么"多次检验"会增加假阳性风险
- [ ] 计算 FWER（family-wise error rate）
- [ ] 执行单因素 ANOVA 并解释 F 统计量
- [ ] 检查 ANOVA 的前提假设（正态性、方差齐性）
- [ ] 执行 Tukey HSD 事后比较
- [ ] 理解 Bonferroni 和 FDR 校正的区别
- [ ] 计算 η² 效应量
- [ ] 识别 AI 生成的多组比较报告中的常见错误

如果以上任何一点你不确定，建议重新阅读本周的 `CHAPTER.md` 或观看相关视频。
