# Week 07 作业：比较三组或更多

> "If you torture the data long enough, it will confess."
> — Ronald Coase

本周作业要求你**完整走一遍多组比较流程**：从理解"多次 t 检验"的陷阱，到正确使用 ANOVA 和事后检验，到解释效应量，到审查 AI 生成的多组比较报告。你不再只是"跑很多次 t 检验"，而是学会在控制假阳性率的前提下，做出可靠的多组比较决策。

---

## 作业结构

| 层级 | 内容 | 建议时间 |
|------|------|----------|
| 基础作业（必做） | 多次比较的陷阱计算、ANOVA 完整流程、效应量解释、卡方检验 | 3-4 小时 |
| 进阶作业（选做） | 方差不齐时的替代方法、FDR 控制方法 | 1-2 小时 |
| 挑战作业（可选） | 设计并执行你自己的多组比较分析 | 2-3 小时 |
| AI 协作练习（可选） | 审查 AI 生成的多组比较报告 | 1 小时 |

---

## 基础作业（必做）

### 任务 1：计算多重比较的假阳性率（15 分）

**目标**：通过计算理解"多次 t 检验"的陷阱

**背景**：小北有 5 个城市的数据，他准备跑 C(5,2) = 10 次 t 检验来判断哪些城市对之间有差异。老潘告诉他这会放大假阳性率。

**步骤**：

1. 计算 10 次独立检验的**整体第一类错误率（FWER）**：
   ```
   FWER = 1 - (1 - α)^m
   ```
   其中 α = 0.05，m = 10

2. 创建一个表格 `fwerr_calculation.md`，展示：
   - m = 1, 5, 10, 20 时的 FWER
   - 解释为什么"多次检验会放大假阳性率"

3. 回答以下问题：
   - 如果 m = 20，至少出现一次假阳性的概率是多少？
   - 如果你想控制整体假阳性率在 5%，Bonferroni 校正后的显著性阈值应该是多少？
   - 为什么不能简单地用"多次 t 检验"来做多组比较？

**评分标准**：
- FWER 计算正确（5 分）
- 表格清晰完整（5 分）
- 回答问题正确（5 分）

---

### 任务 2：完整 ANOVA 流程（30 分）

**目标**：执行完整的 ANOVA，包含前提假设检查、效应量计算和结果解释

**数据**：使用以下代码生成模拟数据（或使用 `examples/02_anova_example.py` 中生成的数据）

```python
import numpy as np
import pandas as pd

np.random.seed(42)
cities = ['北京', '上海', '广州', '深圳', '杭州']
data = {'城市': [], '消费': []}

means = [280, 310, 270, 320, 290]  # 各城市均值
common_std = 50  # 共同标准差

n_per_city = 100
for city, mean in zip(cities, means):
    consumptions = np.random.normal(loc=mean, scale=common_std, size=n_per_city)
    data['城市'].extend([city] * n_per_city)
    data['消费'].extend(consumptions.tolist())

df = pd.DataFrame(data)
```

**步骤**：

1. **前提假设检查**：
   - 对每个城市进行 Shapiro-Wilk 正态性检验
   - 进行 Levene 方差齐性检验
   - 检查独立性（设计检查）

2. **执行 ANOVA**：
   - 使用 `scipy.stats.f_oneway` 或 `statsmodels` 的 OLS 方法
   - 记录：F 统计量、p 值、自由度
   - **提示**：`scipy.stats.f_oneway` 更简洁（只返回 F 和 p 值），`statsmodels` 更完整（生成完整 ANOVA 表，包含 SS、df、MS）

3. **计算并解释效应量（η²）**：
   - η² = SSB / SST
   - 根据 Cohen's 标准解释（小/中/大效应）

4. **写一份完整报告** `anova_report.md`，包含：
   - 假设陈述（H0/H1）
   - 前提假设检查结果
   - ANOVA 表（SS、df、MS、F、p）
   - 效应量（η²）及其解释
   - 业务解读（这个统计结果在实际中意味着什么）

**评分标准**：
- 前提假设检查完整（8 分）
- ANOVA 执行正确（8 分）
- 效应量计算和解释正确（8 分）
- 报告结构清晰、解读准确（6 分）

---

### 任务 3：事后检验与多重比较校正（25 分）

**目标**：在 ANOVA 显著后，找出具体哪些组对之间存在差异

**背景**：任务 2 的 ANOVA 结果显示 F 显著（p < 0.05），这告诉我们"至少有一对城市均值不同"，但不知道具体是哪几对。

**步骤**：

1. **使用 Tukey HSD 进行事后检验**：
   - 使用 `statsmodels.stats.multicomp.pairwise_tukeyhsd`
   - 记录所有城市对的均值差异、校正后 p 值、95% CI

2. **对比 Bonferroni 校正的 t 检验**：
   - 计算 Bonferroni 校正后的显著性阈值（α' = 0.05 / 10）
   - 如果有现成代码，尝试运行并对比结果差异

3. **写一份事后检验报告** `posthoc_report.md`，包含：
   - Tukey HSD 结果表格
   - 哪些城市对显著不同？差异方向是什么？
   - 为什么 Tukey HSD 比简单的"多次 t 检验"更好？
   - Bonferroni 校正的优缺点是什么？

**评分标准**：
- Tukey HSD 执行正确（10 分）
- 结果解释准确（8 分）
- 理解多重比较校正的必要性（7 分）

---

### 任务 4：卡方检验与分类变量关联（20 分）

**目标**：判断两个分类变量是否相关，并明确"相关 ≠ 因果"

**数据**：使用以下代码生成列联表（或使用 `examples/04_chisquare_test.py` 中生成的数据）

```python
import numpy as np
import pandas as pd

# 创建列联表（模拟数据）
np.random.seed(42)
cities = ['北京', '上海', '广州', '深圳', '杭州']
user_levels = ['普通', '银卡', '金卡', '钻石']

contingency_table = pd.DataFrame(
    np.array([
        [45, 30, 18, 7],   # 北京
        [38, 32, 22, 8],   # 上海
        [52, 28, 15, 5],   # 广州
        [35, 35, 20, 10],  # 深圳
        [40, 30, 20, 10]   # 杭州
    ]),
    index=cities,
    columns=user_levels
)
```

**步骤**：

1. **执行卡方独立性检验**：
   - 使用 `scipy.stats.chi2_contingency`
   - 记录：χ² 统计量、p 值、自由度、期望频数

2. **计算并解释效应量（Cramér's V）**：
   - 使用公式：V = √(χ² / (n * min(k-1, r-1)))
   - 解释关联强度（很弱/较弱/中等/较强）

3. **写一份卡方检验报告** `chisquare_report.md`，包含：
   - 假设陈述（H0/H1）
   - 观测频数表与期望频数表
   - 检验结果（χ²、p、V）
   - 解读（是否相关？关联强度如何？）
   - **重要**：明确说明"相关 ≠ 因果"，列出可能的因果方向和混杂变量

**评分标准**：
- 卡方检验执行正确（8 分）
- Cramér's V 计算和解释正确（6 分）
- 明确相关 ≠ 因果（6 分）

---

## 进阶作业（选做）

### 任务 5：方差不齐时的替代方法（25 分）

**目标**：当 ANOVA 的方差齐性假设不满足时，使用稳健替代方法

**场景**：

你发现数据严重违反方差齐性假设（Levene 检验 p < 0.001），此时标准 ANOVA 的结果不可靠。

**步骤**：

1. **使用 Welch ANOVA**：
   - 查阅 `statsmodels` 或 `scipy` 文档
   - 执行 Welch ANOVA（不假设方差齐性）

2. **使用 Games-Howell 事后检验**：
   - 查阅相关文档
   - 执行 Games-Howell 检验（适用于方差不齐的配对比较）

3. **对比标准 ANOVA 和 Welch ANOVA 的结果**：
   - F 统计量是否不同？
   - p 值是否不同？
   - 结论是否一致？

4. **写一份对比报告** `welch_anova_report.md`，包含：
   - 两种方法的 ANOVA 表对比
   - 方差齐性违反时为什么不能用标准 ANOVA
   - Welch ANOVA 的原理简介

**评分标准**：
- Welch ANOVA 执行正确（10 分）
- 结果对比清晰（8 分）
- 理解前提假设的重要性（7 分）

---

### 任务 6：FDR 控制方法（25 分）

**目标**：理解 FDR（假发现率）控制，并在大规模检验中应用

**场景**：

你需要同时检验 50 个假设（例如 50 种基因表达是否与某种疾病相关）。Bonferroni 校正过于保守（α' = 0.05/50 = 0.001），你会漏掉很多真实差异。

**步骤**：

1. **理解 FDR 的原理**：
   - FDR 与 FWER 的区别是什么？
   - Benjamini-Hochberg 方法的核心思想是什么？

2. **模拟 50 次检验**：
   - 生成模拟数据（50 个检验，其中 10 个真实差异，40 个无差异）
   - 不校正：报告所有 p < 0.05 的检验
   - Bonferroni 校正：报告所有 p < 0.001 的检验
   - FDR 控制：使用 Benjamini-Hochberg 方法

3. **对比三种方法的结果**：
   - 假阳性率（FP / 所有真实无差异的检验）
   - 假阴性率（FN / 所有真实有差异的检验）
   - 发现数量（每种方法发现了多少真实差异）

4. **写一份 FDR 报告** `fdr_report.md`，包含：
   - 三种方法的发现数量对比
   - FDR 方法为什么在大规模检验中更有优势？
   - 什么时候应该用 Bonferroni，什么时候用 FDR？

**评分标准**：
- FDR 理解正确（10 分）
- 模拟和对比清晰（8 分）
- 方法选择有理由（7 分）

---

## 挑战作业（可选）

### 任务 7：设计你自己的多组比较研究（30 分）

**目标**：从零开始设计一个多组比较研究

**要求**：

1. **研究设计**：
   - 提出一个你关心的实际问题（例如：不同专业学生的收入差异、不同餐厅的评分差异、不同营销策略的效果差异）
   - 定义原假设和备择假设（H0: μ₁ = μ₂ = ... = μₖ）
   - 说明如何分组（实验设计）
   - 定义成功指标

2. **数据生成**（如果无法收集真实数据，可以模拟）：
   - 说明你预期的效应量（小/中/大）
   - 根据预期效应生成模拟数据（至少 4 组）
   - 确保样本量足够（每组至少 30 个观测）

3. **完整分析**：
   - 前提假设检查（正态性、方差齐性、独立性）
   - ANOVA（或 Welch ANOVA）
   - 事后检验（Tukey HSD 或 Games-Howell）
   - 效应量（η² 或 Cramér's V）
   - 可视化（箱线图、均值误差条）

4. **报告撰写**：
   - 写一份完整的分析报告（可参考 `starter_code/solution.py` 中的格式）
   - 包含：背景、方法、结果、讨论、局限性
   - 明确"相关 ≠ 因果"

5. **代码提交**：
   - 提交可运行的 Jupyter Notebook 或 Python 脚本
   - 代码有清晰注释
   - 使用固定随机种子确保可复现

**评分标准**：
- 研究设计合理性（8 分）
- 分析完整性（10 分）
- 报告质量（8 分）
- 代码可读性和可复现性（4 分）

---

## AI 协作练习（可选）

### 任务 8：审查 AI 生成的多组比较报告（20 分）

**背景**：根据 `CLAUDE.md` 的 AI 融合渐进路径，Week 07 属于**"识别期"**（Week 05-08）——你需要学会审视 AI 辅助统计分析的结论。

**步骤**：

1. **获取 AI 生成的报告**：

   使用你喜欢的 AI 工具（如 ChatGPT、Claude 等），输入类似以下提示词：

   ```
   我有 5 个城市的用户消费数据：
   - 北京：n=100, mean=280, sd=48
   - 上海：n=100, mean=310, sd=52
   - 广州：n=100, mean=270, sd=49
   - 深圳：n=100, mean=320, sd=51
   - 杭州：n=100, mean=290, sd=50

   请帮我进行多组比较分析，判断哪些城市之间有显著差异。
   ```

2. **保存 AI 原始输出**，将其保存为 `ai_original_report.txt`

3. **使用审查清单**：

   - 使用 `examples/05_ai_anova_review.py` 中的审查函数（或手动对照清单检查）

   **审查清单**：
   - [ ] ANOVA 是否正确解释？（是否说"至少有一对不同"而非"某两组不同"）
   - [ ] 事后检验是否校正多重比较？（是否用 Tukey HSD 或 Bonferroni）
   - [ ] 是否报告了效应量（η²）？
   - [ ] 是否检查了前提假设？（正态性、方差齐性、独立性）
   - [ ] 相关 vs 因果是否混淆？（是否用"导致"、"影响"等词）
   - [ ] 是否有 p-hacking 迹迹？（如"尝试了多种分组方式"）
   - [ ] 卡方检验（如果有）是否报告了 Cramér's V？

4. **写一份审查报告** `ai_review_report.md`，包含：
   - AI 原始报告（摘要）
   - 发现的问题列表（按严重性分类：高/中/低）
   - 你的修订版结论
   - 给 AI 的改进建议（如果让它重新生成，你会怎么提示）

5. **反思**（100 字）：
   - 你认为 AI 在多组比较任务上表现如何？
   - 哪些地方人类必须介入？

**评分标准**：
- 审查全面性（10 分）
- 问题分类合理（5 分）
- 修订版结论准确（5 分）

---

## StatLab 集成

**要求**：本周所有基础作业的产出应整合到你的 StatLab 报告中

**具体操作**：

1. 在你的 `report.md` 中添加"多组比较结果"章节
2. 使用 `examples/99_statlab.py` 作为参考或直接调用
3. 包含以下内容：
   - 你选择的 2 个多组比较假设的 H0/H1
   - ANOVA 结果（F、p、η²）
   - 事后检验结果（Tukey HSD）
   - 前提假设检查结论
   - 卡方检验结果（如适用）
   - 可视化（如果有）

---

## 提交方式

1. 将所有文件放入 `chapters/week_07/assignment/` 目录
2. 文件命名规范：
   - `fwerr_calculation.md`
   - `anova_report.md`
   - `posthoc_report.md`
   - `chisquare_report.md`
   - `welch_anova_report.md`（进阶）
   - `fdr_report.md`（进阶）
   - `my_multigroup_study.md`（挑战）
   - `ai_original_report.txt`（AI 协作）
   - `ai_review_report.md`（AI 协作）
3. 确保所有 Markdown 文档使用清晰的章节结构

---

## 作业提示

1. **不要只报告 p 值**：始终同时报告效应量（η² 或 Cramér's V）
2. **解释要业务导向**：不要只说"显著"，要解释"这对业务意味着什么"
3. **注意前提假设**：ANOVA 要求数据近似正态、方差齐性、样本独立
4. **区分统计显著和实际显著**：大样本下微小差异也可能 p < 0.05，但效应量小
5. **ANOVA ≠ 多次 t 检验**：ANOVA 是"一次检验所有组"，不是"多次 t 检验的替代品"
6. **事后检验必须校正**：用 Tukey HSD 或 Bonferroni，不要直接报告未校正的 p 值
7. **相关 ≠ 因果**：观察性研究无法确定因果方向，用"相关"、"关联"而非"导致"、"影响"
8. **AI 是工具，你是决策者**：AI 可以快速计算，但解释和决策必须由你来做

### 两种 ANOVA 方法的区别

在任务 2 中，你可以使用以下两种方法之一：

| 方法 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **scipy.stats.f_oneway** | 代码简洁，快速得到 F 和 p 值 | 不生成完整 ANOVA 表 | 快速检验，只需要 F 和 p 值 |
| **statsmodels OLS + anova_lm** | 生成完整 ANOVA 表（SS、df、MS、F、p） | 代码稍复杂，需要写公式 | 需要完整 ANOVA 表和效应量计算 |

**推荐**：作业中使用 `statsmodels` 方法，因为它会生成完整的 ANOVA 表，方便你计算 η² 效应量。

---

## 参考资源

- 如果你遇到困难，可以参考 `starter_code/solution.py` 中的参考实现
- 本周示例代码在 `examples/` 目录：
  - `01_f_distribution.py`：F 分布模拟
  - `02_anova_example.py`：完整 ANOVA 流程
  - `03_posthoc_tukey.py`：Tukey HSD 事后检验
  - `04_chisquare_test.py`：卡方检验
  - `05_ai_anova_review.py`：AI 报告审查工具
  - `99_statlab.py`：StatLab 报告生成
