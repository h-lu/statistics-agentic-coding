# Week 06 作业：我们真的发现了差异吗？

**本周作业目标**：掌握假设检验的完整框架，从"会跑检验"到"会审查检验"，学会识别 AI 生成的统计结论中的常见错误。

**数据集**：使用 `starter_code/week_06_data.csv`（A/B 测试数据，包含 `channel`、`converted`、`revenue`、`user_type` 等字段）

---

## 基础题（必做）

### 1. p 值解释练习（30 分）

**任务**：纠正常见的 p 值误解，用你自己的话解释 p 值的真正含义。

**场景**：你运行了一个 A/B 测试，比较 A 渠道和 B 渠道的转化率。结果如下：

- A 渠道转化率：12%（144/1200）
- B 渠道转化率：9%（108/1200）
- 差异：3%
- p 值：0.023

**要求**：
1. 用**一句话**定义 p 值（不要用公式，用人话）
2. 指出以下说法中哪些是**错误**的，并说明为什么：
   - "p = 0.023 说明 A 渠道比 B 渠道好的概率是 97.7%"
   - "p = 0.023 说明如果重复实验 100 次，约 97 次会得到相同结果"
   - "p = 0.023 说明原假设成立的概率只有 2.3%"
   - "p = 0.023 说明在原假设成立时，观察到这么极端数据的概率约 2.3%"
3. 解释：为什么 p < 0.05 不等于"结论成立"？

**输出示例**：
```markdown
## 1. p 值解释

### p 值的定义
p 值回答的是：**如果真实没有差异，观察到当前差异（或更极端）的概率有多大？**

具体来说：p = 0.023 意味着——假设 A、B 渠道真实转化率相同，我观察到 3%（或更大）差异的概率约 2.3%。

### 常见误解辨析
[你的分析...]
```

**常见错误**：
- 把 p 值理解为"结论成立的概率"
- 把 p 值理解为"原假设成立的概率"
- 认为 p < 0.05 就等于"科学证明"

---

### 2. 执行 t 检验（35 分）

**任务**：用 Python 执行 t 检验，理解原假设和备择假设的设定。

**数据字段说明**：
- `channel`：渠道（A 或 B）
- `converted`：是否转化（0/1）
- `revenue`：消费金额（美元）
- `user_type`：用户类型（new/old）

**要求**：
1. 比较 A 渠道和 B 渠道的**平均消费金额**（`revenue`）
2. 写出原假设和备择假设
3. 执行 t 检验（选择合适的检验类型）
4. 报告：t 统计量、p 值、95% 置信区间
5. 写出结论（用你自己的话，不要只说"显著/不显著"）

**输出示例**：
```markdown
## 2. t 检验：消费金额比较

### 假设设定
- 原假设（H0）：A 渠道和 B 渠道的平均消费金额相同
- 备择假设（H1）：A 渠道和 B 渠道的平均消费金额不同

### 描述统计
| 渠道 | 样本量 | 均值 | 标准差 |
|------|--------|------|--------|
| A    | 1200   | $125.30 | $45.20 |
| B    | 1200   | $118.50 | $42.80 |

### 检验结果
- 检验方法：Welch's t 检验（方差不齐）
- t 统计量：2.84
- p 值：0.0045
- 95% 置信区间：[$2.30, $11.30]

### 结论
p = 0.0045 < 0.05，拒绝原假设。有证据表明 A 渠道的平均消费金额显著高于 B 渠道。差异约为 $6.80，95% 置信区间为 [$2.30, $11.30]。
```

**常见错误**：
- 没有写明原假设和备择假设
- 没有检查方差齐性就直接用标准 t 检验
- 只报告 p 值，没有报告置信区间
- 结论过度解读（如"证明 A 更好"）

---

### 3. 计算效应量（25 分）

**任务**：区分"统计显著"和"实际意义"，计算并解释效应量。

**要求**：
1. 使用上一题的消费金额数据，计算 Cohen's d
2. 解释这个效应量的实际含义（用业务语言）
3. 回答：如果一个差异"统计显著"但效应量"很小"，你会如何向业务团队解释？

**输出示例**：
```markdown
## 3. 效应量分析

### Cohen's d 计算
- Cohen's d = 0.16
- 解释：小效应（差异约 0.16 个标准差）

### 业务含义
A 渠道的平均消费比 B 渠道高 $6.80，但这个差异相对于消费金额的波动（标准差约 $44）来说较小。从统计角度看，差异不太可能是随机波动；但从业务角度看，$6.80 的差异对单个用户的影响有限。

### 向业务团队的解释
"我们发现了 A 渠道和 B 渠道在消费金额上的统计显著差异（p < 0.01），但效应量较小（Cohen's d = 0.16）。这意味着：差异确实存在，但不是'巨大的'。是否调整预算取决于其他因素：A 渠道的成本、用户获取难度、长期价值等。"
```

**常见错误**：
- 只报告 Cohen's d 的数值，没有解释实际含义
- 认为"显著"就等于"重要"
- 没有考虑业务场景

---

## 进阶题（选做）

### 4. 假设检查实践（20 分）

**任务**：检查 t 检验的前提假设，根据假设选择合适的检验方法。

**要求**：
1. 检查 A 渠道和 B 渠道消费金额的**正态性**（Q-Q 图 + Shapiro-Wilk 检验）
2. 检查**方差齐性**（Levene 检验）
3. 根据检查结果，选择：
   - 如果假设满足 → 用标准 t 检验
   - 如果方差不齐 → 用 Welch's t 检验
   - 如果非正态 → 用 Mann-Whitney U 检验
4. 写出一份"检验选择说明"，解释你为什么选择这个方法

**输出示例**：
```markdown
## 4. 假设检查与检验选择

### 正态性检查
- A 渠道：Shapiro-Wilk p = 0.032 < 0.05，拒绝正态假设
- B 渠道：Shapiro-Wilk p = 0.028 < 0.05，拒绝正态假设
- Q-Q 图显示：右偏分布（符合消费金额的典型特征）

### 方差齐性检查
- Levene 检验 p = 0.152 > 0.05，无法拒绝方差齐性假设

### 检验选择
由于数据**非正态**，选择 **Mann-Whitney U 检验**（非参数检验）

### 检验结果
- U 统计量：321450
- p 值：0.0067
- 结论：拒绝原假设，两组分布存在显著差异

### 说明
虽然数据非正态，但由于样本量较大（n = 1200），t 检验也比较稳健。两种检验的结论一致（p < 0.01），说明结果可靠。
```

**常见错误**：
- 只用一种检验，没有检查假设
- 样本量很大时，Shapiro-Wilk 会过于敏感（轻微偏离正态也会 p < 0.05）
- 没有根据假设检查结果选择检验方法

---

### 5. 非参数检验应用（10 分）

**任务**：当数据不满足 t 检验假设时，使用非参数检验。

**数据**：比较新用户（`user_type = new`）和老用户（`user_type = old`）的**访问次数**（如果数据中有此字段，否则用 `revenue`）

**要求**：
1. 画出两组数据的箱线图，观察分布
2. 如果数据明显偏态，使用 Mann-Whitney U 检验
3. 比较参数检验（t 检验）和非参数检验的结果
4. 回答：什么时候应该用非参数检验？

**输出示例**：
```markdown
## 5. 非参数检验

### 分布观察
箱线图显示：老用户的访问次数明显右偏（有少数高频用户）

### 检验结果对比
| 检验方法 | 统计量 | p 值 | 结论 |
|---------|--------|------|------|
| t 检验 | 2.45 | 0.014 | 显著 |
| Mann-Whitney U | 289340 | 0.022 | 显著 |

### 结论
两种检验结论一致（p < 0.05），但非参数检验更保守（p 值更大）。由于数据明显偏态， Mann-Whitney U 检验更合适。

### 什么时候用非参数检验？
- 数据明显偏离正态（如收入、访问次数等右偏数据）
- 样本量较小（n < 30）且无法假设正态
- 数据是序数（如评分 1-5）
```

---

## 挑战题（加分）

### 6. 完整检验报告撰写（25 分）

**任务**：写一份完整的假设检验报告，包含所有必要信息。

**场景**：你的团队运行了一个 A/B 测试，比较两个版本的落地页。你需要给产品经理写一份报告，帮助他做决策。

**数据**：`starter_code/week_06_challenge.csv`（包含 `version`、`converted`、`time_on_page`、`click_count` 等字段）

**要求**：
1. 选择 2-3 个关键指标进行检验
2. 每个检验包含：
   - 假设设定（H0/H1）
   - 描述统计
   - 前提假设检查
   - 检验结果（p 值、效应量、置信区间）
   - 结论和局限
3. 最后给出一个**综合建议**（不要只说"显著/不显著"）
4. 报告要写得让**非统计背景**的人能看懂

**输出示例**：
```markdown
## 落地页 A/B 测试报告

### 测试概述
- 测试时间：2026-01-01 至 2026-01-15
- 样本量：版本 A（2500 用户），版本 B（2500 用户）
- 目标：判断新落地页是否提升转化率

---

### 指标 1：转化率

**假设**：
- H0：两个版本的转化率相同
- H1：两个版本的转化率不同

**描述统计**：
| 版本 | 转化率 | 转化人数 | 总人数 |
|------|--------|---------|--------|
| A    | 8.5%   | 212     | 2500   |
| B    | 10.2%  | 255     | 2500   |

**检验方法**：比例检验（z-test）
- z 统计量：2.18
- p 值：0.029
- 95% CI：[0.2%, 3.2%]
- 效应量（Cohen's h）：0.06（小效应）

**结论**：
版本 B 的转化率显著高于版本 A（p = 0.029），差异为 1.7 个百分点。但效应量较小，商业价值需要结合成本评估。

---

### 指标 2：页面停留时间
[类似结构...]

---

### 综合建议

基于以上分析，我建议：

1. **主要发现**：版本 B 在转化率上显著优于版本 A（提升 1.7%），但停留时间无显著差异。

2. **商业评估**：
   - 如果日均访问 10000 次，版本 B 可多转化 170 次/天
   - 假设每次转化价值 $10，日增收 $1700
   - 需要评估版本 B 的实施成本是否低于这个收益

3. **建议行动**：
   - 短期：将 70% 流量切换到版本 B，保留 30% 给版本 A（风险分散）
   - 长期：持续监控 2-4 周，确认效果稳定

4. **局限**：
   - 测试期较短（2 周），可能未考虑长期用户行为
   - 未按用户细分（新/老、来源渠道）分析，可能有异质性效应
   - 只检验了 2 个指标，其他指标（如跳出率）未评估

---

**报告人**：[你的名字]
**日期**：2026-02-15
```

**评分点**：
- 报告结构完整（5 分）
- 检验方法正确（5 分）
- 效应量和置信区间都报告了（5 分）
- 结论严谨，讨论了局限（5 分）
- 语言清晰，非专家能看懂（5 分）

---

### 7. 审查 AI 生成的结论（15 分）

**任务**：审查一段 AI 生成的统计结论，指出问题并改进。

> **AI 生成的报告**
>
> 我们分析了 A/B 测试数据，结果如下：
>
> - A 版本转化率：8.5%（212/2500）
> - B 版本转化率：10.2%（255/2500）
> - p 值：0.029 < 0.05
>
> **结论**：B 版本显著优于 A 版本（p < 0.05），建议全面切换到 B 版本。
>
> **其他发现**：
> - B 版本的停留时间均值（45 秒）高于 A 版本（42 秒），差异显著（p = 0.032）
> - B 版本的点击次数均值（3.2 次）高于 A 版本（3.1 次），但差异不显著（p = 0.12）
> - 综上，B 版本在多个指标上表现更好，建议立即上线。

**审查清单**：
- [ ] **前提假设检查了吗？** AI 有没有说明检验方法的选择依据？
- [ ] **效应量报告了吗？** AI 有没有告诉你"差异有多大"？
- [ ] **置信区间给出了吗？** 单点估计不如区间估计可靠
- [ ] **多重比较问题考虑了吗？** AI 检验了 3 个指标，是否需要校正？
- [ ] **结论是否过度解读？** "立即上线"、"显著优于"是否过于绝对？

**提交内容**：
1. 指出至少 3 个 AI 结论中的问题
2. 给出改进后的结论（用你自己的话）
3. 说明：如果让你向业务团队汇报，你会怎么说？

**输出示例**：
```markdown
## AI 结论审查

### 问题 1：没有报告效应量
**AI 原文**："p 值：0.029 < 0.05，B 版本显著优于 A 版本"
**问题**：p 值只告诉你"不太可能是运气"，没告诉你"差异有多大"
**改进**："B 版本转化率比 A 版本高 1.7 个百分点（p = 0.029），但效应量较小（Cohen's h = 0.06）。从统计角度看差异显著，但商业价值需要结合用户量和成本评估。"

### 问题 2：没有检查前提假设
**AI 原文**：没有说明检验方法的选择依据
**问题**：转化率是二元数据，应该用比例检验（z-test），而不是 t 检验
**改进**：说明检验方法，并检查独立性假设（用户是否随机分配）

### 问题 3：多重比较问题
**AI 原文**：检验了 3 个指标，但只报告了 p 值，没有校正
**问题**：检验 3 个假设，假阳性风险增加
**改进**：说明是否做了多重比较校正，或者预先确定"主要终点"（如转化率）

### 问题 4：结论过于绝对
**AI 原文**："建议立即上线"
**问题**：忽视了实施风险、长期效果、成本等因素
**改进**："B 版本有潜力，建议先部分流量试点，持续监控 2-4 周后再决定"

### 向业务团队的汇报
"B 版本的转化率比 A 版本高 1.7%，这个差异统计显著（p = 0.03），意味着不太可能是随机波动。如果日均访问 10000 次，预计每天多转化 170 次。但需要注意：1）测试期只有 2 周，长期效果待验证；2）B 版本的停留时间和点击次数提升不明显；3）实施成本需要评估。建议先切换 70% 流量到 B 版本，持续监控。"
```

**评分点**：
- 识别了至少 3 个问题（6 分）
- 改进合理（5 分）
- 向业务团队的汇报清晰（4 分）

---

## AI 协作练习（可选）

> **注意**：Week 06 处于"识别期"，本练习是可选的。重点是**学会审查 AI 的统计推断结论**。

### 任务：让 AI 生成一份检验报告，你来审查

1. 将 `week_06_data.csv` 的描述发给 AI："这是一个 A/B 测试数据，帮我做假设检验，比较 A 渠道和 B 渠道"

2. 观察生成的结论，用以下清单审查：

**审查清单**：
- [ ] AI 说明了原假设和备择假设吗？
- [ ] AI 选择了正确的检验方法吗？（如：转化率应该用比例检验，不是 t 检验）
- [ ] AI 检查了前提假设吗？（正态性、方差齐性、独立性）
- [ ] AI 报告了效应量吗？
- [ ] AI 给出了置信区间吗？
- [ ] AI 的结论是否过度解读？
- [ ] AI 有没有把"相关"说成"因果"？

3. 写一份简短的审查报告（300-500 字），说明：
   - AI 做对了什么？
   - AI 漏掉了什么？
   - 你学到了什么？

**提交内容**：
- 你的审查报告
- 改进后的结论（如果需要）

---

## 提交要求

### 文件结构
```
week_06_assignment/
├── analysis.py          # 你的分析代码
├── output/              # 生成的图表
│   ├── qq_plot.png
│   ├── boxplot.png
│   └── ...
├── report.md            # 你的分析报告
└── ai_review.md         # AI 审查报告（如果做了）
```

### 报告格式（report.md）
```markdown
# Week 06 作业报告

## 1. p 值解释
[你的解释]

## 2. t 检验
[你的分析 + 结果 + 结论]

## 3. 效应量
[你的计算 + 解释]

## 4-5. 进阶题（如果完成）
[你的分析]

## 6-7. 挑战题（如果完成）
[你的完整报告]

## AI 协作练习（如果完成）
[你的审查报告]
```

### 评分标准
- **基础题**（90 分）：代码可运行 + 报告完整
- **进阶题**（30 分）：每题按评分点给分
- **挑战题**（40 分）：按评分点给分
- **AI 练习**（10 分）：按审查质量给分

**总分上限**：170 分

---

## 提示

1. **代码结构**：为每个题目写一个函数，便于测试
2. **随机种子**：如果涉及模拟，设置 `np.random.seed(42)`
3. **图表规范**：每个图表都要有标题、轴标签
4. **报告写作**：
   - 用数字说话，每个结论都要有数据支撑
   - 区分"统计结论"和"业务建议"
   - 说明前提、局限、不确定性
5. **概念理解**：本周重点是"会审查检验"，不是"会跑检验"

---

## 参考资源

- 如果你遇到困难，可以参考 `starter_code/solution.py` 中的示例代码（**不要直接复制**）
- SciPy 统计检验文档：https://docs.scipy.org/doc/scipy/reference/stats.html
- Statsmodels 统计检验：https://www.statsmodels.org/stable/stats.html

---

**最后提醒**：本周进入"识别期"，重点是**学会审查 AI 的统计推断结论**。AI 可以帮你跑检验，但判断必须由你来做。p 值、效应量、前提假设——这些是 AI 容易忽略、但必须由人来审查的关键点。
