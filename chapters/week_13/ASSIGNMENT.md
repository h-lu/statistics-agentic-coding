# Week 13 作业：从相关到因果

> "模型告诉你'使用优惠券的客户流失率更低'，但它不会告诉你'发放优惠券会降低流失率吗'——这是因果推断要回答的问题。"
> — 改编自 Judea Pearl

## 作业概述

本周作业将带你完成一个完整的**因果推断分析流程**：从因果推断三层级的理解，到画因果图明确假设，再到识别混杂和碰撞变量，最后估计因果效应并区分"相关性发现"和"因果性结论"。

你将使用**电商客户流失数据**，回答核心问题：**"发放优惠券真的能降低流失率吗？还是只是混杂导致的假象？"**

---

## 基础层（必做）

### 任务 1：因果推断三层级——你的模型能回答什么？

小北本周遇到了一个真实的业务问题：公司考虑"向近期未购买的客户发放优惠券"，希望降低流失率。

他跑了一个回归模型，发现 `coupon` 的系数是 -0.45，p < 0.001。于是兴奋地告诉业务方："发放优惠券能显著降低流失率！"

老潘看了一眼输出，只问了一个问题："**你是怎么知道这是因果效应，而不是混杂？**"

**你的任务**：
1. 回答以下三个问题，区分"关联"、"干预"、"反事实"：
   - "使用优惠券的客户流失率更低" —— 这是哪一层？
   - "发放优惠券会降低流失率吗？" —— 这是哪一层？
   - "如果当时没给这个客户发优惠券，他会流失吗？" —— 这是哪一层？
2. 解释：为什么小北的回归模型只能回答第 1 个问题，不能回答第 2 个问题？
3. 举一个"相关不等于因果"的例子（可以用你熟悉的领域）

**输入示例**（仅供参考格式）：
```
因果推断三层级：

第 1 层 - 关联 (Association)：
问题：使用优惠券的客户流失率更低吗？
回答方式：P(churn|coupon) vs P(churn|no coupon)
你的模型能回答：✅ 能（回归、相关系数）

第 2 层 - 干预 (Intervention)：
问题：发放优惠券会降低流失率吗？
回答方式：P(churn|do(coupon)) vs P(churn|do(no coupon))
你的模型能回答：⚠️ 不能直接回答（需要因果识别策略：RCT 或观察研究方法如 PSM/DID/IV）

第 3 层 - 反事实 (Counterfactual)：
问题：如果当时没给这个客户发优惠券，他会流失吗？
回答方式：P(churn_coupon=0 | coupon=1, churn=0)
你的模型能回答：❌ 不能（需要更强的假设）
```

**分析要点**：
- 小北的模型给出的是 P(churn|coupon) —— 这是"看到使用优惠券时的流失概率"
- 但业务方想要的是 P(churn|do(coupon)) —— 这是"主动发放优惠券后的流失概率"
- 两者的区别：前者可能有混杂（高价值客户更容易收到优惠券），后者需要因果识别

**提交物**：
- 一段文字（300-500 字）回答上述问题
- 用自己的话解释三层级的区别

**评分点**：
- [ ] 正确区分了三层级（关联、干预、反事实）
- [ ] 解释了为什么回归模型不能回答因果问题
- [ ] 给出了一个"相关不等于因果"的例子
- [ ] 用自己的话，不是复制粘贴

**常见错误**：
- 认为控制了变量就等于因果效应
- 混淆 P(y|x) 和 P(y|do(x))
- 没有理解"混杂"的概念

---

### 任务 2：画因果图——明确你的假设

阿码问："**那我不跑模型，先画图？图能告诉我因果吗？**"

老潘说："**图不能告诉你因果，但图能帮你把假设写下来**。数据不会告诉你因果方向，但你的图会。"

**你的任务**：
1. 为"优惠券对流失率的影响"问题画因果图（DAG）
2. 标注出：
   - 混杂变量（需要控制的）
   - 碰撞变量（不要控制的）
   - 中介变量（取决于你想回答的问题）
3. 写一段文字解释你的因果假设：为什么这样画箭头？

**输入示例**（仅供参考格式）：
```python
import matplotlib.pyplot as plt
import networkx as nx
from pathlib import Path

# 创建因果图（DAG）
G = nx.DiGraph()

# 添加边（箭头表示因果方向）
edges = [
    ('high_value_customer', 'coupon'),      # 高价值客户 → 收到优惠券
    ('high_value_customer', 'churn'),       # 高价值客户 → 低流失率
    ('coupon', 'purchase_count'),           # 优惠券 → 购买次数增加
    ('purchase_count', 'churn'),            # 购买次数 → 流失率降低
    ('vip_status', 'churn'),                # VIP身份 → 流失率
    ('days_since_last_purchase', 'churn'),  # 最近购买天数 → 流失率
]

G.add_edges_from(edges)

# 绘制
plt.figure(figsize=(10, 6))
pos = nx.spring_layout(G, seed=42)
nx.draw(G, pos, with_labels=True, node_size=3000,
        node_color='lightblue', arrowsize=20, font_size=10,
        bbox=dict(facecolor='white', edgecolor='black', boxstyle='round,pad=0.5'))

plt.title('因果图：优惠券对流失率的影响', fontsize=14)
plt.tight_layout()
Path('output').mkdir(exist_ok=True)
plt.savefig('output/causal_dag.png', dpi=150, bbox_inches='tight')
```

**因果假设说明示例**（仅供参考格式）：
```
我的因果假设：

1. 混杂变量：high_value_customer（高价值客户）
   - 原因：高价值客户更容易收到优惠券，同时也更不容易流失
   - 如果不控制，会虚假放大"优惠券降低流失率"的效果

2. 中介变量：purchase_count（购买次数）
   - 原因：优惠券可能通过"增加购买次数"来降低流失率
   - 如果我想知道"总效应"，不应该控制中介
   - 如果我想知道"直接效应"（不通过购买次数），应该控制中介

3. 碰撞变量（不要控制）：customer_satisfaction（客户满意度）
   - 原因：优惠券和流失率都会影响客户满意度
   - 如果控制满意度，会引入虚假相关

局限：
- high_value_customer 可能不可观测（怎么定义"高价值"？）
- 可能存在未观测混杂（如"购买意愿"）
```

**提交物**：
- 因果图（PNG 或 PDF）
- 一段文字解释你的因果假设

**评分点**：
- [ ] 因果图结构正确（有向无环图）
- [ ] 正确识别了混杂变量
- [ ] 正确识别了碰撞变量（如果提到）
- [ ] 解释了因果假设和局限性

**常见错误**：
- 箭头方向错误（如从结果指向原因）
- 没有标注混杂变量
- 认为因果图可以从数据中"发现"（不，它是假设）

---

### 任务 3：识别因果路径——用 d-分离和后门准则

老潘在白板上画了一个图：

```
    high_value_customer
         ↓        ↓
      coupon  churn
         ↓        ↑
    purchase_count ←
         ↓        ↑
         vip_status
```

"**怎么知道该控制什么？用 d-分离**。"

**你的任务**：
1. 找出 `coupon` 到 `churn` 的所有因果路径
2. 找出所有"后门路径"（需要阻断的混杂路径）
3. 应用后门准则：需要控制哪些变量才能识别因果效应？
4. 解释：为什么不能控制"客户满意度"（假设它是碰撞变量）？

**输入示例**（仅供参考格式）：
```
步骤 1：找因果路径（前门路径）
- 路径 1：coupon → purchase_count → churn（中介路径）
- 路径 2：coupon → churn（直接路径，如果存在）

步骤 2：找后门路径（混杂路径）
- 路径 1：coupon ← high_value_customer → churn（混杂！）
- 路径 2：coupon ← high_value_customer → purchase_count → churn（如果控制 high_value_customer，也会被阻断）

步骤 3：应用后门准则
- 需要控制：high_value_customer
- 问题：high_value_customer 可能不可观测

步骤 4：找代理变量
- 如果 high_value_customer 不可观测，可以用 purchase_count、vip_status 作为代理
- 但代理不完美——如果代理不能完全捕捉 high_value_customer，仍有剩余混杂

步骤 5：不要控制碰撞变量
- customer_satisfaction（客户满意度）是碰撞变量
- 原因：coupon → satisfaction ← churn
- 如果控制 satisfaction，coupon 和 churn 会产生虚假相关
```

**提交物**：
- 一段文字（400-600 字）解释你的分析
- 用你自己的因果图进行分析

**评分点**：
- [ ] 正确识别了前门路径（因果路径）
- [ ] 正确识别了后门路径（混杂路径）
- [ ] 正确应用了后门准则
- [ ] 解释了为什么不能控制碰撞变量

**常见错误**：
- 混淆前门路径和后门路径
- 认为"控制越多越好"
- 没有理解碰撞变量的危害

---

### 任务 4：区分"相关性发现"和"因果性结论"

小北最后问："**那我跑的回归模型一点用都没有吗？**"

老潘说："**有用，但你必须清楚区分：这是相关，不是因果**。"

**你的任务**：
1. 用回归模型分析"优惠券和流失率的关系"
2. 写一段"相关性发现"（3-4 句话）
3. 写一段"因果性结论"（如果可用，注明假设和局限性）
4. 填写表格："你能回答什么，不能回答什么"

**输入示例**（仅供参考格式）：
```python
import pandas as pd
import statsmodels.formula.api as smf

# 加载数据
df = pd.read_csv("data/customer_churn.csv")

# 相关性分析（不是因果！）
model = smf.logit("churn ~ coupon + purchase_count + vip_status + days_since_last_purchase", data=df).fit()
print(model.summary())

# 计算相关系数
correlation = df[['coupon', 'churn']].corr().iloc[0, 1]
print(f"优惠券和流失率的相关系数: {correlation:.3f}")
```

**输出示例**（仅供参考格式）：
```
相关性发现（观察数据）：
- 优惠券和流失率的相关系数: -0.245（负相关）
- 回归系数: -0.45, p < 0.001（在控制其他变量后）
- 结论：使用优惠券的客户流失率更低（这是关联，不是因果）

因果性结论（需谨慎）：
- 方法：观察研究 + 协变量调整
- 估计效应：发放优惠券可能降低流失率 X%
- 局限性：
  1. 只能控制观测变量，未观测混杂（如"购买意愿"）仍存在
  2. 优惠券可能不是随机发放的（高价值客户更容易收到）
  3. 最优方法：随机对照试验（RCT/A/B 测试）

我们能回答什么，不能回答什么：
| 问题 | 能回答吗？ | 原因 |
|------|-----------|------|
| 使用优惠券的客户流失率更低吗？ | ✅ 能 | 观察数据可以回答 |
| 发放优惠券会降低流失率吗？ | ⚠️ 部分能 | 需要更强的因果识别策略（如 RCT） |
| 如果不发放优惠券，流失率会怎样？ | ❌ 不能 | 需要反事实推断（更高层级） |
```

**提交物**：
- 代码
- 相关性发现（3-4 句话）
- 因果性结论（如果可用，注明假设和局限性）
- "能回答什么，不能回答什么"表格

**评分点**：
- [ ] 正确运行了回归模型
- [ ] 正确区分了"相关性发现"和"因果性结论"
- [ ] 注明了假设和局限性
- [ ] 填写了"能回答什么，不能回答什么"表格

**常见错误**：
- 把回归系数直接当成因果效应
- 没有注明局限性
- 认为控制了变量就等于因果

---

## 进阶层（推荐完成）

### 任务 5：用 DoWhy 进行因果效应估计

老潘说："**有个叫 DoWhy 的库，可以帮你系统地做因果推断**。它不会替你画因果图，但会帮你识别因果路径、估计效应、做敏感性分析。"

**你的任务**：
1. 安装 DoWhy：`pip install dowhy`
2. 用 DoWhy 重新分析"优惠券对流失率的影响"
3. 生成因果报告：
   - 因果识别（Identify）
   - 因果效应估计（Estimate）
   - 敏感性分析（Refute）

**输入示例**：
```python
import pandas as pd
import dowhy
from dowhy import CausalModel

# 加载数据
df = pd.read_csv("data/customer_churn.csv")

# 定义因果模型
causal_graph = """
digraph {
    high_value_customer -> coupon;
    high_value_customer -> churn;
    coupon -> purchase_count;
    purchase_count -> churn;
    vip_status -> churn;
    days_since_last_purchase -> churn;
}
"""

# 创建因果模型
model = CausalModel(
    data=df,
    treatment='coupon',
    outcome='churn',
    graph=causal_graph.replace('\n', ' ')
)

# 第 1 步：识别（Identify）
identified_estimand = model.identify_effect()
print("识别结果:", identified_estimand)

# 第 2 步：估计（Estimate）
estimate = model.estimate_effect(
    identified_estimand,
    method_name="backdoor.propensity_score_matching"
)
print("因果效应估计:", estimate.value)

# 第 3 步：敏感性分析（Refute）
refute1 = model.refute_estimate(
    identified_estimand, estimate,
    method_name="placebo_treatment_refuter"
)
print("安慰剂检验:", refute1)

refute2 = model.refute_estimate(
    identified_estimand, estimate,
    method_name="random_common_cause"
)
print("随机共同原因检验:", refute2)
```

**提交物**：
- 代码
- 因果效应估计结果
- 敏感性分析结果
- 一段文字解释结果（3-4 句话）

**评分点**：
- [ ] 正确使用了 DoWhy 库
- [ ] 定义了因果图（DAG）
- [ ] 进行了因果识别和估计
- [ ] 进行了敏感性分析
- [ ] 解释了结果和局限性

**加分项**：
- 尝试了不同的估计方法（如 backdoor.linear_regression, iv.instrumental_variable）
- 进行了多种敏感性分析（placebo_treatment_refuter, random_common_cause, data_subset_refuter）

---

### 任务 6：设计一个 RCT/A/B 测试

老潘说："**如果你真的想回答因果问题，最优解是做实验**。"

**你的任务**：
1. 为"优惠券对流失率的影响"设计一个 A/B 测试
2. 写出：
   - 实验设计（如何随机化？）
   - 样本量计算（需要多少客户？）
   - 评估指标（主要指标和次要指标）
   - 分析计划（如何分析结果？）
3. 讨论伦理问题：有没有可能因为这个实验伤害客户？

**输入示例**（仅供参考格式）：
```
实验设计：

1. 随机化方案：
   - 随机分配客户到两组：
     - 实验组（50%）：收到 20 元优惠券
     - 对照组（50%）：不收到优惠券
   - 随机化单位：客户 ID
   - 随机化方法：简单随机化

2. 样本量计算：
   - 假设：基线流失率 15%，期望降低到 12%（相对降低 20%）
   - 显著性水平：α = 0.05
   - 统计功效：1 - β = 0.8
   - 需要样本量：每组约 2000 人（共 4000 人）

3. 评估指标：
   - 主要指标：30 天流失率
   - 次要指标：购买次数、消费金额、客户满意度

4. 分析计划：
   - 检查随机化是否成功（比较两组的基线特征）
   - 计算平均处理效应（ATE）：实验组流失率 - 对照组流失率
   - 使用 t 检验或卡方检验
   - 计算 95% 置信区间

5. 伦理考虑：
   - 潜在伤害：对照组客户可能因为没收到优惠券而不满
   - 缓解措施：实验结束后给对照组补发优惠券
   - 知情同意：在用户协议中说明可能参与实验
```

**提交物**：
- 完整的 A/B 测试设计（500-800 字）
- 样本量计算（如果有代码，附上）

**评分点**：
- [ ] 随机化方案清晰
- [ ] 样本量计算有依据
- [ ] 评估指标合理
- [ ] 分析计划完整
- [ ] 讨论了伦理问题

---

## 挑战层（可选）

### 任务 7：开放性问题——因果推断在 AI 时代的重要性

老潘在公司最近招了一个"因果推断科学家"，阿码很奇怪："**不是有 AI 了吗？为什么还需要因果推断？**"

**你的任务**：

写一篇短文（800-1000 字），回答以下问题：

1. **AI 能发现因果吗？**
   - AI（如大型语言模型）擅长什么？
   - AI 不擅长什么？
   - 举一个例子：AI 可能得出什么错误的因果结论？

2. **因果推断在 AI 时代为什么重要？**
   - 在推荐系统中，"相关性推荐"和"因果性推荐"有什么区别？
   - 在医学/公共政策中，为什么不能只看 AI 的"预测"？

3. **你会如何向业务方解释"为什么不能直接用 AI 的结论"？**
   - 用一个具体场景（如优惠券、医疗决策、教育干预）
   - 用业务语言，不是技术术语

**提交物**：
- 短文（800-1000 字）
- 用你自己的话，不是复制粘贴

**评分点**：
- [ ] 正确理解了 AI 的能力边界
- [ ] 用具体例子说明了"相关不等于因果"
- [ ] 用业务语言向非技术读者解释
- [ ] 有自己的思考，不是泛泛而谈

---

## AI 协作练习（可选，主导期）

下面这段文字是某个 AI 工具生成的"因果推断结论"：

> "我们使用因果推断分析了优惠券对流失率的影响。结果显示，发放优惠券能显著降低流失率（效应值 = -0.32, p < 0.001）。我们还进行了敏感性分析，结果显示结论稳健。因此，建议公司向所有客户发放优惠券。"

**审查清单**：
- [ ] 它画因果图了吗？假设是什么？
- [ ] 它用了什么方法（RCT？DID？PSM？）？
- [ ] 它说明了混杂变量吗？控制了什么？
- [ ] 它区分了"相关性发现"和"因果性结论"吗？
- [ ] 它注明了局限性吗？
- [ ] "向所有客户发放优惠券"——这个建议合理吗？有没有成本考虑？

**你的修订版**（用你自己的话写，修正上述问题）：

```
例如："AI 的结论有几个问题：第一，没有说明因果假设（因果图）。第二，没有说明用了什么方法（RCT？观察研究？）。第三，'向所有客户发放优惠券'没有考虑成本——如果每个客户都发，成本可能大于收益。修订版应该明确：因果假设是什么、用了什么方法、效应大小是多少、局限性有哪些、成本收益如何。"
```

**提交物**：
- 审查清单（勾选哪些问题存在）
- 你的修订版（3-5 句话）

---

## StatLab 本周任务

老潘说："**StatLab 报告需要升级——从'相关性报告'到'因果性报告'**。"

**你的任务**：

1. **画因果图**：
   - 为你的研究问题画因果图
   - 标注混杂变量、碰撞变量、中介变量

2. **区分"相关性发现"和"因果性结论"**：
   - 在报告中明确：哪些是相关性发现
   - 哪些是因果性结论（如果有的话，注明假设）

3. **识别混杂因素**：
   - 列出至少 2 个混杂因素
   - 说明你是否控制了它们，怎么控制的

4. **说明"你能回答什么，不能回答什么"**：
   - 填写表格：哪些问题你能回答，哪些不能

**StatLab 模板**（仅供参考格式）：
```markdown
## 因果推断分析

### 因果图（假设）

![因果图](output/causal_dag.png)

**假设说明**：
- 箭头表示我们认为的因果关系
- 混杂变量：[列出混杂变量]
- 局限性：[可能的未观测混杂]

### 相关性发现（观察数据）

- [列出相关性发现]

### 因果性结论（需谨慎）

- [如果有因果性结论，注明方法和局限性]
- [如果没有，说明为什么]

### 我们能回答什么，不能回答什么

| 问题 | 能回答吗？ | 原因 |
|------|-----------|------|
| [问题 1] | ✅/❌ | [原因] |
| [问题 2] | ✅/❌ | [原因] |

### 建议的因果识别策略

- [建议的 RCT 或准实验设计]
```

**提交物**：
- 更新后的 StatLab 报告
- 因果图（PNG 或 PDF）

---

## 提交检查清单

在提交作业前，请确认：

- [ ] 代码可以运行（或注明哪些部分是伪代码）
- [ ] 输出结果包含在提交中（或截图）
- [ ] 分析部分用你自己的话写（不是复制粘贴）
- [ ] 区分了"相关性发现"和"因果性结论"
- [ ] 因果图有明确的假设说明
- [ ] 如果遇到困难，参考了 `starter_code/solution.py`，请说明参考了哪些部分

---

## 提示与帮助

如果你在完成作业时遇到困难：
1. 回顾 CHAPTER.md 中的示例代码
2. 参考本周的 StatLab 示例（`examples/13_causal_diagram.py`）
3. 查阅 DoWhy 官方文档：https://py-why.github.io/dowhy/
4. 如果你遇到困难，可以参考 `starter_code/solution.py`（但不要直接复制）

**记住**：作业的目的是巩固理解，不是完美复制代码。即使遇到困难，也要尝试用自己的话解释问题和思路。

---

祝你本周学习愉快！记住老潘的话：**"数据不会告诉你因果，因果假设必须由你来做。画因果图不是'可选的附加功能'，而是'因果推断的前提'。"**
