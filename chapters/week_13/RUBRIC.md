# Week 13 评分标准（Rubric）

## 评分维度与权重

| 维度 | 权重 | 说明 |
|------|------|------|
| 因果三层级识别 | 15% | 能正确区分关联/干预/反事实，识别"相关≠因果"的错误 |
| 因果图（DAG）绘制 | 25% | 能用 DAG 表达因果假设，识别混杂/中介/对撞 |
| 后门准则应用 | 20% | 能根据因果图科学选择调整集，避免盲目调整 |
| 倾向评分匹配实现 | 25% | 能正确估计因果效应，检查匹配质量 |
| AI 因果结论审查 | 15% | 能识别 AI 生成的因果结论中的错误 |

---

## 详细评分标准

### 1. 因果三层级识别（15 分）

| 评分项 | 分值 | 优秀（A） | 良好（B） | 合格（C） | 不合格（F） |
|--------|------|-----------|-----------|-----------|-------------|
| 层级判断正确 | 10 | 所有问题层级判断正确 | 8-9 个正确 | 6-7 个正确 | < 6 个正确 |
| 方法选择合理 | 5 | 方法与层级完全匹配 | 方法基本正确 | 方法部分正确 | 方法错误 |
| 反思深入 | 0 | 深入分析关联与因果的区别，举出真实场景 | 有基本分析 | 分析较浅 | 无反思或分析错误 |

**验证方式**：
- 检查 `causal_levels.md` 中的层级判断
- 验证方法选择与问题层级的匹配性
- 检查反思是否举出具体场景

---

### 2. 因果图（DAG）绘制（25 分）

| 评分项 | 分值 | 优秀（A） | 良好（B） | 合格（C） | 不合格（F） |
|--------|------|-----------|-----------|-----------|-------------|
| 因果图正确性 | 10 | 节点和边完全正确，箭头方向正确 | 基本正确，1-2 处小错误 | 部分正确，3-5 处错误 | 图结构错误 |
| 三种结构识别 | 10 | 完全识别链式/叉式/对撞，解释准确 | 识别基本正确 | 识别部分正确 | 识别错误或缺失 |
| 问题回答准确性 | 5 | 所有问题回答准确，理解深入 | 回答基本正确 | 回答部分正确 | 回答错误 |

**验证方式**：
- 检查 `causal_dag.png` 的图结构
- 检查 `dag_analysis.md` 中的结构识别
- 验证混杂/中介/对撞的判断

**关键检查点**：
- 混杂变量：必须同时影响 X 和 Y
- 中介变量：X → M → Y 的链式结构
- 对撞变量：X → Z ← Y 的结构（如果存在）

---

### 3. 后门准则应用（20 分）

| 评分项 | 分值 | 优秀（A） | 良好（B） | 合格（C） | 不合格（F） |
|--------|------|-----------|-----------|-----------|-------------|
| 路径识别正确 | 8 | 因果路径和后门路径识别完全正确 | 基本正确，1 处遗漏 | 部分正确 | 识别错误 |
| 后门准则应用 | 7 | 三个条件完整应用，调整集选择正确 | 应用基本正确 | 应用部分正确 | 应用错误 |
| 对比分析清晰 | 5 | 三种调整策略对比清晰，理解有偏来源 | 对比基本清晰 | 对比部分完成 | 对比缺失或错误 |

**验证方式**：
- 检查 `backdoor_analysis.md` 中的路径识别
- 验证调整集是否符合后门准则
- 检查对比表中的有偏/无偏判断

**关键检查点**：
- 未调整：有偏（混杂未控制）
- 错误调整：有偏（中介被切断或对撞被打开）
- 正确调整：无偏（后门路径被阻断，因果路径保留）

---

### 4. 倾向评分匹配实现（25 分）

| 评分项 | 分值 | 优秀（A） | 良好（B） | 合格（C） | 不合格（F） |
|--------|------|-----------|-----------|-----------|-------------|
| 倾向评分估计正确 | 5 | Logistic 回归正确，倾向评分合理 | 估计基本正确 | 估计有瑕疵 | 估计错误 |
| 匹配实现正确 | 8 | 匹配逻辑正确，代码可运行 | 匹配基本正确 | 匹配部分正确 | 匹配错误 |
| 匹配质量检查完整 | 8 | 包含可视化（匹配前后）和 SMD 计算 | 有基本质量检查 | 检查不完整 | 无质量检查 |
| 效应估计和解释合理 | 4 | ATT 估计正确，置信区间完整，解释深入 | 估计基本正确 | 估计有瑕疵 | 估计错误或解释错误 |

**验证方式**：
- 检查代码实现（倾向评分 + 匹配）
- 检查 `matching_report.md` 中的质量检查
- 验证 ATT 计算和置信区间

**关键检查点**：
- 匹配前 SMD > 0.1（不平衡）
- 匹配后 SMD < 0.1（平衡良好）
- ATT = mean(Y_treated - Y_matched_control)
- 置信区间用 Bootstrap 或正态近似

---

### 5. AI 因果结论审查（15 分）

| 评分项 | 分值 | 优秀（A） | 良好（B） | 合格（C） | 不合格（F） |
|--------|------|-----------|-----------|-----------|-------------|
| 审查全面性 | 10 | 识别出所有主要问题，分类准确（高/中/低） | 识别出大部分问题 | 识别出部分问题 | 仅识别少量问题或遗漏严重问题 |
| 问题分类合理 | 5 | 高/中/低分类准确，优先级清晰 | 分类基本合理 | 分类部分合理 | 分类错误 |
| 修订版结论准确 | 0 | 修订结论统计上正确，区分相关与因果 | 修订结论基本正确 | 修订结论有瑕疵 | 修订结论不准确 |

**验证方式**：
- 检查 `ai_causal_review.md` 中的问题列表
- 验证问题分类的合理性
- 检查修订版结论是否正确区分相关与因果

**常见 AI 错误（应识别）**：
- **高危**：混淆相关与因果、未调整混杂、夸大结论
- **中危**：未报告不确定性、未说明识别策略
- **低危**：术语不严谨、缺少可视化

---

## 进阶作业评分标准（参考）

### DoWhy 真实数据分析（30 分）

| 评分项 | 分值 | 优秀（A） | 良好（B） | 合格（C） | 不合格（F） |
|--------|------|-----------|-----------|-----------|-------------|
| 模型定义正确 | 8 | 因果图 GML 格式正确，模型初始化正确 | 定义基本正确 | 定义有瑕疵 | 定义错误 |
| 识别和估计正确 | 10 | 识别策略正确，两种方法对比完整 | 估计基本正确 | 估计部分正确 | 估计错误 |
| 敏感性分析完整 | 8 | 至少 2 个 refutation test，解读准确 | 有基本敏感性分析 | 分析不完整 | 无敏感性分析 |
| 报告清晰 | 4 | 结构清晰，结论明确 | 报告基本清晰 | 报告部分清晰 | 报告混乱 |

### 匹配质量深入检查（20 分）

| 评分项 | 分值 | 优秀（A） | 良好（B） | 合格（C） | 不合格（F） |
|--------|------|-----------|-----------|-----------|-------------|
| 多种匹配方法对比 | 5 | 至少 3 种方法，对比表完整 | 2-3 种方法，对比基本完整 | 1-2 种方法 | 无对比 |
| 平衡检查完整 | 8 | SMD 计算正确，Love Plot 清晰 | 有基本平衡检查 | 检查不完整 | 无平衡检查 |
| 共同支撑域分析 | 4 | 可视化清晰，匹配率计算正确 | 有基本分析 | 分析部分完成 | 无分析 |
| 分层分析 | 3 | 分层正确，ATT/ATE 对比合理 | 分层基本正确 | 分层有瑕疵 | 无分层分析 |

---

## 挑战作业评分标准（参考）

### 设计因果推断实验（35 分）

| 评分项 | 分值 | 优秀（A） | 良好（B） | 合格（C） | 不合格（F） |
|--------|------|-----------|-----------|-----------|-------------|
| 研究设计合理性 | 10 | 因果图清晰，问题层级正确，混杂识别准确 | 设计基本合理 | 设计部分合理 | 设计不合理 |
| 分析完整性 | 15 | 识别策略正确，两种方法估计，敏感性分析完整 | 分析基本完整 | 分析部分完整 | 分析不完整 |
| 报告质量 | 7 | 结构完整，结论明确，边界说明清晰 | 报告基本清晰 | 报告部分清晰 | 报告混乱 |
| 代码可复现性 | 3 | 代码可运行，注释清晰，随机种子固定 | 代码基本可运行 | 代码部分可运行 | 代码不可运行 |

---

## 加分/扣分项

### 加分项

| 项目 | 加分 | 说明 |
|------|------|------|
| StatLab 集成 | +5% | 将因果推断结果正确整合到 StatLab 报告中 |
| 代码质量优秀 | +3% | 代码注释清晰、结构良好、可复现、有测试 |
| 超额完成挑战作业 | +5% | 完成挑战作业且质量优秀（A 级） |
| 敏感性分析深入 | +3% | 超出要求完成额外的敏感性分析（如 E-value） |
| 可视化优秀 | +2% | 因果图、匹配质量图、平衡检查图清晰美观 |

### 扣分项

| 项目 | 扣分 | 说明 |
|------|------|------|
| 混淆相关与因果 | -10% | 多处或关键位置把相关当成因果 |
| 未画因果图 | -10% | 没有因果图，假设不显式 |
| 未检查匹配质量 | -10% | 倾向评分匹配后未检查 SMD 或平衡性 |
| 盲目调整一切变量 | -8% | 调整了中介或对撞变量，导致有偏估计 |
| 夸大因果结论 | -8% | 未说明限制和假设，夸大因果效应的普适性 |
| 未报告置信区间 | -5% | 只报告点估计，未报告不确定性 |
| 代码不可复现 | -5% | 代码无法运行或未固定随机种子 |

---

## 成绩等级标准

| 等级 | 总分范围 | 对应 GPA | 说明 |
|------|----------|----------|------|
| A | 90-100 | 4.0 | 优秀：完全掌握因果推断核心概念和实践 |
| B | 80-89 | 3.0-3.7 | 良好：基本掌握，部分细节需改进 |
| C | 70-79 | 2.0-2.7 | 合格：掌握主要内容，有明显提升空间 |
| F | 0-69 | 0.0-1.7 | 不合格：未达到基本要求 |

---

## 提交检查清单

### 必做任务检查

- [ ] `causal_levels.md`：因果三层级识别完成，表格完整
- [ ] `causal_dag.png`：因果图可视化清晰
- [ ] `dag_analysis.md`：三种结构识别正确，问题回答准确
- [ ] `backdoor_analysis.md`：后门准则应用正确，对比表清晰
- [ ] `matching_report.md`：倾向评分匹配实现完整，质量检查到位
- [ ] StatLab 报告已更新，包含因果推断章节

### 进阶任务检查（如完成）

- [ ] `dowhy_analysis.md`：DoWhy 分析完整，敏感性分析到位
- [ ] `matching_quality_report.md`：多种匹配方法对比，Love Plot 清晰

### 挑战任务检查（如完成）

- [ ] `causal_experiment_design.md`：研究设计完整，报告清晰
- [ ] `causal_analysis.py`：代码可运行，可复现

### AI 协作练习检查（如完成）

- [ ] `ai_original_causal.txt`：AI 原始输出已保存
- [ ] `ai_causal_review.md`：审查报告完整，问题分类准确

### 代码质量检查

- [ ] 所有 Python 脚本可运行（无语法错误）
- [ ] 随机种子已固定（确保可复现）
- [ ] 代码有清晰注释（说明关键步骤）
- [ ] 可视化图片清晰可读（DPI ≥ 150）

### 报告质量检查

- [ ] 所有 Markdown 文档格式规范
- [ ] 章节结构清晰（有标题、有层次）
- [ ] 数值结果有解释（不只是罗列数字）
- [ ] 区分了"因果结论"和"相关发现"
- [ ] 说明了结论边界（能回答什么、不能回答什么）

---

## 验收锚点（Anchors）

### 锚点 1：因果三层级（基础）

**预期输出**：
- 学生能正确区分 6 个问题的层级（关联/干预/反事实）
- 能为每个层级选择正确的统计方法
- 能举出"把相关当成因果"的真实场景

**验证方式**：
```python
# 自动检查示例（伪代码）
def check_causal_levels(submission):
    correct_answers = {
        'A': 'association',
        'B': 'intervention',
        'C': 'counterfactual',
        'D': 'association',
        'E': 'intervention',
        'F': 'counterfactual'
    }
    # 检查答案匹配度
    matches = sum(1 for q, ans in submission.items() if ans == correct_answers[q])
    return matches >= 5  # 至少 5 个正确
```

### 锚点 2：因果图正确性（基础）

**预期输出**：
- DAG 节点和边正确
- 混杂变量：Activity, History_Spend（同时影响 Coupon 和 Spending）
- 中介变量：Frequency（Coupon → Frequency → Spending）
- 后门路径：Coupon ← Activity → Spending, Coupon ← History_Spend → Spending

**验证方式**：
```python
# 自动检查示例（伪代码）
def check_dag_structure(submission_dag):
    # 检查是否有正确的边
    required_edges = [
        ('Activity', 'Coupon'),
        ('Activity', 'Spending'),
        ('History_Spend', 'Coupon'),
        ('History_Spend', 'Spending'),
        ('Coupon', 'Spending'),
        ('Coupon', 'Frequency'),
        ('Frequency', 'Spending')
    ]
    # 检查图结构匹配度
    matches = sum(1 for e in required_edges if e in submission_dag.edges())
    return matches >= 6  # 至少 6 条边正确
```

### 锚点 3：后门准则应用（基础）

**预期输出**：
- 正确识别后门路径
- 调整集：{Activity, History_Spend}
- 不调整：Frequency（中介）
- 理解：未调整有偏，错误调整有偏，正确调整无偏

**验证方式**：
```python
# 自动检查示例（伪代码）
def check_backdoor_application(submission):
    # 检查调整集是否正确
    correct_adjustment_set = {'Activity', 'History_Spend'}
    # 检查是否包含中介或对撞
    incorrect_adjustment = {'Frequency'}
    # 验证
    return correct_adjustment_set.issubset(submission.adjustment_set) and \
           incorrect_adjustment.isdisjoint(submission.adjustment_set)
```

### 锚点 4：倾向评分匹配实现（基础）

**预期输出**：
- ATT 估计值：约 28-30 元（95% CI [20, 38]）
- 匹配前 SMD > 0.5（不平衡）
- 匹配后 SMD < 0.1（平衡）
- 有可视化图（匹配前后倾向评分分布）

**验证方式**：
```python
# 自动检查示例（伪代码）
def check_psm_quality(submission):
    # 检查 ATT 是否在合理范围
    att_valid = 20 <= submission.att <= 40
    # 检查匹配后 SMD 是否 < 0.1
    smd_valid = all(smd < 0.1 for smd in submission.smd_after.values())
    # 检查是否有置信区间
    has_ci = submission.ci_low is not None and submission.ci_high is not None
    return att_valid and smd_valid and has_ci
```

### 锚点 5：AI 结论审查（AI 协作）

**预期输出**：
- 识别出 AI 的混淆相关与因果错误
- 识别出未调整混杂的问题
- 修订版结论正确区分关联和因果
- 明确说明因果效应估计和置信区间

**验证方式**：
```python
# 人工检查为主
def check_ai_review(submission):
    # 检查是否识别出"混淆相关与因果"
    has_correlation_causation_confusion = \
        '混淆相关与因果' in submission.issues or \
        'correlation' in submission.issues
    # 检查修订版是否区分关联和因果
    has_distinction = \
        '关联' in submission.revision and \
        '因果' in submission.revision
    # 检查是否有置信区间
    has_ci = '置信区间' in submission.revision or 'CI' in submission.revision
    return has_correlation_causation_confusion and has_distinction and has_ci
```

---

## 教师评分指南

### 快速评分流程（10 分钟/份）

1. **检查完整性**（1 分钟）：
   - 所有必做任务是否提交？
   - 文件命名是否符合规范？

2. **因果图检查**（2 分钟）：
   - 查看 `causal_dag.png`
   - 快速验证：混杂、中介识别是否正确？

3. **后门准则检查**（2 分钟）：
   - 查看 `backdoor_analysis.md`
   - 调整集是否正确？
   - 对比表是否清晰？

4. **匹配质量检查**（3 分钟）：
   - 查看 `matching_report.md`
   - ATT 估计值是否合理？
   - SMD 是否 < 0.1？
   - 可视化图是否清晰？

5. **AI 审查检查**（2 分钟）：
   - 查看 `ai_causal_review.md`（如有）
   - 问题识别是否准确？
   - 修订版是否正确？

### 详细评分流程（20 分钟/份）

在快速评分基础上，详细阅读每一份报告，检查：
- 解释是否深入（不只是数字）
- 局限性是否说明
- 因果结论是否夸大
- 代码是否可复现

### 批量反馈模板

```markdown
## 作业反馈

### 做得好的地方
- 因果图清晰，混杂识别准确
- 后门准则应用正确
- 匹配质量检查完整

### 需要改进的地方
- [具体问题]

### 建议
- [改进建议]

### 得分：XX/100
```

---

## 常见问题与解答

### Q1：因果图可以用手绘吗？

**答**：可以。手绘后扫描或拍照，确保清晰可读。但推荐使用 networkx，因为：
- 代码可复现
- 容易修改
- 可以用 DoWhy 验证

### Q2：倾向评分匹配的 ATT 是什么？

**答**：ATT = Average Treatment Effect on the Treated（处理组平均处理效应）。它是"对被处理的人的平均效应"，区别于：
- ATE：全人群的平均处理效应
- ATC：对照组的平均处理效应

倾向评分匹配通常估计的是 ATT，因为你只在处理组中找匹配。

### Q3：如果匹配后 SMD 仍然 > 0.1 怎么办？

**答**：可能的解决方案：
- 增加匹配数量（1:5 而不是 1:1）
- 使用更小的卡尺（caliper）
- 使用精确匹配（exact matching）
- 如果仍不平衡，可能是数据质量问题或重叠性不足，需在报告中说明限制。

### Q4：DoWhy 安装失败怎么办？

**答**：DoWhy 依赖较多，推荐在虚拟环境中安装：
```bash
pip install dowhy
pip install econml
pip install sklearn
```
如果仍有问题，可以用 statsmodels 完成基础作业。

### Q5：AI 练习必须用某个特定的 AI 工具吗？

**答**：不限制。ChatGPT、Claude、文心一言等都可以。关键是：
- 保存 AI 的原始输出
- 用学过的知识审查它
- 写出你的修订版和反思
