"""
ç¤ºä¾‹ï¼šå› æœå›¾ï¼ˆDAGï¼‰â€”â€”è®©å‡è®¾å¯è§†åŒ–

æœ¬ä¾‹æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ NetworkX ç”»å› æœå›¾ï¼ˆDAGï¼‰ï¼Œå¹¶å±•ç¤ºä¸‰ç§åŸºæœ¬ç»“æ„ï¼š
1. é“¾å¼ï¼ˆChainï¼‰ï¼šå› æœè·¯å¾„ï¼ˆå¦‚ X â†’ Y â†’ Zï¼‰
2. å‰å¼ï¼ˆForkï¼‰ï¼šæ··æ‚å˜é‡ï¼ˆå¦‚ Z â†’ X, Z â†’ Yï¼‰
3. å¯¹æ’ï¼ˆColliderï¼‰ï¼šé€‰æ‹©åå·®ï¼ˆå¦‚ X â†’ Z â† Yï¼‰

è¿è¡Œæ–¹å¼ï¼špython3 chapters/week_13/examples/02_causal_dag.py
é¢„æœŸè¾“å‡ºï¼š
- stdout è¾“å‡ºä¸‰ç§ç»“æ„çš„è§£é‡Š
- ä¿å­˜ä¸‰å¼ å› æœå›¾ï¼ˆchain.png, fork.png, collider.pngï¼‰
- ä¿å­˜å®Œæ•´æ¡ˆä¾‹å›¾ï¼ˆcoupon_dag.pngï¼‰
"""
from __future__ import annotations

import matplotlib.pyplot as plt
import networkx as nx
from pathlib import Path


# è®¾ç½®ä¸­æ–‡å­—ä½“
plt.rcParams['font.sans-serif'] = ['Arial Unicode MS', 'SimHei', 'DejaVu Sans']
plt.rcParams['axes.unicode_minus'] = False


def plot_dag(G, title, output_path, pos=None):
    """
    ç”»å› æœå›¾

    å‚æ•°:
        G: NetworkX DiGraph å¯¹è±¡
        title: å›¾æ ‡é¢˜
        output_path: è¾“å‡ºè·¯å¾„
        pos: èŠ‚ç‚¹ä½ç½®ï¼ˆå¯é€‰ï¼Œå¦‚æœä¸æä¾›åˆ™è‡ªåŠ¨å¸ƒå±€ï¼‰
    """
    plt.figure(figsize=(10, 6))

    if pos is None:
        pos = nx.spring_layout(G, seed=42)

    # ç”»èŠ‚ç‚¹
    nx.draw_networkx_nodes(G, pos, node_color='lightblue',
                          node_size=3000, alpha=0.9)

    # ç”»è¾¹
    nx.draw_networkx_edges(G, pos, edge_color='gray',
                          arrowsize=20, width=2, alpha=0.7,
                          arrowstyle='->', arrows=True)

    # ç”»æ ‡ç­¾
    nx.draw_networkx_labels(G, pos, font_size=12,
                            font_family='sans-serif')

    plt.title(title, fontsize=14, fontweight='bold')
    plt.axis('off')
    plt.tight_layout()
    plt.savefig(output_path, dpi=150, bbox_inches='tight')
    plt.close()

    print(f"  âœ… å›¾å·²ä¿å­˜: {output_path}")


def demonstrate_chain_structure():
    """
    æ¼”ç¤ºé“¾å¼ç»“æ„ï¼ˆChainï¼‰
    X â†’ Y â†’ Z

    ç¤ºä¾‹ï¼šæ•™è‚² â†’ æ”¶å…¥ â†’ å¥åº·æ°´å¹³
    """
    print("\n" + "=" * 70)
    print("ğŸ“— ç»“æ„ 1ï¼šé“¾å¼ï¼ˆChainï¼‰â€”â€”å› æœè·¯å¾„")
    print("=" * 70)

    print("\nç»“æ„: X â†’ Y â†’ Z")
    print("ç¤ºä¾‹: æ•™è‚² â†’ æ”¶å…¥ â†’ å¥åº·æ°´å¹³")
    print("\nè§£é‡Š:")
    print("  - æ•™è‚²å½±å“æ”¶å…¥ï¼ˆå› æœï¼‰")
    print("  - æ”¶å…¥å½±å“å¥åº·ï¼ˆå› æœï¼‰")
    print("  - å¦‚æœä½ è°ƒæ•´äº†æ”¶å…¥ï¼Œæ•™è‚²å’Œå¥åº·çš„å…³ç³»ä¼šæ¶ˆå¤±")

    print("\nâš ï¸ è¿™æ˜¯ä¸­ä»‹å˜é‡ï¼ˆMediatorï¼‰ï¼Œä¸æ˜¯æ··æ‚ï¼")
    print("   å¦‚æœä½ æƒ³ä¼°è®¡'æ•™è‚²å¯¹å¥åº·çš„æ€»æ•ˆåº”'ï¼Œ")
    print("   ä¸èƒ½è°ƒæ•´æ”¶å…¥ï¼ˆå› ä¸ºå®ƒæ˜¯ä¸­ä»‹å˜é‡ï¼‰")

    # ç”»å›¾
    G = nx.DiGraph()
    G.add_edges_from([
        ("æ•™è‚²", "æ”¶å…¥"),
        ("æ”¶å…¥", "å¥åº·æ°´å¹³")
    ])

    pos = {
        "æ•™è‚²": (0, 0),
        "æ”¶å…¥": (1, 0),
        "å¥åº·æ°´å¹³": (2, 0)
    }

    plot_dag(G, "é“¾å¼ç»“æ„ï¼šæ•™è‚² â†’ æ”¶å…¥ â†’ å¥åº·æ°´å¹³", "chain.png", pos)


def demonstrate_fork_structure():
    """
    æ¼”ç¤ºå‰å¼ç»“æ„ï¼ˆForkï¼‰
    Z â†’ X, Z â†’ Y

    ç¤ºä¾‹ï¼šå¹´é¾„ â†’ ç”¨åˆ¸ï¼ˆå¹´è½»äººæ›´çˆ±é¢†åˆ¸ï¼‰
         â†’ æ¶ˆè´¹ï¼ˆå¹´è½»äººæ¶ˆè´¹æ›´é«˜ï¼‰
    """
    print("\n" + "=" * 70)
    print("ğŸ“• ç»“æ„ 2ï¼šå‰å¼ï¼ˆForkï¼‰â€”â€”æ··æ‚å˜é‡")
    print("=" * 70)

    print("\nç»“æ„:      â†’ X")
    print("       Z <")
    print("           â†’ Y")

    print("\nç¤ºä¾‹: å¹´é¾„ â†’ ç”¨åˆ¸ï¼ˆå¹´è½»äººæ›´çˆ±é¢†åˆ¸ï¼‰")
    print("           â†’ æ¶ˆè´¹ï¼ˆå¹´è½»äººæ¶ˆè´¹æ›´é«˜ï¼‰")

    print("\nè§£é‡Š:")
    print("  - Z æ˜¯æ··æ‚å˜é‡ï¼ˆåŒæ—¶å½±å“ X å’Œ Yï¼‰")
    print("  - X å’Œ Y çš„å…³è”ä¸æ˜¯å› æœï¼Œè€Œæ˜¯ç”± Z å¼•èµ·çš„è™šå‡å…³è”")
    print("  - å¿…é¡»è°ƒæ•´ Zï¼Œæ‰èƒ½è¯†åˆ« X â†’ Y çš„å› æœæ•ˆåº”")

    print("\nâœ… è¿™å°±æ˜¯éœ€è¦è°ƒæ•´çš„æ··æ‚å˜é‡ï¼")

    # ç”»å›¾
    G = nx.DiGraph()
    G.add_edges_from([
        ("å¹´é¾„", "ä¼˜æƒ åˆ¸ä½¿ç”¨"),
        ("å¹´é¾„", "æ¶ˆè´¹é‡‘é¢")
    ])

    pos = {
        "å¹´é¾„": (0, 1),
        "ä¼˜æƒ åˆ¸ä½¿ç”¨": (1, 0),
        "æ¶ˆè´¹é‡‘é¢": (1, 2)
    }

    plot_dag(G, "å‰å¼ç»“æ„ï¼šå¹´é¾„æ˜¯æ··æ‚å˜é‡", "fork.png", pos)


def demonstrate_collider_structure():
    """
    æ¼”ç¤ºå¯¹æ’ç»“æ„ï¼ˆColliderï¼‰
    X â†’ Z â† Y

    ç¤ºä¾‹ï¼šèƒ½åŠ› â†’ å½•å– â† è¿æ°”
    """
    print("\n" + "=" * 70)
    print("ğŸ“™ ç»“æ„ 3ï¼šå¯¹æ’ï¼ˆColliderï¼‰â€”â€”é€‰æ‹©åå·®çš„æ¥æº")
    print("=" * 70)

    print("\nç»“æ„: X â†’ Z â† Y")
    print("ç¤ºä¾‹: èƒ½åŠ› â†’ å½•å– â† è¿æ°”")

    print("\nè§£é‡Š:")
    print("  - èƒ½åŠ›å’Œè¿æ°”éƒ½å½±å“å½•å–")
    print("  - å¦‚æœä½ åªçœ‹'è¢«å½•å–çš„äºº'ï¼Œä¼šå‘ç°èƒ½åŠ›å’Œè¿æ°”è´Ÿç›¸å…³")
    print("    ï¼ˆèƒ½åŠ›ä½çš„äººè¿æ°”ä¸€å®šå¥½æ‰èƒ½å½•å–ï¼‰")
    print("  - ä½†å¦‚æœä½ è°ƒæ•´äº† Zï¼ˆå½•å–ï¼‰ï¼Œä¼šåˆ¶é€ è™šå‡å…³è”")

    print("\nâš ï¸ è¿™æ˜¯é€‰æ‹©åå·®çš„æ¥æºï¼")
    print("   ä¸èƒ½è°ƒæ•´å¯¹æ’å˜é‡ï¼Œå¦åˆ™ä¼šæ‰“å¼€è™šå‡è·¯å¾„")

    # ç”»å›¾
    G = nx.DiGraph()
    G.add_edges_from([
        ("èƒ½åŠ›", "å½•å–"),
        ("è¿æ°”", "å½•å–")
    ])

    pos = {
        "èƒ½åŠ›": (0, 0),
        "å½•å–": (1, 0),
        "è¿æ°”": (2, 0)
    }

    plot_dag(G, "å¯¹æ’ç»“æ„ï¼šå½•å–æ˜¯èƒ½åŠ›çš„å¯¹æ’å˜é‡", "collider.png", pos)


def demonstrate_coupon_case_dag():
    """
    æ¼”ç¤ºå®Œæ•´çš„ä¼˜æƒ åˆ¸æ¡ˆä¾‹å› æœå›¾
    """
    print("\n" + "=" * 70)
    print("ğŸ’¼ å®Œæ•´æ¡ˆä¾‹ï¼šä¼˜æƒ åˆ¸æ•ˆæœçš„å› æœå›¾")
    print("=" * 70)

    print("\nç ”ç©¶é—®é¢˜: å¦‚æœç»™ç”¨æˆ·å‘åˆ¸ï¼Œæ¶ˆè´¹ä¼šæé«˜å¤šå°‘ï¼Ÿ")
    print("\nå› æœå‡è®¾:")

    dag_description = """
ç”¨æˆ·æ´»è·ƒåº¦ â†’ ä¼˜æƒ åˆ¸ä½¿ç”¨
    â†“           â†“
    å†å²æ¶ˆè´¹ â†’ æ¶ˆè´¹é‡‘é¢ â†â”€â”€â”€â”€â”˜
    """

    print(dag_description)

    print("\nå›¾è§£:")
    print("  - å¤„ç†å˜é‡ï¼ˆXï¼‰: ä¼˜æƒ åˆ¸ä½¿ç”¨")
    print("  - ç»“æœå˜é‡ï¼ˆYï¼‰: æ¶ˆè´¹é‡‘é¢")
    print("  - æ··æ‚å˜é‡ï¼ˆZï¼‰: ç”¨æˆ·æ´»è·ƒåº¦ã€å†å²æ¶ˆè´¹")
    print("    ï¼ˆåŒæ—¶å½±å“ç”¨åˆ¸å’Œæ¶ˆè´¹ï¼‰")

    print("\nå› æœè·¯å¾„:")
    print("  - ä¼˜æƒ åˆ¸ â†’ æ¶ˆè´¹é‡‘é¢ï¼ˆå› æœè·¯å¾„ï¼Œæˆ‘ä»¬æƒ³ä¼°è®¡çš„ï¼‰")
    print("  - ä¼˜æƒ åˆ¸ â† æ´»è·ƒåº¦ â†’ æ¶ˆè´¹é‡‘é¢ï¼ˆåé—¨è·¯å¾„ï¼Œè™šå‡å…³è”ï¼‰")
    print("  - ä¼˜æƒ åˆ¸ â† å†å²æ¶ˆè´¹ â†’ æ¶ˆè´¹é‡‘é¢ï¼ˆåé—¨è·¯å¾„ï¼Œè™šå‡å…³è”ï¼‰")

    print("\nè¯†åˆ«ç­–ç•¥:")
    print("  - å¿…é¡»è°ƒæ•´: ç”¨æˆ·æ´»è·ƒåº¦ã€å†å²æ¶ˆè´¹ï¼ˆé˜»æ–­åé—¨è·¯å¾„ï¼‰")
    print("  - ä¸èƒ½è°ƒæ•´: ä½¿ç”¨é¢‘ç‡ï¼ˆä¸­ä»‹å˜é‡ï¼Œä¼šåˆ‡æ–­å› æœè·¯å¾„ï¼‰")

    # ç”»å›¾
    G = nx.DiGraph()
    G.add_edges_from([
        ("ç”¨æˆ·æ´»è·ƒåº¦", "ä¼˜æƒ åˆ¸ä½¿ç”¨"),
        ("ç”¨æˆ·æ´»è·ƒåº¦", "æ¶ˆè´¹é‡‘é¢"),
        ("å†å²æ¶ˆè´¹", "ä¼˜æƒ åˆ¸ä½¿ç”¨"),
        ("å†å²æ¶ˆè´¹", "æ¶ˆè´¹é‡‘é¢"),
        ("ä¼˜æƒ åˆ¸ä½¿ç”¨", "æ¶ˆè´¹é‡‘é¢")
    ])

    pos = {
        "ç”¨æˆ·æ´»è·ƒåº¦": (0, 2),
        "å†å²æ¶ˆè´¹": (0, 0),
        "ä¼˜æƒ åˆ¸ä½¿ç”¨": (1, 1),
        "æ¶ˆè´¹é‡‘é¢": (2, 1)
    }

    plot_dag(G, "ä¼˜æƒ åˆ¸æ¡ˆä¾‹çš„å› æœå›¾ï¼ˆDAGï¼‰", "coupon_dag.png", pos)


def bad_example_wrong_dag():
    """
    åä¾‹ï¼šé”™è¯¯çš„å› æœå›¾è®¾è®¡
    """
    print("\n" + "=" * 70)
    print("âŒ åä¾‹ï¼šé”™è¯¯çš„å› æœå›¾è®¾è®¡")
    print("=" * 70)

    print("\né”™è¯¯ 1: æœ‰å¾ªç¯çš„å›¾ï¼ˆä¸æ˜¯ DAGï¼‰")
    print("-" * 70)
    print("  ä¼˜æƒ åˆ¸ â†’ æ¶ˆè´¹ â†’ ä¼˜æƒ åˆ¸")
    print("  é—®é¢˜: è¿™ä¸æ˜¯ DAGï¼ˆæœ‰å‘æ— ç¯å›¾ï¼‰ï¼Œè¿åå› æœçš„æ—¶é—´é¡ºåº")
    print("  æ­£ç¡®: ä¼˜æƒ åˆ¸ â†’ æ¶ˆè´¹ï¼ˆå•å‘å› æœï¼‰")

    print("\né”™è¯¯ 2: é—æ¼æ··æ‚å˜é‡")
    print("-" * 70)
    print("  ä¼˜æƒ åˆ¸ â†’ æ¶ˆè´¹")
    print("  é—®é¢˜: æ²¡æœ‰ç”»æ´»è·ƒåº¦è¿™ä¸ªæ··æ‚å˜é‡")
    print("  æ­£ç¡®: æ´»è·ƒåº¦ â†’ ä¼˜æƒ åˆ¸ï¼Œæ´»è·ƒåº¦ â†’ æ¶ˆè´¹")

    print("\né”™è¯¯ 3: è°ƒæ•´äº†ä¸è¯¥è°ƒæ•´çš„å˜é‡")
    print("-" * 70)
    print("  ä¼˜æƒ åˆ¸ â†’ ä½¿ç”¨é¢‘ç‡ â†’ æ¶ˆè´¹")
    print("  é—®é¢˜: å¦‚æœè°ƒæ•´'ä½¿ç”¨é¢‘ç‡'ï¼ˆä¸­ä»‹å˜é‡ï¼‰ï¼Œä¼šä½ä¼°ä¼˜æƒ åˆ¸æ•ˆæœ")
    print("  æ­£ç¡®: ä¸è°ƒæ•´ä¸­ä»‹å˜é‡ï¼Œåªè°ƒæ•´æ··æ‚å˜é‡")


def main():
    """ä¸»å‡½æ•°"""
    print("=" * 70)
    print("å› æœå›¾ï¼ˆDAGï¼‰å¯è§†åŒ–å·¥å…·")
    print("=" * 70)

    # åˆ›å»ºè¾“å‡ºç›®å½•
    output_dir = Path("report")
    output_dir.mkdir(exist_ok=True)

    print(f"\nğŸ“ è¾“å‡ºç›®å½•: {output_dir}/")

    # æ¼”ç¤ºä¸‰ç§åŸºæœ¬ç»“æ„
    demonstrate_chain_structure()
    demonstrate_fork_structure()
    demonstrate_collider_structure()

    # æ¼”ç¤ºå®Œæ•´æ¡ˆä¾‹
    demonstrate_coupon_case_dag()

    # åä¾‹
    bad_example_wrong_dag()

    print("\n" + "=" * 70)
    print("ğŸ’¡ å…³é”®è¦ç‚¹")
    print("=" * 70)
    print("""
1. é“¾å¼ç»“æ„ï¼ˆX â†’ Y â†’ Zï¼‰: Y æ˜¯ä¸­ä»‹å˜é‡ï¼Œè°ƒæ•´å®ƒæœƒåˆ‡æ–·å› æœè·¯å¾„
2. å‰å¼ç»“æ„ï¼ˆZ â†’ X, Z â†’ Yï¼‰: Z æ˜¯æ··æ‚å˜é‡ï¼Œå¿…é¡»è°ƒæ•´æ‰èƒ½è¯†åˆ«å› æœ
3. å¯¹æ’ç»“æ„ï¼ˆX â†’ Z â† Yï¼‰: Z æ˜¯å¯¹æ’å˜é‡ï¼Œè°ƒæ•´å®ƒæœƒæ‰“é–‹è™šå‡è·¯å¾„

è€æ½˜çš„ç»éªŒ:
- "å› æœå›¾å°±æ˜¯æ˜¾å¼çš„å‡è®¾æ–‡æ¡£"
- å¼ºåˆ¶ä½ æ˜ç¡®"è°å½±å“è°"
- æ–¹ä¾¿å›¢é˜Ÿè®¨è®ºå’Œå®¡è®¡
- å…­ä¸ªæœˆåè¿˜èƒ½è¿½æº¯"å½“æ—¶ä¸ºä»€ä¹ˆè°ƒæ•´è¿™ä¸ªå˜é‡"

ä¸‹ä¸€æ­¥: åé—¨å‡†åˆ™ï¼ˆBackdoor Criterionï¼‰
- æ ¹æ®å› æœå›¾ç§‘å­¦åœ°é€‰æ‹©è°ƒæ•´é›†
- ä¸æ˜¯"å‡­æ„Ÿè§‰"ï¼Œä¹Ÿä¸æ˜¯"è°ƒæ•´ä¸€åˆ‡"
    """)


if __name__ == "__main__":
    main()
