"""
ç¤ºä¾‹ï¼šå› æœä¸‰å±‚çº§â€”â€”ä»"ç›¸å…³"åˆ°"å¹²é¢„"åˆ°"åäº‹å®"

æœ¬ä¾‹æ¼”ç¤º Judea Pearl çš„å› æœä¸‰å±‚çº§æ¡†æ¶ï¼Œå±•ç¤ºå¦‚ä½•åŒºåˆ†ï¼š
1. å…³è”ï¼ˆAssociationï¼‰ï¼šå˜é‡ X å’Œ Y ç›¸å…³å—ï¼Ÿ
2. å¹²é¢„ï¼ˆInterventionï¼‰ï¼šå¦‚æœæˆ‘ä»¬æ”¹å˜ Xï¼ŒY ä¼šå¦‚ä½•ï¼Ÿ
3. åäº‹å®ï¼ˆCounterfactualï¼‰ï¼šå¦‚æœå½“æ—¶æ²¡åš Xï¼ŒY ä¼šæ€æ ·ï¼Ÿ

è¿è¡Œæ–¹å¼ï¼špython3 chapters/week_13/examples/01_causal_ladder.py
é¢„æœŸè¾“å‡ºï¼šstdout è¾“å‡ºä¸‰å±‚çº§çš„åŒºåˆ«å’Œç¤ºä¾‹
"""
from __future__ import annotations

import numpy as np
import pandas as pd


def demonstrate_causal_ladder():
    """
    æ¼”ç¤ºå› æœä¸‰å±‚çº§æ¡†æ¶

    ä½¿ç”¨"ä¼˜æƒ åˆ¸ä¸æ¶ˆè´¹"çš„åœºæ™¯ï¼Œå±•ç¤ºä¸‰ä¸ªå±‚çº§çš„åŒºåˆ«
    """
    print("=" * 70)
    print("å› æœä¸‰å±‚çº§æ¡†æ¶ - Judea Pearl")
    print("=" * 70)

    # åœºæ™¯è®¾å®š
    print("\nğŸ“Š åœºæ™¯ï¼šç”µå•†å¹³å°çš„ä¼˜æƒ åˆ¸æ•ˆæœåˆ†æ")
    print("-" * 70)

    # ç”Ÿæˆæ¨¡æ‹Ÿæ•°æ®
    np.random.seed(42)
    n = 1000

    # æ··æ‚å˜é‡ï¼šç”¨æˆ·æ´»è·ƒåº¦
    activity = np.random.normal(50, 15, n)  # æ´»è·ƒåº¦åˆ†æ•°

    # å¤„ç†å˜é‡ï¼šä¼˜æƒ åˆ¸ä½¿ç”¨ï¼ˆå—æ´»è·ƒåº¦å½±å“ï¼‰
    # æ´»è·ƒç”¨æˆ·æ›´æ„¿æ„é¢†åˆ¸
    coupon_prob = 0.2 + 0.006 * activity
    coupon = np.random.binomial(1, np.clip(coupon_prob, 0, 1))

    # ç»“æœå˜é‡ï¼šæ¶ˆè´¹é‡‘é¢ï¼ˆå—æ´»è·ƒåº¦å’Œä¼˜æƒ åˆ¸å½±å“ï¼‰
    # åŸºç¡€æ¶ˆè´¹ + æ´»è·ƒåº¦å½±å“ + ä¼˜æƒ åˆ¸æ•ˆæœ
    base_spending = 50
    activity_effect = 1.5 * activity
    coupon_effect = 30 * coupon  # ä¼˜æƒ åˆ¸çœŸå®æ•ˆæœï¼š30å…ƒ
    noise = np.random.normal(0, 15, n)
    spending = base_spending + activity_effect + coupon_effect + noise

    df = pd.DataFrame({
        'ç”¨æˆ·æ´»è·ƒåº¦': activity,
        'ä¼˜æƒ åˆ¸ä½¿ç”¨': coupon,
        'æ¶ˆè´¹é‡‘é¢': spending
    })

    print(f"æ•°æ®è§„æ¨¡: {n} ä¸ªç”¨æˆ·")
    print(f"ç”¨åˆ¸æ¯”ä¾‹: {coupon.mean():.1%}")
    print(f"å¹³å‡æ¶ˆè´¹: {spending.mean():.2f} å…ƒ\n")

    # ========== ç¬¬ 1 å±‚çº§ï¼šå…³è” ==========
    print("ğŸ” ç¬¬ 1 å±‚çº§ï¼šå…³è”ï¼ˆAssociationï¼‰")
    print("-" * 70)
    print("é—®é¢˜ï¼šç”¨åˆ¸ç”¨æˆ·å’Œæœªç”¨åˆ¸ç”¨æˆ·çš„æ¶ˆè´¹å·®å¼‚æ˜¯å¤šå°‘ï¼Ÿ")

    # ç®€å•æ¯”è¾ƒå‡å€¼
    treated_spending = df[df['ä¼˜æƒ åˆ¸ä½¿ç”¨'] == 1]['æ¶ˆè´¹é‡‘é¢'].mean()
    control_spending = df[df['ä¼˜æƒ åˆ¸ä½¿ç”¨'] == 0]['æ¶ˆè´¹é‡‘é¢'].mean()
    diff_association = treated_spending - control_spending

    print(f"\nç»“æœ:")
    print(f"  ç”¨åˆ¸ç”¨æˆ·å¹³å‡æ¶ˆè´¹: {treated_spending:.2f} å…ƒ")
    print(f"  æœªç”¨åˆ¸ç”¨æˆ·å¹³å‡æ¶ˆè´¹: {control_spending:.2f} å…ƒ")
    print(f"  å·®å¼‚ï¼ˆå…³è”ï¼‰: {diff_association:.2f} å…ƒ")

    print(f"\nâš ï¸ è¿™æ˜¯\"å…³è”\"ï¼Œä¸æ˜¯\"å› æœ\"ï¼")
    print(f"   å› ä¸ºæ´»è·ƒç”¨æˆ·æ—¢æ›´å¯èƒ½ç”¨åˆ¸ï¼Œä¹Ÿæ¶ˆè´¹æ›´é«˜ã€‚")

    # ========== ç¬¬ 2 å±‚çº§ï¼šå¹²é¢„ ==========
    print("\n" + "=" * 70)
    print("ğŸ”§ ç¬¬ 2 å±‚çº§ï¼šå¹²é¢„ï¼ˆInterventionï¼‰")
    print("-" * 70)
    print("é—®é¢˜ï¼šå¦‚æœæˆ‘ä»¬ç»™ç”¨æˆ·å‘åˆ¸ï¼Œä»–çš„æ¶ˆè´¹ä¼šæé«˜å¤šå°‘ï¼Ÿ")
    print("\næ–¹æ³• 1ï¼šå¸¦è°ƒæ•´é›†çš„å›å½’")
    print("  è°ƒæ•´æ··æ‚å˜é‡ï¼šç”¨æˆ·æ´»è·ƒåº¦")

    # ä½¿ç”¨å›å½’æ§åˆ¶æ··æ‚
    from sklearn.linear_model import LinearRegression

    X = df[['ä¼˜æƒ åˆ¸ä½¿ç”¨', 'ç”¨æˆ·æ´»è·ƒåº¦']]
    y = df['æ¶ˆè´¹é‡‘é¢']
    model = LinearRegression()
    model.fit(X, y)

    coupon_coef = model.coef_[0]
    print(f"\n  å›å½’ç³»æ•°ï¼ˆä¼˜æƒ åˆ¸æ•ˆæœï¼‰: {coupon_coef:.2f} å…ƒ")
    print(f"  è§£è¯»ï¼šåœ¨æ§åˆ¶æ´»è·ƒåº¦åï¼Œä¼˜æƒ åˆ¸çš„å› æœæ•ˆåº”çº¦ä¸º {coupon_coef:.2f} å…ƒ")

    print(f"\næ–¹æ³• 2ï¼šåˆ†å±‚åˆ†æ")
    print("  æŒ‰æ´»è·ƒåº¦åˆ†å±‚åæ¯”è¾ƒ")

    # å°†æ´»è·ƒåº¦åˆ†ä¸ºé«˜/ä¸­/ä½ä¸‰ç»„
    df['æ´»è·ƒåº¦åˆ†å±‚'] = pd.qcut(df['ç”¨æˆ·æ´»è·ƒåº¦'], q=3, labels=['ä½', 'ä¸­', 'é«˜'])

    layered_effects = []
    for level in ['ä½', 'ä¸­', 'é«˜']:
        subset = df[df['æ´»è·ƒåº¦åˆ†å±‚'] == level]
        treated = subset[subset['ä¼˜æƒ åˆ¸ä½¿ç”¨'] == 1]['æ¶ˆè´¹é‡‘é¢'].mean()
        control = subset[subset['ä¼˜æƒ åˆ¸ä½¿ç”¨'] == 0]['æ¶ˆè´¹é‡‘é¢'].mean()
        effect = treated - control
        layered_effects.append(effect)
        print(f"  {level}æ´»è·ƒåº¦ç»„: æ•ˆæœ = {effect:.2f} å…ƒ")

    avg_layered_effect = np.mean(layered_effects)
    print(f"\n  å¹³å‡åˆ†å±‚æ•ˆåº”: {avg_layered_effect:.2f} å…ƒ")

    print(f"\nâœ… è¿™æ˜¯\"å› æœæ•ˆåº”\"ï¼ˆå¹²é¢„æ•ˆåº”ï¼‰")
    print(f"   å…³è” vs å› æœ: {diff_association:.2f} vs {coupon_coef:.2f} å…ƒ")
    print(f"   æ··æ‚å¤¸å¤§äº†: {diff_association - coupon_coef:.2f} å…ƒ")

    # ========== ç¬¬ 3 å±‚çº§ï¼šåäº‹å® ==========
    print("\n" + "=" * 70)
    print("ğŸ¤” ç¬¬ 3 å±‚çº§ï¼šåäº‹å®ï¼ˆCounterfactualï¼‰")
    print("-" * 70)
    print("é—®é¢˜ï¼šå¦‚æœè¿™ä¸ªç”¨æˆ·æ²¡ç”¨åˆ¸ï¼Œä»–ä¼šæ¶ˆè´¹å¤šå°‘ï¼Ÿ")

    # é€‰æ‹©ä¸€ä¸ªç”¨åˆ¸ç”¨æˆ·ä½œä¸ºä¾‹å­
    treated_user = df[df['ä¼˜æƒ åˆ¸ä½¿ç”¨'] == 1].iloc[0]
    actual_spending = treated_user['æ¶ˆè´¹é‡‘é¢']
    activity_level = treated_user['ç”¨æˆ·æ´»è·ƒåº¦']

    # ä¼°è®¡åäº‹å®ç»“æœï¼ˆå¦‚æœæ²¡ç”¨åˆ¸ï¼‰
    # ä½¿ç”¨å›å½’æ¨¡å‹é¢„æµ‹
    counterfactual_input = pd.DataFrame([[0, activity_level]], columns=['ä¼˜æƒ åˆ¸ä½¿ç”¨', 'ç”¨æˆ·æ´»è·ƒåº¦'])
    counterfactual_spending = model.predict(counterfactual_input)[0]

    individual_effect = actual_spending - counterfactual_spending

    print(f"\nç¤ºä¾‹ç”¨æˆ·:")
    print(f"  æ´»è·ƒåº¦: {activity_level:.1f}")
    print(f"  ä¼˜æƒ åˆ¸: ä½¿ç”¨äº†")
    print(f"  å®é™…æ¶ˆè´¹: {actual_spending:.2f} å…ƒ")
    print(f"  åäº‹å®æ¶ˆè´¹ï¼ˆå¦‚æœæ²¡ç”¨åˆ¸ï¼‰: {counterfactual_spending:.2f} å…ƒ")
    print(f"  ä¸ªä½“å› æœæ•ˆåº”: {individual_effect:.2f} å…ƒ")

    print(f"\nâš ï¸ åäº‹å®æ— æ³•ç›´æ¥è§‚æµ‹ï¼")
    print(f"   æˆ‘ä»¬æ°¸è¿œæ— æ³•åŒæ—¶çœ‹åˆ°åŒä¸€ä¸ªä½“åœ¨ä¸¤ç§å¤„ç†ä¸‹çš„ç»“æœ")
    print(f"   è¿™ä¸ªä¼°è®¡ä¾èµ–æ¨¡å‹å‡è®¾")

    # ========== æ€»ç»“ ==========
    print("\n" + "=" * 70)
    print("ğŸ“ æ€»ç»“ï¼šå› æœä¸‰å±‚çº§çš„åŒºåˆ«")
    print("=" * 70)

    summary = f"""
| å±‚çº§ | é—®é¢˜ç±»å‹ | ç¤ºä¾‹é—®é¢˜ | èƒ½ç”¨ä»€ä¹ˆæ–¹æ³•å›ç­” |
|------|---------|---------|----------------|
| 1. å…³è” | å˜é‡ X å’Œ Y ç›¸å…³å—ï¼Ÿ | ç”¨åˆ¸ç”¨æˆ·æ¶ˆè´¹æ›´é«˜å—ï¼Ÿ | ç›¸å…³åˆ†æã€t æ£€éªŒã€å›å½’ |
| 2. å¹²é¢„ | å¦‚æœæˆ‘ä»¬æ”¹å˜ Xï¼ŒY ä¼šå¦‚ä½•ï¼Ÿ | å¦‚æœç»™ç”¨æˆ·å‘åˆ¸ï¼Œæ¶ˆè´¹ä¼šæé«˜å—ï¼Ÿ | éšæœºå¯¹ç…§è¯•éªŒã€å€¾å‘è¯„åˆ†åŒ¹é… |
| 3. åäº‹å® | å¦‚æœå½“æ—¶æ²¡åš Xï¼ŒY ä¼šæ€æ ·ï¼Ÿ | å¦‚æœå¼ ä¸‰æ²¡ç”¨åˆ¸ï¼Œä»–ä¼šæ¶ˆè´¹å¤šå°‘ï¼Ÿ | åäº‹å®æ¨ç†ã€ä¸ªä½“å› æœæ•ˆåº” |

æœ¬ä¾‹çš„ç»“æœ:
- å…³è”ï¼ˆæœªè°ƒæ•´ï¼‰: {diff_association:.2f} å…ƒ
- å› æœï¼ˆè°ƒæ•´åï¼‰: {coupon_coef:.2f} å…ƒ
- æ··æ‚åå·®: {diff_association - coupon_coef:.2f} å…ƒ

å…³é”®å¯ç¤º:
1. å°åŒ—çš„é”™è¯¯ï¼šç”¨"å…³è”æ–¹æ³•"ï¼ˆæ¯”è¾ƒå‡å€¼ï¼‰å›ç­”"å¹²é¢„é—®é¢˜"ï¼ˆä¼˜æƒ åˆ¸æœ‰æ•ˆå—ï¼‰
2. æ­£ç¡®åšæ³•ï¼šå…ˆç”»å› æœå›¾ï¼Œè¯†åˆ«æ··æ‚å˜é‡ï¼Œç”¨åé—¨å‡†åˆ™é€‰æ‹©è°ƒæ•´é›†
3. åäº‹å®æœ€éš¾ï¼šæˆ‘ä»¬æ°¸è¿œæ— æ³•è§‚æµ‹åˆ°"å¦‚æœå½“æ—¶æ²¡åš"çš„ç»“æœ
"""

    print(summary)


# ============================================================================
# åä¾‹ï¼šå¸¸è§çš„"ç›¸å…³â‰ å› æœ"é™·é˜±
# ============================================================================

def bad_example_common_pitfalls():
    """
    å±•ç¤ºä¸‰ä¸ªå¸¸è§çš„"ç›¸å…³â‰ å› æœ"é™·é˜±
    """
    print("\n" + "=" * 70)
    print("âš ï¸ å¸¸è§é™·é˜±ï¼šç›¸å…³â‰ å› æœ")
    print("=" * 70)

    pitfalls = {
        "é™·é˜± 1ï¼šåå‘å› æœ": {
            "example": "è­¦å¯Ÿå¤šçš„åœ°æ–¹ï¼ŒçŠ¯ç½ªç‡æ›´é«˜",
            "wrong": "è­¦å¯Ÿå¯¼è‡´çŠ¯ç½ª",
            "correct": "çŠ¯ç½ªå¤šçš„åœ°æ–¹æ´¾äº†æ›´å¤šè­¦å¯Ÿ",
            "causality": "çŠ¯ç½ª â†’ è­¦å¯Ÿï¼Œè€Œä¸æ˜¯è­¦å¯Ÿ â†’ çŠ¯ç½ª"
        },
        "é™·é˜± 2ï¼šæ··æ‚å˜é‡": {
            "example": "å–å’–å•¡çš„äººï¼Œè‚ºç™Œå‘ç”Ÿç‡æ›´é«˜",
            "wrong": "å’–å•¡å¯¼è‡´è‚ºç™Œ",
            "correct": "å’–å•¡å–å¾—å¤šçš„äººå¾€å¾€ä¹Ÿå¸çƒŸæ›´å¤š",
            "causality": "å¸çƒŸ â†’ è‚ºç™Œï¼Œå’–å•¡åªæ˜¯æ— è¾œçš„æ—è§‚è€…"
        },
        "é™·é˜± 3ï¼šé€‰æ‹©åå·®": {
            "example": "MBA æ¯•ä¸šç”Ÿçš„æ”¶å…¥æ¯”æœ¬ç§‘é«˜",
            "wrong": "MBA è®©æ”¶å…¥æé«˜",
            "correct": "èƒ½è€ƒä¸Š MBA çš„äººï¼Œæœ¬æ¥èƒ½åŠ›å°±æ›´å¼º",
            "causality": "èƒ½åŠ› â†’ MBA å½•å– & èƒ½åŠ› â†’ é«˜æ”¶å…¥"
        }
    }

    for name, info in pitfalls.items():
        print(f"\n{name}")
        print("-" * 70)
        print(f"è§‚å¯Ÿç°è±¡: {info['example']}")
        print(f"âŒ é”™è¯¯è§£è¯»: {info['wrong']}")
        print(f"âœ… æ­£ç¡®è§£è¯»: {info['correct']}")
        print(f"ğŸ“Š å› æœæœºåˆ¶: {info['causality']}")


def main():
    """ä¸»å‡½æ•°"""
    demonstrate_causal_ladder()
    bad_example_common_pitfalls()

    print("\n" + "=" * 70)
    print("ğŸ’¡ å…³é”®è¦ç‚¹")
    print("=" * 70)
    print("""
1. å› æœä¸‰å±‚çº§æ˜¯é€’è¿›çš„ï¼šä»"çœ‹åˆ°ç›¸å…³"åˆ°"å›ç­”å¹²é¢„"å†åˆ°"åäº‹å®æ¨ç†"
2. ç›¸å…³â‰ å› æœï¼šå¿…é¡»ç”¨å› æœå›¾è¯†åˆ«æ··æ‚ï¼Œç”¨åé—¨å‡†åˆ™é€‰æ‹©è°ƒæ•´é›†
3. æœ¬å‘¨ç›®æ ‡ï¼šä»"é¢„æµ‹æ¨¡å‹"ï¼ˆWeek 09-10ï¼‰å‡çº§åˆ°"å› æœæ¨æ–­"ï¼ˆWeek 13ï¼‰
4. AI å¯ä»¥å¸®ä½ ç®—å…³è”ï¼Œä½†åªæœ‰ä½ èƒ½ç”»å› æœå›¾ï¼ˆåŸºäºä¸šåŠ¡çŸ¥è¯†ï¼‰
    """)


if __name__ == "__main__":
    main()
