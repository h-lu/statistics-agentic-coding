# Week 15 作业：高级统计计算

本周作业涵盖降维、聚类、流式统计和 A/B 测试四个主题。**所有代码应放在 `assignments/` 目录下提交**。

---

## 基础题（巩固核心概念）

### 习题 1：PCA 降维实践

**目标**：理解 PCA 的核心概念，能用 sklearn 实现降维并解释结果。

**任务**：
1. 使用 `sklearn.datasets.make_classification` 生成一个高维数据集（1000 样本，100 特征）
2. 对数据进行标准化（重要！）
3. 拟合 PCA 模型，选择保留 85% 方差所需的主成分数
4. 打印：
   - 原始特征数
   - 降维后的特征数
   - 保留的方差比例
   - 前两个主成分的累积方差解释比例

**思考题**：如果不对数据进行标准化，PCA 结果会如何变化？

**评分标准**：
- 正确使用 StandardScaler（5 分）
- 正确计算 n_components（5 分）
- 输出清晰（5 分）
- 思考题回答合理（5 分）

---

### 习题 2：K-means 聚类分析

**目标**：掌握 K-means 聚类的核心步骤，能用肘部法则和轮廓系数选择最优 K 值。

**任务**：
1. 使用 `examples/02_clustering_demo.py` 中的合成数据
2. 实现 K 值搜索：K 从 2 到 10，计算每个 K 的轮廓系数
3. 绘制：
   - 轮廓系数 vs K 的折线图
   - 在图上标注最优 K 值
4. 用最优 K 值拟合 K-means，打印：
   - 每个簇的样本数
   - 簇内平方和（WCSS）

**思考题**：如果轮廓系数是负数，说明了什么？是数据问题还是 K 值选择问题？

**评分标准**：
- 代码正确实现 K 值搜索（10 分）
- 图表清晰标注最优 K（5 分）
- 思考题回答准确（5 分）

---

### 习题 3：在线统计算法实现

**目标**：理解流式统计的核心思想，能实现增量统计算法。

**任务**：
1. 实现一个 `OnlineStatistics` 类，支持：
   - 在线均值更新
   - 在线方差更新（Welford 算法）
   - 在线分位数估计（使用简化的分箱法）
2. 生成模拟流式数据（10000 个点，每次来 1 个）
3. 对比三种方法：
   - 批量方法（每次全量重算）
   - 在线方法（增量更新）
4. 打印：
   - 批量方法总耗时
   - 在线方法总耗时
   - 两种方法结果的差异（均值、方差）

**思考题**：在线分位数为什么只能估计？有没有精确的增量算法？

**评分标准**：
- OnlineStatistics 类实现正确（10 分）
- 性能对比清晰（5 分）
- 思考题回答合理（5 分）

---

### 习题 4：A/B 测试决策逻辑

**目标**：理解 A/B 测试工程化的核心组件，能设计合理的检验策略。

**任务**：
1. 给定以下 A/B 测试场景：
   - A 组：点击率 3.5%（1000 样本）
   - B 组：点击率 4.2%（1000 样本）
   - 显著性水平：α = 0.05
2. 实现决策函数：
   ```python
   def make_ab_decision(control_stats, treatment_stats, alpha=0.05):
       """
       输入：
       - control_stats: {"conversions": n1, "total": N1}
       - treatment_stats: {"conversions": n2, "total": N2}
       返回：{"decision": "launch_B" | "continue_A" | "needs_more_data", "p_value": float}
       """
   ```
3. 使用卡方检验计算 p 值
4. 实现样本比例异常（SRM）检测：如果实际样本量与预期比例差异超过 20%，拒绝决策

**思考题**：如果两组点击率都很低（如 < 1%），p 值可能显著吗？这种情况下应该怎么做决策？

**评分标准**：
- 卡方检验计算正确（10 分）
- SRM 检测实现正确（5 分）
- 决策逻辑完整（5 分）
- 思考题回答合理（5 分）

---

## 进阶题（综合应用）

### 习题 5：StatLab 集成——高维用户行为分析

**目标**：整合本周学到的降维、聚类、流式统计、A/B 测试，完成一个完整的高维数据分析流程。

**任务**：
基于 `examples/05_statlab_computational.py` 的框架，完成以下扩展：

1. **数据生成**：
   - 生成 5000 用户 × 200 维的模拟行为矩阵
   - 添加 5 个潜在因子（用户分群的基础）
   - 添加噪声

2. **降维与聚类**：
   - 用 PCA 降维到 20 维（保留 80% 方差）
   - 在降维后的空间运行 K-means（K=5）
   - 计算每个用户群的特征（如"活跃度"、"购买力"、"价格敏感"）

3. **流式统计**：
   - 模拟新用户数据持续到来（每批 100 个用户）
   - 使用在线统计算法增量更新每个用户群的均值和方差
   - 输出每个群的实时统计量

4. **A/B 测试**：
   - 设计一个 A/B 测试：对"高价值用户群"发送优惠券 A，对"价格敏感用户群"发送优惠券 B
   - 运行模拟实验，收集转化数据
   - 使用卡方检验评估每个群的实验效果
   - 输出决策建议

5. **报告生成**：
   - 生成一份 `report.md`，包含：
     - 数据来源和规模
     - 降维效果（原始维度 → 降维后维度 → 方差保留率）
     - 聚类结果（每个群的用户数、特征画像）
     - 流式统计效果（实时更新的准确性）
     - A/B 测试结论（统计显著性 + 业务建议）

**评分标准**：
- 流程完整性（30 分）：所有四个步骤都有实现
- 代码质量（20 分）：清晰、可读、有注释
- 报告质量（30 分）：`report.md` 结构清晰、结论明确、有可视化
- 可复现性（20 分）：固定随机种子、代码可独立运行

---

## 挑战题（开放探索）

### 习题 6：高维数据的可视化挑战

**目标**：探索高维数据可视化的难点，并实践非线性降维方法。

**任务**：
1. 使用 t-SNE 或 UMAP 对习题 5 中的高维用户行为数据进行降维到 2 维
2. 对比 PCA（线性）和 t-SNE（非线性）的降维效果：
   - 在 2 维平面上绘制样本，按用户群着色
   - 观察：PCA 能否清晰分离 5 个用户群？t-SNE 呢？
3. 写一段 200 字的分析：
   - 为什么 PCA 在这个数据集上效果有限？
   - t-SNE 的优势是什么？
   - t-SNE 的缺点是什么（如计算成本、超参数选择）？

**思考题**：如果数据有 100 万样本，t-SNE 的计算成本如何？有什么替代方案？

**评分标准**：
- 正确使用 t-SNE/UMAP（10 分）
- 可视化对比清晰（10 分）
- 分析深度到位（10 分）
- 思考题回答合理（5 分）

---

## 提交要求

### 文件结构
```
assignments/
├── week_15/
│   ├── exercise_1_pca.py
│   ├── exercise_2_clustering.py
│   ├── exercise_3_streaming.py
│   ├── exercise_4_ab_testing.py
│   ├── exercise_5_statlab.py
│   ├── exercise_6_visualization.py（可选，挑战题）
│   └── report.md（习题 5 必需）
└── README.md（简述每个习题的实现思路）
```

### 代码规范
- 所有 Python 文件符合 PEP 8
- 使用 `if __name__ == "__main__":` 作为入口
- 固定随机种子（`np.random.seed(42)`）保证可复现
- 每个函数有清晰的 docstring

### 报告要求（习题 5）
- 使用 Markdown 格式
- 包含必要的可视化（保存为图片，在报告中引用）
- 结论有数据支持，不凭感觉下结论
- 说明实现的技术挑战和解决方案

---

## 常见问题

**Q1：习题 5 太复杂，从何下手？**
A1：参考 `examples/05_statlab_computational.py`，它已经提供了完整框架。你只需要填补缺失的部分，而不是从头写起。

**Q2：PCA 的 n_components 参数怎么选？**
A2：可以指定小数（如 0.85 表示保留 85% 方差）或整数（指定主成分数）。小数更方便，sklearn 会自动计算需要的组件数。

**Q3：在线统计算法和批量方法结果为什么不完全一样？**
A3：由于浮点数精度和近似算法（如在线分位数），会有轻微差异。对于方差，Welford 算法在大数据集上比批量更稳定。

**Q4：A/B 测试的卡方检验与 z 检验有什么区别？**
A4：卡方检验基于计数（转化数、未转化数），z 检验基于比例（点击率）。两者在大样本下等价，但卡方检验更通用（可推广到多组比较）。

---

## 评分说明

| 等级 | 分数范围 | 描述 |
|------|-----------|------|
| A | 90-100 | 优秀：所有习题完成，代码质量高，报告有深度 |
| B | 80-89 | 良好：所有习题完成，代码质量较好，报告清晰 |
| C | 70-79 | 合格：基础题完成，进阶题部分完成 |
| D | 60-69 | 勉强：基础题大部分完成 |
| F | < 60 | 不合格：完成度不足 |

**扣分项**：
- 代码不符合 PEP 8（-5 分）
- 没有固定随机种子导致不可复现（-5 分）
- 缺少必要的注释或 docstring（-3 分）
- 报告格式混乱（-3 分）

**加分项**：
- 挑战题完成（+5 分）
- 代码有单元测试（+3 分）
- 使用了增量统计的高级算法（如 t-digest）（+2 分）
