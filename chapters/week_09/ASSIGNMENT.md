# Week 09 作业：回归分析与模型诊断

> "All models are wrong, but some are useful."
> — George Box

本周作业要求你**完整走一遍回归分析流程**：从简单回归到多元回归，从系数解释到残差诊断，从多重共线性检测到异常点分析。你不再只是"拟合一个模型"，而是学会判断"这个模型是否可靠"、"系数能否解释"、"假设是否满足"。

---

## 作业结构

| 层级 | 内容 | 建议时间 |
|------|------|----------|
| 基础作业（必做） | 简单回归、多元回归、系数解释、VIF 检查 | 3-4 小时 |
| 进阶作业（选做） | 残差诊断（LINE 假设）、Cook's 距离、稳健回归 | 1-2 小时 |
| 挑战作业（可选） | 完整回归报告撰写与模型对比 | 2-3 小时 |
| AI 协作练习（可选） | 审查 AI 生成的回归报告 | 1 小时 |

---

## 基础作业（必做）

### 任务 1：简单回归——从散点图到回归线（25 分）

**目标**：理解回归分析的核心动机，正确解释截距和斜率

**数据**：使用 `examples/09_simple_regression.py` 中生成的房价数据

**步骤**：

1. **探索性分析**：
   - 画散点图（面积 vs 房价）
   - 计算相关系数
   - 观察是否存在线性关系

2. **拟合简单回归**：
   - 使用 statsmodels 或 sklearn 拟合模型：`房价 = β₀ + β₁×面积`
   - 提取截距和斜率
   - 计算 R² 和 F 统计量

3. **系数解释**：
   - 正确解释截距的含义（在 x=0 时的 y 值）
   - 正确解释斜率的含义（**永远加上"在其他变量不变的情况下"**）
   - 构造斜率的 95% 置信区间

4. **可视化**：
   - 在散点图上画出回归线
   - 标注方程和 R²

5. **提交** `simple_regression_report.md`，包含：
   - 研究问题
   - 散点图 + 回归线
   - 回归方程（截距、斜率、95% CI）
   - R² 和拟合优度解释
   - 系数的业务解释

**输入示例**：
```
面积(平米) | 房价(万元)
50          | 85
60          | 92
70          | 105
...
```

**输出示例**：
```
回归方程：房价 = 25.30 + 1.18×面积
- 截距 β₀ = 25.30 (95% CI: [18.50, 32.10])
- 斜率 β₁ = 1.18 (95% CI: [0.95, 1.41])
- R² = 0.68
- F(1, 98) = 208.5, p < 0.001

解释：在其他变量不变的情况下，面积每增加 1 平米，房价平均上涨 1.18 万元。
```

**评分标准**：
- 模型拟合正确（8 分）
- 系数解释完整且准确（10 分）
- 95% CI 正确构造（4 分）
- 可视化清晰（3 分）

---

### 任务 2：多元回归与多重共线性（30 分）

**目标**：在多元回归中正确解释系数，检测和处理多重共线性

**数据**：使用 `examples/09_multiple_regression.py` 中的房价数据（多个预测变量）

**步骤**：

1. **拟合多元回归**：
   - 选择至少 3 个预测变量（如面积、房龄、房间数）
   - 拟合模型：`房价 = β₀ + β₁×面积 + β₂×房龄 + β₃×房间数`
   - 提取系数表（系数、标准误、t 值、p 值、95% CI）

2. **系数解释**：
   - 对每个系数写出完整解释（**加上"在其他变量不变的情况下"**）
   - 对比简单回归和多元回归中同一变量系数的变化
   - 解释为什么系数会变化（遗漏变量偏差）

3. **多重共线性检查**：
   - 计算每个变量的 VIF（方差膨胀因子）
   - 识别 VIF ≥ 10 的变量
   - 画出相关矩阵热力图

4. **处理多重共线性**：
   - 如果存在 VIF ≥ 10 的变量，选择以下策略之一：
     - 删除冗余变量
     - 合并变量
     - 使用正则化（LASSO/Ridge）
   - 重新拟合模型并对比系数

5. **提交** `multiple_regression_report.md`，包含：
   - 完整系数表
   - 每个系数的解释
   - VIF 表和相关矩阵
   - 多重共线性处理策略和结果

**评分标准**：
- 多元回归拟合正确（8 分）
- 系数解释准确（每个 3 分，共 9 分）
- VIF 计算和解释正确（8 分）
- 多重共线性处理策略合理（5 分）

---

### 任务 3：回归系数的置信区间（20 分）

**目标**：理解回归系数的不确定性，正确构造和解释置信区间

**步骤**：

1. **使用 statsmodels 获取 95% CI**：
   - 拟合模型后调用 `conf_int()` 方法
   - 解释每个区间的含义

2. **手动构造置信区间**（理解 t 公式）：
   - CI = β̂ ± t_(α/2, df) × SE(β̂)
   - 验证手动计算的区间与 statsmodels 输出一致

3. **Bootstrap 置信区间**（连接 Week 08）：
   - 使用自助法重采样 1000 次
   - 每次重新拟合回归，记录系数
   - 用百分位数法构造 95% CI
   - 对比理论 CI 和 Bootstrap CI

4. **提交** `confidence_interval_analysis.md`，包含：
   - 理论 95% CI（statsmodels 输出）
   - 手动计算验证
   - Bootstrap 95% CI
   - 两种方法的对比（什么时候 Bootstrap 更可靠？）

**评分标准**：
- 理论 CI 正确提取（5 分）
- 手动计算验证正确（7 分）
- Bootstrap CI 实现正确（6 分）
- 对比分析合理（2 分）

---

## 进阶作业（选做）

### 任务 4：残差诊断与回归假设（30 分）

**目标**：验证回归的四大假设（LINE），判断模型是否可靠

**数据**：使用任务 2 中的多元回归模型

**步骤**：

1. **残差计算**：
   - 计算每个观测的预测值和残差
   - 计算标准化残差

2. **假设 1：线性——残差 vs 拟合值图**：
   - 画残差 vs 拟合值散点图
   - 判断：是否有 U 型或倒 U 型模式？
   - 结论：线性假设是否满足？

3. **假设 2：正态性——QQ 图与 Shapiro-Wilk 检验**：
   - 画 QQ 图
   - 执行 Shapiro-Wilk 检验
   - 判断：残差是否近似正态？
   - 结论：正态假设是否满足？

4. **假设 3：等方差——残差散布检查**：
   - 再次观察残差 vs 拟合值图
   - 判断：残差散布是否均匀（无"喇叭"形状）？
   - 执行 Breusch-Pagan 检验（可选）
   - 结论：等方差假设是否满足？

5. **假设 4：独立性——Durbin-Watson 检验**：
   - 计算 DW 统计量
   - 判断：DW 是否接近 2？
   - 结论：独立性假设是否满足？

6. **如果假设违反，提出修正方案**：
   - 非线性：加入多项式项或变换变量
   - 非正态：Bootstrap 置信区间
   - 异方差：稳健标准误（HC3）
   - 自相关：需要时间序列方法（超纲）

7. **提交** `residual_diagnostics_report.md`，包含：
   - 四张诊断图（残差 vs 拟合值、QQ 图、尺度-位置图、Cook's 距离）
   - 每个假设的检验结论（满足/违反）
   - 如果违反，修正方案和修正后的结果

**评分标准**：
- 四个假设检验完整（16 分，每个 4 分）
- 诊断图清晰（8 分）
- 修正方案合理（6 分）

---

### 任务 5：异常点与 Cook's 距离（25 分）

**目标**：识别对回归模型有强影响的异常点

**步骤**：

1. **识别三种"异常点"**：
   - 离群点：残差绝对值 > 2
   - 高杠杆点：杠杆值 > 2×(k+1)/n（k 是变量数）
   - 强影响点：Cook's D > 1

2. **计算 Cook's 距离**：
   - 使用 statsmodels 的 `get_influence()` 方法
   - 画出 Cook's 距离图
   - 标注 D > 1 的观测索引

3. **杠杆图**：
   - 画出 Leverage vs 标准化残差图
   - 识别右上方/右下方的强影响点

4. **敏感性检验**：
   - 删除 Cook's D > 1 的观测
   - 重新拟合模型
   - 对比删除前后的系数变化（百分比）
   - 判断：模型对异常点是否稳健？

5. **提交** `outlier_analysis.md`，包含：
   - Cook's 距离图和杠杆图
   - 强影响点列表
   - 删除前后的系数对比表
   - 最终决策：保留还是删除？为什么？

**评分标准**：
- 三种异常点识别正确（8 分）
- Cook's 距离计算和可视化正确（8 分）
- 敏感性检验完整（5 分）
- 决策理由充分（4 分）

---

## 挑战作业（可选）

### 任务 6：完整回归报告撰写（35 分）

**目标**：撰写一份可交付的回归分析报告

**要求**：

1. **报告结构**（Markdown 格式）：
   - 摘要（100 字）
   - 研究问题与数据来源
   - 探索性分析
   - 模型设定与变量选择
   - 回归结果（系数表、拟合优度）
   - 残差诊断（四大假设检验）
   - 多重共线性检查
   - 异常点分析
   - 局限性与因果警告
   - 业务建议

2. **可视化**：
   - 散点图 + 回归线
   - 残差诊断四图
   - Cook's 距离图
   - 相关系数热力图

3. **代码提交**：
   - 可复现的 Python 脚本或 Jupyter Notebook
   - 固定随机种子
   - 清晰注释

4. **提交** `full_regression_report.md` + `regression_analysis.py`

**评分标准**：
- 报告结构完整（10 分）
- 分析深度充足（10 分）
- 可视化清晰（8 分）
- 代码可复现（7 分）

---

## AI 协作练习（可选）

### 任务 7：审查 AI 生成的回归报告（20 分）

**背景**：根据 `CLAUDE.md` 的 AI 融合渐进路径，Week 09 属于**"协作期"**（Week 09-12）——AI 辅助建模与评估，但关键决策由你主导。你需要学会审查 AI 生成的回归报告。

**步骤**：

1. **获取 AI 生成的报告**：
   - 使用你喜欢的 AI 工具（如 ChatGPT、Claude 等）
   - 输入以下提示词：
     ```
     我有一份房价数据，包含以下变量：
     - area_sqm: 房屋面积（平米）
     - age_years: 房龄（年）
     - n_rooms: 房间数
     - price_wan: 售价（万元）

     请帮我进行多元回归分析，回答"哪些因素影响房价"。
     ```

2. **保存 AI 原始输出**，将其保存为 `ai_original_report.txt`

3. **使用审查清单**：

   检查 AI 报告是否包含以下内容：
   - [ ] 系数表（系数、标准误、t 值、p 值、95% CI）
   - [ ] 系数解释（**是否加上"在其他变量不变的情况下"**）
   - [ ] 残差图（残差 vs 拟合值、QQ 图）
   - [ ] VIF 检查（多重共线性）
   - [ ] Cook's 距离（异常点影响）
   - [ ] 回归假设检验结论（LINE）
   - [ ] 因果警告（**是否混淆相关与因果**）
   - [ ] R² 和调整 R²
   - [ ] 拟合优度解释
   - [ ] 局限性讨论

4. **写一份审查报告** `ai_review_report.md`，包含：
   - AI 原始报告（摘要）
   - 缺失项列表（按严重性分类：高/中/低）
   - 误解释或错误分析（如有）
   - 你的修订版结论（补充缺失诊断、修正错误解释）

5. **反思**（150 字）：
   - AI 在回归分析任务上表现如何？
   - 哪些诊断项 AI 容易遗漏？
   - 哪些解释人类必须检查？

**评分标准**：
- 审查全面性（10 分）
- 问题分类合理（5 分）
- 修订版结论准确（5 分）

---

## StatLab 集成

**要求**：本周所有基础作业的产出应整合到你的 StatLab 报告中

**具体操作**：

1. 在你的 `report.md` 中添加"回归分析"章节
2. 使用 `examples/99_statlab_regression.py` 作为参考或直接调用
3. 包含以下内容：
   - 简单回归结果（系数解释、R²）
   - 多元回归系数表
   - VIF 检查结果
   - 残差诊断图
   - Cook's 距离分析
   - 局限性与因果警告

---

## 提交方式

1. 将所有文件放入 `chapters/week_09/assignment/` 目录
2. 文件命名规范：
   - `simple_regression_report.md`
   - `multiple_regression_report.md`
   - `confidence_interval_analysis.md`
   - `residual_diagnostics_report.md`（进阶）
   - `outlier_analysis.md`（进阶）
   - `full_regression_report.md`（挑战）
   - `regression_analysis.py`（挑战）
   - `ai_original_report.txt`（AI 协作）
   - `ai_review_report.md`（AI 协作）
3. 确保所有 Markdown 文档使用清晰的章节结构

---

## 作业提示

1. **永远加上"在其他变量不变的情况下"**：这是回归系数解释的核心
2. **残差图比 R² 更重要**：高 R² 不等于模型可靠，必须检查假设
3. **不要把回归系数当成因果效应**：关联 ≠ 因果
4. **VIF > 10 时要小心**：系数可能不稳定，考虑删除或合并变量
5. **异常点不要轻易删除**：先核实是不是录入错误，再做敏感性检验
6. **报告要诚实**：没检验的假设不要说"满足"，不确定的地方写"局限性"
7. **AI 是加速器，不是决策者**：AI 可以拟合模型，但诊断和解释由你负责
