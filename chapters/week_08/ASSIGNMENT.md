# Week 08 作业：区间估计与重采样

> **核心目标**：从"点估计"升级到"区间估计"，用 Bootstrap 和置换检验量化结论的不确定性

---

## 作业说明

本周作业分三层：**基础**（直接应用本周概念）、**进阶**（综合多个方法）、**挑战**（创意与深度思考）。

完成基础作业即可达到本周学习目标。进阶和挑战作业帮助你对方法有更深的理解。

**提交要求**：
- 基础作业必须全部完成
- 进阶作业至少完成 2 题
- 挑战作业可选
- AI 协作练习可选（推荐）

---

## 基础作业

### 基础题 1：置信区间计算与解释

某电商平台想估计"新用户的平均首单消费"。随机抽取 50 位新用户，记录他们的首单消费金额（单位：元）：

```
[312, 285, 340, 298, 315, 327, 301, 289, 333, 310,
 295, 318, 302, 325, 291, 308, 316, 287, 334, 299,
 320, 293, 311, 284, 326, 303, 317, 290, 331, 305,
 296, 313, 288, 328, 304, 319, 292, 335, 300, 307,
 314, 297, 309, 323, 286, 332, 294, 315, 306, 321]
```

**任务**：

1. 计算样本均值、样本标准差、标准误
2. 构造均值的 95% 置信区间（使用 t 公式）
3. 写出两种解释：
   - ❌ 错误解释（初学者常见的误解）
   - ✅ 正确解释（频率学派）
4. 判断：如果再抽取 50 位新用户，新的均值有多大可能在当前 CI 内？说明理由

**输入示例**：
```python
data = [312, 285, 340, ...]  # 50 个值
```

**输出示例**（格式参考，不要直接复制）：
```
样本均值：308.45 元
样本标准差：15.23 元
标准误：2.15 元
95% CI：[304.12, 312.78]

错误解释：均值有 95% 的概率在 [304.12, 312.78] 内
正确解释：如果我们重复抽样 100 次，构造 100 个这样的区间，约 95 个会覆盖真值

判断题：新均值在当前 CI 内的概率不是 95%，当前 CI 已经固定，要么包含真值，要么不包含
```

**评分点**：
- 样本均值、标准差、标准误计算正确（2 分）
- 95% CI 计算正确（使用 t 分布，自由度 n-1）（3 分）
- 错误解释能指出初学者常见误解（2 分）
- 正确解释符合频率学派（"方法的覆盖率"）（3 分）

**常见错误**：
- 使用 z 分布而不是 t 分布（小样本应该用 t）
- 误解释 CI："均值有 95% 的概率在区间内"（频率学派解释错误）
- 忘记标注自由度
- 标准误公式错误（应该是 s/√n）

---

### 基础题 2：Bootstrap 实战——均值差的置信区间

继续使用上题的数据。假设老用户的 50 个首单消费记录为：

```
[295, 278, 310, 289, 298, 305, 283, 276, 312, 291,
 282, 302, 285, 307, 280, 294, 299, 275, 313, 287,
 304, 279, 293, 272, 308, 284, 300, 277, 311, 286,
 281, 295, 274, 309, 288, 301, 278, 314, 283, 290,
 296, 280, 292, 306, 271, 315, 285, 297, 282, 303]
```

**任务**：

1. 用 Bootstrap 构造新用户 vs 老用户**均值差的 95% CI**
   - Bootstrap 次数：10000 次
   - 使用百分位数法（2.5% 和 97.5% 分位数）
   - 设置随机种子 `seed=42`（确保结果可复现）

2. 判断显著性：
   - 如果 95% CI 不包含 0，说明"差异显著"
   - 如果 95% CI 包含 0，说明"差异不显著"

3. 画出 Bootstrap 分布的直方图，标注：
   - 原始均值差（绿色实线）
   - 95% CI 的上下界（红色虚线）
   - 零线（黑色实线）

4. 解释：为什么 Bootstrap 不需要假设数据服从正态分布？

**输入示例**：
```python
new_users = [312, 285, ...]  # 50 个值
old_users = [295, 278, ...]  # 50 个值
```

**输出示例**（格式参考）：
```
原始均值差：13.24 元
Bootstrap 95% CI：[7.85, 18.63]
结论：新用户显著高于老用户（95% CI 不包含 0）
```

**评分点**：
- Bootstrap 实现正确（有放回抽样，组内重采样）（4 分）
- 95% CI 计算正确（百分位数法）（3 分）
- 显著性判断正确（CI 是否包含 0）（2 分）
- 可视化清晰（直方图 + 标注）（3 分）
- 解释合理（"用样本内部变异模拟总体变异"）（3 分）

**常见错误**：
- 无放回抽样（应该是 `replace=True`）
- 两组数据混合后重采样（应该组内重采样）
- Bootstrap 次数太少（< 1000，导致 CI 不稳定）
- 百分位数计算错误（应该是 `np.percentile(..., [2.5, 97.5])`）

---

### 基础题 3：置换检验——t 检验的稳健替代

使用与基础题 2 相同的数据。

**任务**：

1. 执行置换检验（Permutation Test），检验"新用户 vs 老用户的消费是否有差异"
   - 置换次数：10000 次
   - 统计量：均值差
   - 设置随机种子 `seed=42`

2. 计算：
   - 观测均值差
   - 置换 p 值（双尾）
   - 置换 95% CI（用置换分布的 2.5% 和 97.5% 分位数）

3. 对比置换检验与 t 检验：
   - 如果你有 t 检验的结果（p 值、CI），与置换检验的结果对比
   - 两者是否一致？如果不一致，可能的原因是什么？

4. 解释：什么情况下置换检验比 t 检验更可靠？

**输入示例**：
```python
new_users = [312, 285, ...]  # 50 个值
old_users = [295, 278, ...]  # 50 个值
```

**输出示例**（格式参考）：
```
观测均值差：13.24 元
置换 p 值：0.0003
置换 95% CI：[7.92, 18.56]
结论：拒绝 H0（差异显著）

与 t 检验对比：
- t 检验 p 值：0.0004
- 置换检验 p 值：0.0003
- 两者一致，说明数据近似满足 t 检验的正态假设
```

**评分点**：
- 置换检验实现正确（合并数据，打乱标签，重新分组）（4 分）
- p 值计算正确（双尾，考虑两端极端值）（3 分）
- 置换 CI 计算正确（3 分）
- 对比分析合理（理解两种方法的适用场景）（3 分）
- 解释准确（"数据严重偏态或小样本时，置换检验更稳健"）（2 分）

**常见错误**：
- 打乱标签时只打乱一组（应该合并后打乱）
- p 值计算错误（只考虑单尾，没有乘以 2）
- 置换次数太少（< 1000，导致 p 值不稳定）
- 双尾检验逻辑错误（应该同时考虑正向和负向极端值）

---

### 基础题 4：置信区间 vs 可信区间——框架对比

小北在报告中写道：

> "新用户平均消费的 95% 置信区间是 [304, 313] 元，这意味着均值有 95% 的概率在这个区间内。"

老潘指出这句话有问题。

**任务**：

1. 指出小北的解释哪里有问题（频率学派 CI 的正确解释是什么？）

2. 如果使用贝叶斯框架，"均值有 95% 的概率在 [304, 313] 内"这个解释是否正确？说明理由

3. 填写下表，对比两种框架（用"新用户平均消费 315 元，95% 区间 [304, 326]"为例）：

   | 维度 | 频率学派（CI） | 贝叶斯学派（可信区间） |
   |------|---------------|---------------------|
   | 参数是什么 | 固定但未知的值（如真实均值 μ） | 随机变量，有概率分布 |
   | 区间是什么 | 随机区间，每次抽样都会变 | 固定区间（如 [304, 326]） |
   | 95% 的含义 | 方法的覆盖率：重复抽样 100 次，约 95 个区间覆盖真值 | 参数的概率：均值有 95% 概率在 [304, 326] 内 |
   | 依赖什么 | 只依赖数据（似然） | 依赖数据 + 先验知识 |
   | 何时使用 | 没有先验知识，需要客观标准 | 有历史数据或专家知识可用 |

4. 解释：为什么贝叶斯框架需要"先验"（prior）？先验选择不当会有什么风险？

**评分点**：
- 能指出小北的解释错误（3 分）
- 能解释频率学派 CI 的正确含义（"方法的覆盖率"）（4 分）
- 能解释贝叶斯可信区间的正确含义（"参数的概率分布"）（3 分）
- 对比表填写正确（5 分）
- 能解释先验的作用与风险（3 分）

**常见错误**：
- 混淆两种框架的解释
- 认为"两种框架只是说法不同，本质一样"（实际上是不同的哲学）
- 无法解释先验的作用
- 填写对比表时混淆"参数"和"统计量"

---

## 进阶作业

### 进阶题 1：Bootstrap 进阶——效应量的置信区间

Week 06 你学过 Cohen's d（效应量）：

```
Cohen's d = (均值差) / 合并标准差
```

**任务**：

1. 用 Bootstrap 构造新用户 vs 老用户**Cohen's d 的 95% CI**
   - Bootstrap 每次都要重新计算 Cohen's d
   - 使用百分位数法
   - Bootstrap 次数：10000 次

2. 解释效应量：
   - 如果 Cohen's d = 0.85，95% CI = [0.45, 1.25]，如何解释？
   - 效应量是"小"、"中"、"大"？

3. 对比：
   - 只报告 p < 0.001，不报告效应量 CI，有什么问题？
   - 效应量 CI 比 p 值多提供了什么信息？

4. 画出 Cohen's d 的 Bootstrap 分布，标注：
   - 观测值（绿色实线）
   - 95% CI（红色虚线）
   - 0 值线（黑色实线，判断是否显著）

**评分点**：
- Bootstrap Cohen's d 实现正确（4 分）
- 95% CI 计算正确（3 分）
- 效应量解释合理（参考 Cohen's 经验标准：0.2=小，0.5=中，0.8=大）（3 分）
- 对比分析深入（理解"统计显著 ≠ 实际重要"）（4 分）
- 可视化清晰（3 分）

**常见错误**：
- Cohen's d 公式错误（忘记合并标准差）
- Bootstrap 时只用均值差，没有标准化
- 解释时混淆"统计显著"和"实际重要"
- CI 包含 0 时得出"效应量显著"的错误结论

---

### 进阶题 2：多重比较的置信区间——Week 07 回顾与扩展

Week 07 你学过 Tukey HSD（多组比较的事后检验）。本周你学会了置信区间。

**任务**：

1. 模拟数据：5 个城市的消费数据（每个城市 50 个样本）
   ```python
   np.random.seed(42)
   cities = ['北京', '上海', '广州', '深圳', '杭州']
   data = {
       '北京': np.random.normal(loc=300, scale=50, size=50),
       '上海': np.random.normal(loc=320, scale=50, size=50),
       '广州': np.random.normal(loc=290, scale=50, size=50),
       '深圳': np.random.normal(loc=330, scale=50, size=50),
       '杭州': np.random.normal(loc=310, scale=50, size=50)
   }
   ```

2. 用 Bootstrap 构造所有**两两比较**的均值差 95% CI：
   - 共 10 对比较（C(5,2) = 10）
   - 用 Bootstrap 计算每对的 95% CI
   - 判断哪些对差异显著（CI 不包含 0）

3. 多重比较问题：
   - 如果不做校正，10 个 CI 中至少有一个不包含真值的概率是多少？
   - 提示：单个 CI 的覆盖率是 95%，10 个独立 CI 的覆盖率是 0.95^10 ≈ 60%

4. 解释：为什么需要多重比较校正？Tukey HSD 和 Bonferroni 校正的区别是什么？

**评分点**：
- Bootstrap 两两比较实现正确（4 分）
- 显著性判断正确（CI 是否包含 0）（3 分）
- 多重比较问题理解正确（3 分）
- 校正方法解释合理（Tukey HSD vs Bonferroni）（4 分）

**常见错误**：
- 只做部分比较（遗漏某些配对）
- 忘记多重比较问题（认为 10 个 95% CI 的总体覆盖率还是 95%）
- 混淆 Tukey HSD 和 Bonferroni（Tukey 专门用于 ANOVA 事后检验，Bonferroni 是通用方法）

---

### 进阶题 3：报告的不确定性量化——StatLab 实践

本周 StatLab 要求在 `report.md` 中添加"不确定性量化"章节。

**任务**：

1. 用你自己的数据（或继续使用本周作业的模拟数据），完成以下分析：
   - 均值的 95% CI（t 公式）
   - 均值差的 95% CI（Bootstrap）
   - 置换检验（p 值 + CI）
   - 效应量的 95% CI（Bootstrap，可选）

2. 在 `report.md` 中添加"不确定性量化"章节，包含：
   - 频率学派置信区间（t 公式）的结果和解释
   - Bootstrap 置信区间（重采样）的结果和解释
   - 置换检验（分布无关）的结果和解释
   - 不确定性可视化（至少 1 张图）
   - 方法选择说明（为什么用 Bootstrap/置换检验？）

3. 对比三种方法的结果：
   - t 公式 CI vs Bootstrap CI：宽度是否一致？
   - 置换检验 p 值 vs t 检验 p 值：是否一致？
   - 如果不一致，可能的原因是什么？

4. 提交：
   - 更新后的 `report.md`
   - 生成可视化的代码（如 `uncertainty_plots.py`）

**评分点**：
- CI 计算正确（至少 2 种方法）（4 分）
- `report.md` 章节完整（包含所有要求的小节）（5 分）
- 解释符合频率学派（不是"参数的概率"）（3 分）
- 可视化清晰（至少 1 张图）（3 分）
- 对比分析深入（理解不同方法的适用场景）（4 分）

**常见错误**：
- `report.md` 中解释 CI 时写成"参数有 95% 的概率"
- 只报告数字，没有可视化
- 只用一种方法，没有对比
- 没有说明"为什么选择 Bootstrap/置换检验"

---

## 挑战作业

### 挑战题 1：Bootstrap 的局限——何时会失败？

老潘说："Bootstrap 不是魔法，它有几个前提。"小北问："什么时候 Bootstrap 会失败？"

**任务**：

1. 设计或寻找一个 Bootstrap **失败**的例子：
   - 样本量很小（如 n < 20）
   - 样本有严重偏差（如选择偏差）
   - 数据有强依赖关系（如时间序列）

2. 对比：
   - 用 Bootstrap 构造 CI
   - 用理论公式（如果存在）构造 CI
   - 哪个更可靠？为什么？

3. 解释：
   - Bootstrap 为什么会失败？（核心假设是什么？）
   - 如何检测 Bootstrap 是否可靠？（如：检查 Bootstrap 分布的形状、对比不同 Bootstrap 次数的结果）

4. 提出改进方案：
   - 小样本时可以用什么替代方法？（如：t 公式、贝叶斯方法）
   - 样本有偏差时如何修正？（如：加权 Bootstrap、分层 Bootstrap）
   - 时间序列数据如何处理？（如：块 Bootstrap）

**评分点**：
- 能设计/找到 Bootstrap 失败的例子（5 分）
- 能解释失败原因（理解 Bootstrap 的假设）（5 分）
- 能提出改进方案（展示对方法的深入理解）（5 分）
- 代码实现完整（4 分）

**常见错误**：
- 认为 Bootstrap 是万能的，永远不会失败
- 无法解释失败的根本原因（如"样本不是总体的代表"）
- 改进方案不合理（如"增加 Bootstrap 次数可以拯救小样本"）

---

### 挑战题 2：批判性分析——AI 生成的推断报告

老潘给小北看了一份 AI 生成的推断报告（见下方），让小北找出其中的问题。

**AI 生成的报告**：

```
# 消费数据分析报告

## 推断结果

我们对新用户（n=50）和老用户（n=50）的消费进行了 t 检验。

**结果**：
- 新用户平均消费：308.45 元
- 老用户平均消费：295.21 元
- t 统计量：3.25
- p 值：0.001

**结论**：
- 新用户显著高于老用户（p < 0.05）
- p 值很小，说明差异很大
- 建议针对新用户加大营销投入

## 讨论

我们的结果高度显著（p < 0.001），说明新用户消费远高于老用户。
由于样本量达到 100，结论非常可靠。
```

**任务**：

1. 审查这份报告，列出至少 **5 个问题**：
   - 缺少什么信息？
   - 哪些解释不正确？
   - 哪些结论过度解读？

2. 对每个问题，给出：
   - 风险：这个问题会导致什么后果？
   - 改进建议：如何修正？

3. 写一份**修订版报告**（200-300 字），包含：
   - 点估计（均值、均值差）
   - 不确定性量化（95% CI）
   - 效应量（Cohen's d 或其他）
   - 稳健性检验（Bootstrap 或置换检验）
   - 正确的解释（频率学派）

4. 提交：
   - 问题清单（5 个问题 + 风险 + 建议）
   - 修订版报告

**评分点**：
- 能识别至少 5 个问题（每个 2 分）（10 分）
- 每个问题的风险和建议合理（10 分）
- 修订版报告完整（包含所有要求的信息）（8 分）
- 修订版报告解释正确（符合频率学派）（7 分）

**常见错误**：
- 找不出 5 个问题（说明对不确定性量化的理解不够深入）
- 风险和建议不具体（如"风险是不准确"）
- 修订版报告仍然缺少关键信息（如 CI、效应量）
- 修订版报告解释仍然有误（如"均值有 95% 的概率在 CI 内"）

---

## AI 协作练习（可选）

> **识别期（Week 05-08）**：学会审查 AI 的统计推断结论

### 背景

某个 AI 工具生成了以下代码，用于"检验新用户 vs 老用户的消费差异"：

```python
# AI 生成的代码（故意包含 3 个问题）
import numpy as np
from scipy import stats

# 模拟数据
np.random.seed(42)
new_users = np.random.normal(loc=315, scale=50, size=100)
old_users = np.random.normal(loc=300, scale=50, size=100)

# t 检验
t_stat, p_value = stats.ttest_ind(new_users, old_users)

print(f"t 统计量：{t_stat:.4f}")
print(f"p 值：{p_value:.6f}")

# 结论
if p_value < 0.05:
    print("结论：新用户显著高于老用户")
else:
    print("结论：差异不显著")
```

### 审查清单

请审查这段代码：

- [ ] **前提假设检查**：代码有检查正态性、方差齐性吗？如果没有，应该补充什么检查？
- [ ] **效应量缺失**：代码只报告了 p 值，没有报告效应量（Cohen's d）。缺少效应量会有什么问题？
- [ ] **不确定性量化**：代码没有报告置信区间。读者如何知道"差异有多大范围"？
- [ ] **稳健性检验**：代码只依赖 t 检验，没有 Bootstrap 或置换检验。如果数据不满足正态假设，结论可靠吗？
- [ ] **解释问题**：代码的结论"新用户显著高于老用户"是否完整？还需要补充什么信息？

### 你的任务

1. **识别问题**：找出代码中的 3 个问题（不限于上述清单）

2. **修复代码**：写出修复后的代码，包含：
   - 前提假设检查（正态性、方差齐性）
   - 效应量计算（Cohen's d）
   - 95% CI（t 公式或 Bootstrap）
   - 稳健性检验（置换检验）
   - 完整的结论（p 值 + CI + 效应量）

3. **写审查报告**（200-300 字），说明：
   - 原代码有哪些问题？
   - 你做了哪些修复？
   - 修复后的代码提供了哪些额外信息？
   - 这些信息为什么重要？

### 提交

- 修复后的代码
- 审查报告（问题 + 修复 + 重要性）

### 评分点

- 能识别至少 3 个问题（每个 2 分）（6 分）
- 修复后的代码完整（包含所有要求的部分）（8 分）
- 审查报告清晰、合理（6 分）

---

## StatLab 任务

本周 StatLab 要求在 `report.md` 中添加"不确定性量化"章节。

**任务**：

1. 用你自己的数据（或本周作业的模拟数据），完成：
   - 均值的 95% CI（t 公式）
   - 均值差的 95% CI（Bootstrap）
   - 置换检验（p 值 + CI）
   - 可视化（至少 1 张图）

2. 在 `report.md` 中添加"不确定性量化"章节，包含：
   - 频率学派置信区间（t 公式）
   - Bootstrap 置信区间（重采样）
   - 置换检验（分布无关）
   - 不确定性可视化
   - 方法选择说明

3. 更新 `report.md` 的"本周小结"，说明你学会了什么

**提交**：
- 更新后的 `report.md`
- 生成分析的代码（如 `uncertainty_analysis.py`）

---

## 提交清单

完成本周作业后，你应该有：

**基础作业**（必做）：
- [ ] 基础题 1：置信区间计算与解释
- [ ] 基础题 2：Bootstrap 实战
- [ ] 基础题 3：置换检验
- [ ] 基础题 4：置信区间 vs 可信区间

**进阶作业**（至少完成 2 题）：
- [ ] 进阶题 1：Bootstrap 进阶——效应量的 CI
- [ ] 进阶题 2：多重比较的置信区间
- [ ] 进阶题 3：报告的不确定性量化

**挑战作业**（可选）：
- [ ] 挑战题 1：Bootstrap 的局限
- [ ] 挑战题 2：批判性分析——AI 报告审查

**AI 协作练习**（可选）：
- [ ] AI 代码审查 + 修复 + 审查报告

**StatLab**（必做）：
- [ ] 更新 `report.md`，添加"不确定性量化"章节

---

## 常见问题

**Q1：Bootstrap 和置换检验有什么区别？**

A：
- **Bootstrap**：有放回地**重采样**（resampling），用于估计统计量的分布和 CI
- **置换检验**：随机**打乱标签**（permutation），用于构造零分布，计算 p 值
- Bootstrap 关注"统计量如何波动"，置换检验关注"H0 为真时统计量如何分布"

**Q2：什么时候用 t 公式，什么时候用 Bootstrap？**

A：
- **样本量大（n > 30）、正态性满足**：用 t 公式（有理论支持，计算快）
- **样本量小（n < 30）、分布未知**：用 Bootstrap（不依赖分布假设）
- **统计量没有理论公式**（如中位数）：必须用 Bootstrap

**Q3：置信区间和 p 值是什么关系？**

A：
- 如果 95% CI 不包含 H0 的值（如 0），则等价于 p < 0.05
- CI 提供的信息比 p 值更多：它告诉你"差异在哪里"，而不仅仅是"是否显著"
- 推荐：同时报告 CI 和 p 值

**Q4：频率学派和贝叶斯学派哪个更好？**

A：
- 没有"更好"，只有"适用场景不同"
- **频率学派**：客观，只依赖数据，适合没有先验知识的情况
- **贝叶斯学派**：能整合先验知识，解释更直观，适合有历史数据或专家知识的情况
- 本周重点学习频率学派（CI），贝叶斯框架（可信区间）在 Week 14 深入学习

**Q5：Bootstrap 次数应该是多少？**

A：
- **最少**：1000 次（CI 和 p 值基本稳定）
- **推荐**：10000 次（更稳定，计算成本可接受）
- **高精度需求**：100000 次（如发表重要论文）
- 次数太少会导致 CI 和 p 值不稳定（每次运行结果差异大）

---

## 参考资源

如果你遇到困难，可以参考：
- `starter_code/solution.py`：参考实现（不要直接复制）
- `examples/` 目录：示例代码
- CHAPTER.md：本周学习内容
- Week 05/06/07 的内容：抽样分布、p 值、t 检验、ANOVA

**重要**：理解比复制更重要。如果你只是复制代码，下周的进阶内容会非常吃力。

---

**祝你好运！记住：点估计是猜测，区间估计才是诚实的科学。**
