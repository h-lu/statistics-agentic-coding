# Week 05 作业：从"算数"到"量化不确定性"

**本周作业目标**：用模拟建立概率直觉，理解抽样分布和不确定性量化，学会用 Bootstrap 方法估计标准误和置信区间。

**数据集**：使用 `starter_code/week_05_data.csv`（A/B 测试模拟数据，包含两个渠道的用户转化数据）

---

## 基础题（必做）

### 1. 模拟抛硬币实验（25 分）

**任务**：用模拟理解"随机性"和"长期频率"。

**要求**：
1. 模拟抛硬币 10 次，记录正面次数
2. 模拟抛硬币 1000 次，记录正面次数和比例
3. 重复"抛 100 次"这个实验 1000 次，画出正面次数的分布直方图
4. 回答：为什么重复很多次后，正面比例会接近 50%？这是哪条统计学原理的体现？

**输入示例**：
```python
# 设定参数
n_flips = 100  # 每次实验抛多少次
n_simulations = 1000  # 重复多少次实验
```

**输出示例**：
```markdown
## 1. 模拟抛硬币实验

### 单次实验结果
- 抛 10 次：正面 6 次（60%）
- 抛 1000 次：正面 503 次（50.3%）

### 重复 1000 次"每次抛 100 次"的分布
- 正面次数均值：50.0
- 正面次数标准差：5.0
- 95% 的结果落在：[40, 60] 之间

### 原理解释
重复很多次后，正面比例接近 50% 体现了**大数定律**：当重复次数足够多时，样本均值会趋近于真实概率。单次实验可能有较大波动，但大量实验的平均值会稳定在期望值附近。
```

**常见错误**：
- 没有固定随机种子（`np.random.seed()`），结果不可复现
- 混淆"单次实验"和"重复实验"
- 没有画出分布直方图，只报告了均值

---

### 2. 计算抽样分布（30 分）

**任务**：从同一总体重复抽样，观察样本均值如何形成分布。

**数据字段说明**：
- `channel`：渠道（A 或 B）
- `converted`：是否转化（0/1）
- `revenue`：消费金额（美元）

**要求**：
1. 假设 A 渠道的真实转化率是 10%，模拟 1000 次实验
2. 每次实验抽取 1000 个用户，计算样本转化率
3. 画出这 1000 个样本转化率的分布直方图
4. 计算这个分布的均值和标准差（标准误）
5. 回答：如果某次实验得到 12% 的转化率，这是否可能是随机波动？

**输出示例**：
```markdown
## 2. 抽样分布模拟

### 模拟设定
- 真实转化率：10%
- 样本量：1000 用户/实验
- 重复次数：1000 次

### 抽样分布统计量
- 样本转化率均值：10.02%（接近真实值）
- 样本转化率标准误：0.95%

### 观察到的 12% 在分布中的位置
- 12% 距离均值约 2.1 个标准误
- 大约 98.2% 的实验结果低于 12%

### 结论
12% 的转化率在抽样分布中处于右边缘（约前 1.8%），不太可能是随机波动。但需要考虑：如果检验了多个假设，假阳性风险会增加（见 Week 07 多重比较校正）。
```

**常见错误**：
- 没有说明"抽样分布"的概念
- 混淆"标准差"和"标准误"
- 没有量化"12% 是罕见还是常见"（如计算百分位）

---

### 3. 使用 Bootstrap 估计标准误（35 分）

**任务**：用 Bootstrap 方法估计真实数据的标准误和置信区间。

**要求**：
1. 读取 `week_05_data.csv`，计算 A 渠道和 B 渠道的转化率差异
2. 用 Bootstrap 方法（1000 次重采样）估计这个差异的标准误
3. 计算 95% 置信区间
4. 画出 Bootstrap 分布直方图，标注观察值和置信区间
5. 写出结论：差异是否显著？（注意：这是基于置信区间的初步判断，正式检验需要 Week 06 的假设检验）

**输入示例**：
```text
channel,converted,revenue
A,1,120
A,0,0
B,1,85
B,0,0
...
```

**输出示例**：
```markdown
## 3. Bootstrap 不确定性量化

### 观察到的统计量
- A 渠道转化率：12.0%（120/1000）
- B 渠道转化率：9.0%（90/1000）
- **差异：3.0%**

### Bootstrap 结果（1000 次重采样）
- 标准误：1.2%
- 95% 置信区间：[0.6%, 5.4%]

### 结论
置信区间不包含 0，表明 A 渠道转化率显著高于 B 渠道。但我们仍需要注意：
1. 这是基于当前样本的估计，不同样本可能得到不同结果
2. 如果检验了多个假设，需要考虑多重比较校正
3. 建议用正式的假设检验验证（Week 06）
```

**常见错误**：
- Bootstrap 没有使用"有放回抽样"（`replace=True`）
- 混淆"标准差"和"标准误"
- 误读置信区间（95% CI 的正确解释是："如果重复抽样 100 次，95 次的区间会包含真实值"）
- 没有固定随机种子，结果不可复现

---

## 进阶题（选做）

### 4. 验证中心极限定理（15 分）

**任务**：用模拟验证中心极限定理（CLT）。

**要求**：
1. 生成一个高度右偏的分布（如指数分布）
2. 分别取样本量 n=1, 5, 30, 100，重复抽样 1000 次
3. 画出不同样本量下的样本均值分布
4. 回答：样本量多大时，样本均值的分布接近正态？

**输出示例**：
```markdown
## 4. 中心极限定理验证

### 总体分布
- 分布类型：指数分布（高度右偏）
- 均值：1.0
- 标准差：1.0

### 样本均值分布随样本量的变化
| 样本量 n | 分布形状 | 与正态拟合度 |
|---------|---------|-------------|
| 1       | 右偏     | 差          |
| 5       | 略微对称 | 中等        |
| 30      | 接近钟形 | 好          |
| 100     | 钟形     | 很好        |

### 结论
当样本量 n=30 时，样本均值的分布已经接近正态分布。这验证了中心极限定理：无论总体分布是什么形状，样本量足够大时，样本均值的分布近似正态。
```

---

### 5. 比较不同样本量的 Bootstrap 置信区间（15 分）

**任务**：探索样本量如何影响置信区间的宽度。

**要求**：
1. 从 A 渠道数据中分别抽取 100、500、1000、2000 个用户
2. 对每个样本量做 Bootstrap，计算差异的 95% 置信区间
3. 画出"样本量 vs 置信区间宽度"的折线图
4. 回答：样本量增加时，置信区间宽度如何变化？这说明了什么？

**输出示例**：
```markdown
## 5. 样本量与置信区间宽度

### 不同样本量的置信区间
| 样本量 | 标准误 | 95% CI 下限 | 95% CI 上限 | CI 宽度 |
|--------|--------|------------|------------|---------|
| 100    | 3.8%   | -4.5%      | 10.5%      | 15.0%   |
| 500    | 1.7%   | -0.3%      | 6.3%       | 6.6%    |
| 1000   | 1.2%   | 0.6%       | 5.4%       | 4.8%    |
| 2000   | 0.8%   | 1.4%       | 4.6%       | 3.2%    |

### 结论
样本量增加时，标准误减小，置信区间变窄。这说明：**更大的样本量带来更精确的估计**。但注意：样本量从 100 增加到 1000 时，精度提升明显；从 1000 到 2000 时，提升幅度减小（边际收益递减）。
```

---

## 挑战题（加分）

### 6. 用 Bootstrap 比较两组差异（20 分）

**任务**：设计一个完整的 Bootstrap 分析流程，比较两组数据的差异。

**数据**：`starter_code/week_05_challenge.csv`（包含 `group` 列和多个数值列）

**要求**：
1. 对每个数值列，计算两组差异的 Bootstrap 置信区间
2. 识别哪些变量的差异是"显著的"（置信区间不包含 0）
3. 画出 Bootstrap 分布对比图（多子图）
4. 写出分析报告，说明：
   - 哪些变量有显著差异？
   - 这些差异的业务含义是什么？
   - 需要注意哪些局限？

**输出示例**：
```markdown
## 6. Bootstrap 两组比较

### 方法
对每个数值变量：
1. 计算两组均值差异
2. Bootstrap 1000 次，得到差异分布
3. 计算 95% 置信区间
4. 判断是否显著（CI 是否包含 0）

### 结果汇总
| 变量         | Group A 均值 | Group B 均值 | 差异  | 95% CI          | 显著性 |
|-------------|-------------|-------------|-------|-----------------|--------|
| revenue     | 120.5       | 95.2        | 25.3  | [15.2, 35.4]    | ✅     |
| time_on_site| 320         | 280         | 40    | [-10, 90]       | ❌     |
| visit_count | 4.2         | 5.1         | -0.9  | [-1.5, -0.3]    | ✅     |

### 发现
1. **revenue 有显著差异**：Group A 的平均消费比 Group B 高 25.3 美元
2. **visit_count 有显著差异**：Group B 的访问次数比 Group A 高
3. **time_on_site 无显著差异**：虽然 Group A 平均多停留 40 秒，但置信区间包含 0

### 业务含义
[你的解释...]

### 局限
1. Bootstrap 假设样本代表性，如果样本有偏差，结论不可靠
2. 多变量比较需要考虑多重比较校正
3. 需要进一步验证：差异是由哪些因素驱动的？
```

**评分点**：
- Bootstrap 实现正确（5 分）
- 结果可视化清晰（5 分）
- 结论解释合理（5 分）
- 讨论了局限性（5 分）

---

### 7. 设计多重比较校正实验（10 分）

**任务**：模拟假阳性场景，理解多次检验的风险。

**要求**：
1. 假设真实没有任何差异（所有变量的真实差异都是 0）
2. 模拟检验 10 个变量，每个变量都用 Bootstrap 判断显著性
3. 重复这个"实验" 1000 次，统计"至少出现 1 个假阳性"的概率
4. 尝试 Bonferroni 校正（将 α 从 0.05 调整为 0.05/10 = 0.005），重新计算假阳性概率。具体操作：将判断标准从 p < 0.05 改为 p < 0.005，然后重复步骤 3，统计"至少出现 1 个假阳性"的概率
5. 写出结论：Bonferroni 校正如何影响假阳性率和假阴性率？

**输出示例**：
```markdown
## 7. 多重比较与假阳性

### 实验设定
- 真实差异：0（所有变量）
- 检验变量数：10 个
- 显著性水平：α = 0.05
- 重复次数：1000 次

### 假阳性概率
- 未校正：39.5% 的实验至少出现 1 个假阳性
- Bonferroni 校正（α' = 0.005）：5.2% 的实验至少出现 1 个假阳性

### 结论
检验 10 个假设时，即使真实无差异，仍有约 40% 的概率出现至少 1 个假阳性。Bonferroni 校正将假阳性概率降回约 5%，但代价是：**更难发现真实差异**（假阴性率增加）。

### 权衡
- 保守策略（Bonferroni）：避免假阳性，但可能漏掉真实发现
- 激进策略（不校正）：发现更多模式，但可能有大量假阳性
- 实践建议：预先确定主要假设，只对主要假设做严格校正
```

---

## AI 协作练习（可选）

> **注意**：Week 05 处于"识别期"，本练习是可选的。如果你选择完成，请记住：**审查 AI 输出比使用 AI 生成更重要**。

### 任务：审查 AI 生成的统计结论

假设你让某个 AI 工具分析 `week_05_data.csv`，它给出了以下结论：

```markdown
## AI 生成的分析结论

1. **A 渠道转化率显著高于 B 渠道**（差异：3.0%, p < 0.001），建议将全部预算投入 A 渠道。

2. **A 渠道的用户价值更高**（平均消费：120.5 美元 vs 95.2 美元，差异显著），说明 A 渠道吸引的是高价值用户。

3. **Bootstrap 分析显示差异的 95% 置信区间为 [0.6%, 5.4%]**，这意味着我们有 95% 的把握认为真实差异在这个范围内。

4. **重复实验 1000 次，99.8% 的结果显示 A 渠道优于 B 渠道**，因此结论非常可靠。

5. **建议立即停止 B 渠道投放**，将 100% 预算分配给 A 渠道。
```

**请审查这段结论**，回答以下问题：

**审查清单**：
- [ ] **数字正确吗？** 用你自己的代码验证转化率、差异、置信区间
- [ ] **p 值报告了吗？** AI 声称 p < 0.001，但没有说明用了什么检验方法
- [ ] **因果表述合理吗？** AI 是否把"相关"当成了"因果"？停止 B 渠道是否草率？
- [ ] **置信区间解释正确吗？** "95% 的把握"是否是准确的解释？
- [ ] **业务建议有问题吗？** 100% 预算投入 A 渠道是否忽视了风险？
- [ ] **有没有遗漏的假设？** 样本代表性、时间稳定性、成本等因素是否考虑？

**提交内容**：
1. 指出至少 3 个 AI 结论中的问题
2. 给出改进后的结论（用你自己的话）
3. 说明你学到了什么（关于 AI 辅助统计分析的局限性）

**输出示例**：
```markdown
## AI 结论审查

### 问题 1：缺乏不确定性量化的细节
**AI 原文**："p < 0.001"
**问题**：没有说明检验方法和假设前提（如样本量、是否独立）
**改进**："使用 Bootstrap 方法（1000 次重采样），95% 置信区间为 [0.6%, 5.4%]。由于区间不包含 0，差异可能具有统计显著性。但仍需用正式的假设检验验证（Week 06）。"

### 问题 2：将相关当因果
**AI 原文**："建议将全部预算投入 A 渠道"
**问题**：观察到的差异可能是其他因素导致的（如渠道用户特征不同），不能直接推断"投入 A 渠道就能提升效果"
**改进**："A 渠道的转化率更高，但需要进一步验证：这是否由渠道本身导致，还是用户选择偏差？建议用随机对照试验验证因果关系。"

### 问题 3：置信区间解释不准确
**AI 原文**："95% 的把握认为真实差异在这个范围内"
**问题**：这是常见的误读。95% 置信区间的正确解释是："如果重复抽样 100 次，95 次的区间会包含真实值"。而不是"真实值有 95% 的概率落在区间内"。
**改进**："95% 置信区间 [0.6%, 5.4%] 表示：在重复抽样中，95% 的区间会包含真实差异。当前区间不包含 0，表明差异不太可能是 0。"

### 问题 4：忽视了业务风险
**AI 原文**："建议立即停止 B 渠道投放"
**问题**：100% 预算投入 A 渠道忽视了分散风险的重要性，而且 B 渠道可能有其他价值（如新用户获取、品牌曝光）
**改进**："A 渠道当前表现更好，建议增加 A 渠道预算占比（如从 50% 提升到 70%），同时保留 B 渠道用于测试和多样化获客。"

### 学到的东西
1. AI 能快速计算统计量和置信区间，但不会替你检查假设前提
2. AI 经常混淆"相关"和"因果"，需要人类判断因果关系
3. 置信区间的解释很容易出错，需要准确理解
4. 业务建议需要考虑更多因素（风险、成本、长期价值），AI 往往简化了这些
```

---

## 提交要求

### 文件结构
```
week_05_assignment/
├── analysis.py          # 你的分析代码
├── output/              # 生成的图表
│   ├── coin_flip_distribution.png
│   ├── sampling_distribution.png
│   ├── bootstrap_distribution.png
│   └── ...
├── report.md            # 你的分析报告
└── ai_review.md         # AI 审查报告（如果做了 AI 练习）
```

### 报告格式（report.md）
```markdown
# Week 05 作业报告

## 1. 模拟抛硬币实验
[你的分析 + 图表 + 原理解释]

## 2. 抽样分布模拟
[你的分析 + 图表 + 结论]

## 3. Bootstrap 不确定性量化
[你的分析 + 图表 + 结论]

## 4-5. 进阶题（如果完成）
[你的分析]

## 6-7. 挑战题（如果完成）
[你的完整分析报告]

## AI 协作练习（如果完成）
[你的审查报告]
```

### 评分标准
- **基础题**（90 分）：代码可运行 + 报告完整
- **进阶题**（30 分）：每题 15 分
- **挑战题**（30 分）：按评分点给分
- **AI 练习**（10 分）：按审查质量给分

**总分上限**：160 分

---

## 提示

1. **代码结构**：为每个题目写一个函数，便于测试
2. **随机种子**：在所有模拟前设置 `np.random.seed(42)`，确保结果可复现
3. **图表规范**：每个图表都要有标题、轴标签和图例
4. **报告写作**：用数字说话，每个结论都要有数据支撑
5. **时间管理**：先完成基础题，再考虑进阶和挑战
6. **概念理解**：本周重点是理解"不确定性"，不要只追求计算正确

---

## 参考资源

- 如果你遇到困难，可以参考 `starter_code/solution.py` 中的示例代码（**不要直接复制**）
- Numpy 随机抽样文档：https://numpy.org/doc/stable/reference/random/index.html
- Matplotlib 可视化指南：https://matplotlib.org/stable/gallery/index.html

---

**最后提醒**：本周开始进入"识别期"，重点是**建立统计直觉，学会审视 AI 的统计结论**。AI 可以帮你计算，但判断必须由你来做。
