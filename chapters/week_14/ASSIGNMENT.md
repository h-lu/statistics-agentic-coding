# Week 14 作业：贝叶斯视角——从"p 值游戏"到"信念更新"

> "频率学派问'如果重复无限次实验，结果会怎样'；贝叶斯学派问'根据我现在知道的一切，我相信什么'。"
> — 改编自 Andrew Gelman

## 作业概述

本周作业将带你完成一个完整的**贝叶斯分析流程**：从理解贝叶斯定理，到选择先验分布，再到计算后验分布，最后进行先验敏感性分析。

你将使用**电商客户流失数据**，回答核心问题：**"流失率有多高？我有 95% 的把握它落在什么范围？"**——这是贝叶斯学派能直接回答，而频率学派很难回答的问题。

---

## 基础层（必做）

### 任务 1：贝叶斯定理——手动计算后验分布

小北本周遇到了一个真实的业务问题：公司想知道流失率是多少。

他收集了 1000 个客户的数据，发现 180 个流失。于是告诉业务方："**流失率是 18%**"。

老潘看了一眼，问了一个问题："**你能告诉我，流失率有 95% 的概率在什么范围吗？**"

小北想了想，用频率学派的方法计算了置信区间。但老潘说："**频率学派的置信区间不能说'参数有 95% 的概率在这个区间里'。你想回答的问题，需要贝叶斯方法**。"

**你的任务**：

1. 回答以下问题，区分频率学派和贝叶斯学派：
   - 频率学派的 95% 置信区间是什么意思？
   - 贝叶斯学派的 95% 可信区间是什么意思？
   - p 值是"原假设成立的概率"吗？如果不是，那是什么？

2. 使用贝叶斯定理计算流失率的后验分布：
   - 先验：市场部认为流失率约 15%，用 Beta(15, 85) 表示
   - 数据：1000 个客户中 180 个流失
   - 计算：后验分布、后验均值、95% 可信区间

**输入示例**（仅供参考格式）：

```
问题 1：频率学派 vs 贝叶斯学派

频率学派的 95% 置信区间：
- 解释：如果重复抽样 100 次，约 95 个区间会包含真实参数
- 不能说："参数有 95% 的概率在这个区间里"
- 为什么：在频率学派看来，参数是固定的，区间是随机的

贝叶斯学派的 95% 可信区间：
- 解释：给定数据，参数落在 [a, b] 的概率是 95%
- 可以说："流失率有 95% 的概率在 [16.2%, 19.8%] 之间"
- 为什么：在贝叶斯学派看来，参数是随机变量（有分布）

p 值是什么？
- p 值是 P(data|H0)，不是 P(H0|data)
- 即：在原假设成立时，观察到当前数据或更极端数据的概率
- 不是：原假设成立的概率

问题 2：贝叶斯定理计算

先验：Beta(15, 85) -> 均值 15%
数据：n=1000, churned=180

后验：Beta(15+180, 85+820) = Beta(195, 905)
后验均值 = 195 / (195+905) = 17.7%
95% 可信区间 = [15.4%, 20.1%]

解释：
- 先验 15% 被"数据"18% 拉向中间
- 后验 17.7% 是先验和数据的"折中"
```

**提交物**：
- 一段文字（400-600 字）回答上述问题
- 用自己的话解释频率学派和贝叶斯学派的核心区别

**评分点**：
- [ ] 正确解释了置信区间和可信区间的区别
- [ ] 正确解释了 p 值的含义（不是原假设成立的概率）
- [ ] 正确计算了后验分布（使用 Beta-Binomial 共轭先验）
- [ ] 用自己的话，不是复制粘贴

**常见错误**：
- 认为 p 值是"原假设成立的概率"
- 认为频率学派的置信区间可以解释为"参数有 95% 的概率在这个区间里"
- 混淆先验、似然、后验的关系
- 忘记"后验 = 先验 × 似然"的核心公式

---

### 任务 2：先验分布的选择——信息性先验 vs 无信息先验

阿码本周最大的困惑是："**我到底该用什么先验？这不是主观猜测吗？**"

老潘的答案是："**先验必须明确，这不等于'主观'。频率学派也有先验——只是隐藏在模型选择、检验方法里。贝叶斯学派只是把先验明确写出来**。"

**你的任务**：

1. 为流失率问题选择三个先验：
   - 无信息先验：表示"我对流失率一无所知"
   - 弱信息先验：表示"我有一些倾向，但数据可以改变我的想法"
   - 信息性先验：表示"基于历史数据，我有较强信心"

2. 用文字解释每个先验的 Beta 参数和含义

3. 回答：如果数据量很小（n=50），先验的选择会对后验产生什么影响？

**输入示例**（仅供参考格式）：

```
先验 1：无信息先验
- 参数：Beta(1, 1)
- 含义：均匀分布，任何值都可能
- 使用场景：没有任何历史数据时

先验 2：弱信息先验
- 参数：Beta(5, 20)
- 均值：5/(5+20) = 20%
- 方差：较大
- 含义：我认为流失率约 20%，但不确定
- 使用场景：有一些趋势信息，但不强

先验 3：信息性先验
- 参数：Beta(150, 850)
- 均值：150/(150+850) = 15%
- 方差：较小
- 含义：基于 1000 个历史客户的数据，流失率约 15%
- 使用场景：有可靠的历史数据

数据量小时的先验影响：
- 当 n=50（数据少），先验对后验的影响更大
- 强先验会"主导"后验，数据很难"修正"它
- 这时需要做先验敏感性分析，看结论是否稳健
```

**提交物**：
- 一段文字（400-600 字）解释三个先验的选择和含义
- 回答数据量小时先验的影响

**评分点**：
- [ ] 正确区分了无信息、弱信息、信息性先验
- [ ] 选择了合理的 Beta 参数
- [ ] 解释了每个先验的含义和使用场景
- [ ] 理解数据量对先验-后验关系的影响

**常见错误**：
- 认为"无信息先验"就是"没有假设"——"完全无知"也是一种假设
- 信息性先验的"等价样本量"（alpha+beta）太小，导致不真实的"强先验"
- 没有理解"数据最终会战胜先验"的性质

---

### 任务 3：后验分布的可视化——理解"信念更新"

老潘说："**贝叶斯方法最美妙的地方，是你可以'看到'信念如何被数据更新**。"

**你的任务**：

1. 用 Python 绘制先验分布、后验分布
2. 标注后验均值和 95% 可信区间
3. 用文字解释：先验是如何被数据"更新"的？

**输入示例**（仅供参考格式）：

```python
import numpy as np
import matplotlib.pyplot as plt
from scipy import stats
from pathlib import Path

# 参数
alpha_prior, beta_prior = 15, 85  # 先验
n, churned = 1000, 180            # 数据

# 后验
alpha_post = alpha_prior + churned
beta_post = beta_prior + (n - churned)

# 绘图
theta = np.linspace(0.05, 0.30, 500)

plt.figure(figsize=(10, 6))
plt.plot(theta, stats.beta.pdf(theta, alpha_prior, beta_prior),
         label=f'先验 Beta({alpha_prior}, {beta_prior})', linewidth=2)
plt.plot(theta, stats.beta.pdf(theta, alpha_post, beta_post),
         label=f'后验 Beta({alpha_post}, {beta_post})', linewidth=2)

# 标注后验均值
posterior_mean = alpha_post / (alpha_post + beta_post)
plt.axvline(posterior_mean, color='red', linestyle='--',
            label=f'后验均值 = {posterior_mean:.1%}')

# 标注 95% 可信区间
ci_low, ci_high = stats.beta.interval(0.95, alpha_post, beta_post)
plt.axvline(ci_low, color='gray', linestyle=':', alpha=0.7)
plt.axvline(ci_high, color='gray', linestyle=':', alpha=0.7,
            label=f'95% 可信区间 = [{ci_low:.1%}, {ci_high:.1%}]')

plt.xlabel('流失率 θ', fontsize=12)
plt.ylabel('概率密度', fontsize=12)
plt.title('先验分布与后验分布', fontsize=14)
plt.legend()
plt.tight_layout()

Path('output').mkdir(exist_ok=True)
plt.savefig('output/14_prior_posterior.png', dpi=150)
```

**提交物**：
- 代码
- 先验和后验分布的可视化图
- 一段文字解释"信念更新"的过程（200-300 字）

**评分点**：
- [ ] 代码可以运行
- [ ] 图表清晰标注了先验、后验、后验均值、可信区间
- [ ] 解释了先验如何被数据"更新"

**常见错误**：
- 没有标注图例，无法区分先验和后验
- x 轴范围不合适（如从 0 到 1，导致曲线看不清楚）
- 没有解释"信念更新"的含义

---

## 进阶层（推荐完成）

### 任务 4：用 PyMC 进行 MCMC 采样

小北本周学会了 Beta-Binomial 共轭先验的解析解。但他问："**如果先验和似然不是共轭的，怎么算后验？**"

老潘的答案是："**MCMC 采样**。这是一种通过采样来近似后验分布的方法。"

**你的任务**：

1. 安装 PyMC：`pip install pymc arviz`
2. 用 PyMC 重新计算流失率的后验分布
3. 检查 MCMC 收敛性（R-hat、ESS）
4. 绘制后验分布和迹图

**输入示例**：

```python
import pymc as pm
import arviz as az
import numpy as np

# 数据
n = 1000
churned = 180

# 定义贝叶斯模型
with pm.Model() as churn_model:
    # 先验：Beta(15, 85) -> 均值 15%
    theta = pm.Beta('theta', alpha=15, beta=85)

    # 似然：Binomial(n, theta)
    likelihood = pm.Binomial('likelihood', n=n, p=theta, observed=churned)

    # MCMC 采样
    trace = pm.sample(2000, tune=1000, chains=4, random_seed=42)

# 检查收敛性
print(f"R-hat: {az.rhat(trace).theta.values:.4f}")
print(f"ESS: {az.ess(trace).theta.values:.0f}")

# 绘制后验分布
az.plot_posterior(trace, var_names=['theta'])

# 绘制迹图
az.plot_trace(trace, var_names=['theta'])
```

**输出示例**：
```
R-hat: 1.0003 (< 1.05 表示收敛)
ESS: 4521 (> 400 表示样本量足够)
```

**提交物**：
- 代码
- R-hat 和 ESS 的值
- 后验分布图和迹图
- 一段文字解释：如何判断 MCMC 是否收敛？

**评分点**：
- [ ] 正确使用了 PyMC 进行 MCMC 采样
- [ ] 检查了收敛性（R-hat、ESS）
- [ ] 绘制了后验分布和迹图
- [ ] 解释了如何判断 MCMC 是否收敛

**加分项**：
- 尝试了不同的先验，比较后验分布
- 计算了 P(θ > 0.15 | data)——流失率大于 15% 的后验概率

---

### 任务 5：先验敏感性分析——如果先验变了，结论会怎样？

阿码本周最后的问题是："**如果我用了'错误'的先验怎么办？**"

老潘的答案是："**做先验敏感性分析**。尝试多个合理的先验，比较后验的差异。"

**你的任务**：

1. 定义三个先验：无信息、弱信息、信息性
2. 计算每个先验的后验分布
3. 比较后验均值和 95% 可信区间
4. 回答：结论对先验敏感吗？

**输入示例**：

```python
import numpy as np
from scipy import stats

# 数据
n = 1000
churned = 180

# 三个先验
priors = {
    '无信息': (1, 1),      # Beta(1, 1) -> 均匀分布
    '弱信息': (5, 20),     # Beta(5, 20) -> 均值 20%，方差大
    '信息性': (150, 850),  # Beta(150, 850) -> 均值 15%，方差小
}

# 计算后验
results = {}
for name, (alpha, beta) in priors.items():
    alpha_post = alpha + churned
    beta_post = beta + (n - churned)
    posterior_mean = alpha_post / (alpha_post + beta_post)
    ci = stats.beta.interval(0.95, alpha_post, beta_post)
    results[name] = {
        '后验均值': posterior_mean,
        '95% CI': ci
    }

# 打印结果
for name, res in results.items():
    print(f"{name}: 均值 = {res['后验均值']:.3f}, "
          f"95% CI = [{res['CI'][0]:.3f}, {res['CI'][1]:.3f}]")

# 计算后验均值的差异
posterior_means = [res['后验均值'] for res in results.values()]
mean_range = max(posterior_means) - min(posterior_means)
print(f"\n后验均值差异: {mean_range:.3f}")

if mean_range < 0.02:
    print("结论: 后验均值对先验选择不敏感（差异 < 2%）")
else:
    print(f"结论: 后验均值对先验选择敏感（差异 = {mean_range:.1%}）")
```

**输出示例**：
```
无信息: 均值 = 0.180, 95% CI = [0.156, 0.206]
弱信息: 均值 = 0.178, 95% CI = [0.155, 0.203]
信息性: 均值 = 0.174, 95% CI = [0.152, 0.196]

后验均值差异: 0.006
结论: 后验均值对先验选择不敏感（差异 < 2%）
```

**提交物**：
- 代码
- 三个先验的后验比较表
- 一段文字解释：结论对先验是否敏感？为什么？

**评分点**：
- [ ] 定义了三个不同的先验
- [ ] 计算了每个先验的后验分布
- [ ] 比较了后验的差异
- [ ] 解释了结论对先验是否敏感

---

## 挑战层（可选）

### 任务 6：贝叶斯 A/B 测试——"B 变体更好的概率是多少？"

老潘在公司最近做了一个 A/B 测试：两个注册页面（A 和 B），想知道哪个更好。

**你的任务**：

1. 设计一个贝叶斯 A/B 测试
2. 计算：P(转化率_B > 转化率_A | data) —— B 比 A 好的概率
3. 计算预期损失（Expected Loss）：如果选错了，会损失多少？
4. 用业务语言向非技术读者解释结果

**输入示例**（仅供参考格式）：

```
数据：
- A 页面：1000 访问，120 转化（转化率 12%）
- B 页面：1000 访问，150 转化（转化率 15%）

先验（两个页面使用相同的弱信息先验）：
- Beta(5, 20) -> 均值 20%，方差大

后验：
- A: Beta(5+120, 20+880) = Beta(125, 900)
- B: Beta(5+150, 20+850) = Beta(155, 870)

问题 1：P(转化率_B > 转化率_A | data) = ?
方法：从两个后验分布中采样，计算 P(θ_B > θ_A)

问题 2：预期损失 = ?
方法：如果选择 B 但 A 更好，平均会损失多少转化率？

业务解释：
- "B 比 A 好的概率是 92%"
- "如果选错了，预期损失 0.3% 的转化率"
- "建议：推全 B"
```

**提交物**：
- 代码
- P(θ_B > θ_A | data) 的值
- 预期损失的值
- 一段业务解释（200-300 字）

**评分点**：
- [ ] 正确使用了贝叶斯 A/B 测试方法
- [ ] 计算了 P(θ_B > θ_A | data)
- [ ] 计算了预期损失
- [ ] 用业务语言解释结果

---

## AI 协作练习（可选，主导期）

下面这段文字是某个 AI 工具生成的"贝叶斯分析结论"：

> "我们使用贝叶斯方法分析了流失率。结果显示，流失率的 posterior mean 是 17.7%，95% credible interval 是 [15.4%, 20.1%]。由于 credible interval 不包含 15%，我们拒绝原假设，认为流失率显著高于 15%。因此，建议公司立即采取挽留措施。"

**审查清单**：
- [ ] 它说明了先验是什么吗？（"无信息"？"信息性"？）
- [ ] 它区分了"后验概率"和"p 值"吗？（有没有说"拒绝原假设"？）
- [ ] 它做了先验敏感性分析吗？（结论对先验敏感吗？）
- [ ] 它正确解释了可信区间吗？（可信区间不是用来"拒绝原假设"的）
- [ ] "立即采取挽留措施"——这个建议有成本收益分析吗？

**你的修订版**（用你自己的话写，修正上述问题）：

```
例如："AI 的结论有几个问题：第一，没有说明先验是什么（无信息还是信息性？）。第二，说'拒绝原假设'是频率学派的语言，贝叶斯方法不'拒绝'，而是计算后验概率。第三，'立即采取挽留措施'没有考虑成本——挽留措施的成本可能大于流失带来的损失。修订版应该明确：先验假设是什么、后验分布是什么、P(θ > 15% | data) 是多少、结论对先验是否敏感、成本收益如何。"
```

**提交物**：
- 审查清单（勾选哪些问题存在）
- 你的修订版（3-5 句话）

---

## StatLab 本周任务

老潘说："**StatLab 报告需要升级——从'频率学派报告'到'贝叶斯报告'**。"

**你的任务**：

1. **定义先验分布**：
   - 无信息先验：Beta(1, 1)
   - 市场部先验：基于历史数据的 Beta 分布
   - 产品部先验：基于最近趋势的 Beta 分布

2. **计算后验分布**：
   - 后验均值
   - 95% 可信区间
   - P(θ > 阈值 | data) —— 流失率大于某个阈值的后验概率

3. **先验敏感性分析**：
   - 比较不同先验的后验
   - 结论对先验是否敏感？

4. **与频率学派对比**：
   - 频率学派的点估计和置信区间
   - 贝叶斯学派的后验均值和可信区间
   - 两种方法能回答什么问题？

**StatLab 模板**（仅供参考格式）：

```markdown
## 贝叶斯分析：流失率估计

### 数据概览
- 样本量: n
- 流失数: churned
- 观测流失率: x%

### 先验假设（不同部门）
| 先验名称 | Beta 参数 | 均值 |
|---------|----------|------|
| 无信息 | Beta(1, 1) | 50% |
| 市场部 | Beta(?, ?) | ?% |
| 产品部 | Beta(?, ?) | ?% |

### 后验分布比较
| 先验 | 后验均值 | 95% 可信区间 |
|------|---------|-------------|
| 无信息 | ?% | [?%, ?%] |
| 市场部 | ?% | [?%, ?%] |
| 产品部 | ?% | [?%, ?%] |

### 先验敏感性分析
**结论**: 后验均值对先验选择 [不敏感/敏感]（差异 = ?%），[当前数据足够强/需要更多数据]。

### 与频率学派对比
- 频率学派点估计: ?%
- 频率学派 95% 置信区间: [?%, ?%]
- 贝叶斯后验均值（市场部先验）: ?%
- 贝叶斯 95% 可信区间（市场部先验）: [?%, ?%]

**解释**: 频率学派的置信区间不能说"参数有 95% 的概率在这个区间里"，但贝叶斯的可信区间可以这样解释。

### 我们能回答什么
| 问题 | 频率学派 | 贝叶斯学派 |
|------|---------|-----------|
| 流失率是多少？ | 点估计：?% | 后验均值：?% |
| 流失率的范围？ | 95% CI：但不是"概率" | 95% 可信区间：参数有 95% 的概率在此区间 |
| 流失率 > 15% 吗？ | p < 0.05，显著 | P(θ > 15% | data) ≈ ?% |
```

**提交物**：
- 更新后的 StatLab 报告
- 贝叶斯分析的可视化图

---

## 提交检查清单

在提交作业前，请确认：

- [ ] 代码可以运行（或注明哪些部分是伪代码）
- [ ] 输出结果包含在提交中（或截图）
- [ ] 分析部分用你自己的话写（不是复制粘贴）
- [ ] 正确区分了 p 值和后验概率
- [ ] 正确区分了置信区间和可信区间
- [ ] 进行了先验敏感性分析
- [ ] 如果遇到困难，参考了 `starter_code/solution.py`，请说明参考了哪些部分

---

## 提示与帮助

如果你在完成作业时遇到困难：

1. 回顾 CHAPTER.md 中的示例代码
2. 参考本周的 StatLab 示例（`examples/14_bayesian_analysis.py`）
3. 查阅 PyMC 官方文档：https://www.pymc.io/welcome.html
4. 如果你对 Beta 分布的参数不熟悉，可以参考 `starter_code/solution.py`（但不要直接复制）

**记住**：作业的目的是巩固理解，不是完美复制代码。即使遇到困难，也要尝试用自己的话解释问题和思路。

---

祝你本周学习愉快！记住老潘的话：**"贝叶斯方法不是'频率学派的替代品'，而是'另一种思维方式'。频率学派回答'差异显著吗'，贝叶斯学派回答'我相信什么'。两者都是工具，取决于你想回答什么问题。"**
