# Week 14 作业：贝叶斯视角实战

## 作业概述

本周作业将帮助你从"频率学派的 p 值游戏"升级到"贝叶斯学派的信念更新"。通过 5 个基础习题和 2 个进阶习题，你会：

1. 理解频率学派与贝叶斯学派的核心差异（置信区间 vs 可信区间）
2. 学会合理设定先验（无信息、弱信息、强信息）
3. 用 PyMC 实现贝叶斯 A/B 测试，得到决策友好的结论
4. 掌握 MCMC 收敛诊断（trace plot、R-hat、ESS）
5. 在 StatLab 报告中添加贝叶斯章节

**提交格式**：提交一个 Jupyter Notebook 或 Python 脚本（`week14_assignment.py`）+ 分析报告（`week14_report.md`）。

---

## 基础作业（必做）

### 习题 1：频率学派 vs 贝叶斯学派（10 分）

**场景**：产品经理问你："A 版本转化率 5.2%，B 版本 5.8%，t 检验 p=0.08。那 B 比 A 好吗？"

#### 任务

1. **解释两种答案的差异**（5 分）
   - 频率学派会如何回答？（用 p 值和显著性表述）
   - 贝叶斯学派会如何回答？（用概率陈述表述）
   - 为什么产品经理更喜欢贝叶斯的答案？

2. **置信区间 vs 可信区间**（5 分）
   - 用你自己的话解释：频率学派的 95% 置信区间是什么意思？
   - 用你自己的话解释：贝叶斯学派的 95% 可信区间是什么意思？
   - 给一个具体例子说明决策者如何使用这两种区间

**输入**：
- A 版本：1000 次曝光，52 次转化
- B 版本：1000 次曝光，58 次转化

**输出要求**：
- 一段 200-300 字的对比解释（Markdown 格式）
- 可以用公式或伪代码辅助说明

**评分点**：
- [ ] 正确区分两种范式的问题框架（重复抽样 vs 信念更新）
- [ ] 准确解释置信区间（不是"参数在区间内的概率"）
- [ ] 准确解释可信区间（"参数在区间内的概率"）
- [ ] 说明决策友好性差异（二元 vs 连续概率）

**常见错误**：
- ❌ 把置信区间解释为"参数有 95% 的概率在区间内"（这是贝叶斯的解释）
- ❌ 说"贝叶斯更好"而没有说明适用场景
- ❌ 混淆 p 值和"P(H0|data)"

---

### 习题 2：先验设定与敏感性（15 分）

**场景**：你的公司过去做过 50 次 A/B 测试，平均转化率 5.2%，标准差 1%。现在有一个新测试，B 版本 58/1000 转化。

#### 任务

1. **设定三种先验**（5 分）
   - **无信息先验**：让数据自己说话（提示：Beta(1, 1) = 均匀分布）
   - **弱信息先验**：编码"转化率通常在 5% 上下"但不强（提示：Beta(5, 100)）
   - **强信息先验**：基于历史数据（提示：从均值 0.052、标准差 0.01 计算 Beta 参数）

2. **计算后验分布**（5 分）
   - 用共轭先验（Beta-Binomial）计算三种先验下的后验
   - 打印后验均值和 95% 可信区间

3. **先验敏感性分析**（5 分）
   - 对比三种先验下的结果：它们是否接近？
   - 如果差异很大，说明什么？
   - 你的结论：先验选择是否影响决策？

**输入**：
```python
conversions_B = 58
exposures_B = 1000
# A 版本作为参考，可以设为先验或单独分析
```

**输出要求**：
```python
# 你的代码应输出：
=== 先验敏感性分析 ===
无信息: 均值=0.0577, 95% CI=[0.0442, 0.0722]
弱信息: 均值=0.0534, 95% CI=[0.0418, 0.0661]
强信息: 均值=0.0502, 95% CI=[0.0450, 0.0556]

结论：[你的判断]
```

**评分点**：
- [ ] 正确设定三种先验（参数合理）
- [ ] 正确计算后验（Beta 分布更新公式）
- [ ] 敏感性分析逻辑清晰（差异大 = 敏感，差异小 = 稳健）
- [ ] 结论与结果一致（不能结果差异大却说"稳健"）

**常见错误**：
- ❌ 先验参数不合理（如强信息先验的标准差比数据还大）
- ❌ 后验计算错误（忘记加 successes 和 failures）
- ❌ 敏感性分析只列数字，没有判断
- ❌ 用"数据依赖的先验"（先看数据再设先验）

**提示**：如果你遇到困难，可以参考 `starter_code/solution.py` 中的 `exercise_2` 函数。

---

### 习题 3：贝叶斯 A/B 测试（20 分）

**场景**：产品团队设计了两个版本，想知道"哪个更好"。频率学派只回答"显著/不显著"，你需要用贝叶斯方法给出决策友好的答案。

#### 任务

1. **用 PyMC 实现贝叶斯 A/B 测试**（10 分）

   要求：
   - 定义先验：两个版本的转化率 `theta_A` 和 `theta_B`（用 `pm.Uniform` 或 `pm.Beta`）
   - 定义似然：观测值服从 `pm.Binomial`
   - 定义感兴趣量：`delta = theta_B - theta_A` 和 `rel_uplift = (theta_B - theta_A) / theta_A`
   - 运行 MCMC 采样（`pm.sample`）

2. **计算关键指标**（5 分）
   - P(B 比 A 好) = P(delta > 0)
   - 提升幅度的中位数和 95% HDI
   - 打印后验摘要（用 `az.summary`）

3. **写一段决策建议**（5 分）
   - 给产品经理的建议（"B 比 A 好的概率 X%，提升幅度中位数 Y%"）
   - 决策边界：如果 P(B > A) > 90%，建议上线 B；如果 60% < P < 90%，建议继续收集数据；如果 P < 60%，建议放弃 B

**输入**：
```python
# A 版本
conversions_A = 52
exposures_A = 1000

# B 版本
conversions_B = 58
exposures_B = 1000
```

**输出要求**：
```python
# 你的代码应输出：
             mean    sd  hdi_3%  hdi_97%
theta_A    0.053  0.007    0.040     0.066
theta_B    0.059  0.007    0.046     0.073
delta      0.006  0.010   -0.012     0.024
rel_uplift  0.115  0.192   -0.226     0.466

B 比 A 好的概率: 72.8%

决策建议：[你的建议，100-150 字]
```

**评分点**：
- [ ] PyMC 模型定义正确（先验、似然、MCMC）
- [ ] 感兴趣量定义合理（delta、rel_uplift）
- [ ] 收敛诊断通过（R-hat < 1.05）
- [ ] 决策建议与结果一致（不能 P=72% 却说"强烈推荐 B"）
- [ ] 代码可运行（固定随机种子 `np.random.seed(42)`）

**常见错误**：
- ❌ 没有固定随机种子，结果不可复现
- ❌ 没有检查收敛（R-hat > 1.05 还在用结果）
- �] 决策建议与结果矛盾（P=72% 却说"放弃 B"）
- ❌ 只输出数字，没有决策建议

**提示**：如果你遇到困难，可以参考 `starter_code/solution.py` 中的 `exercise_3` 函数。

---

### 习题 4：MCMC 采样与诊断（20 分）

**场景**：你的贝叶斯模型跑出来了，但产品经理问："我怎么知道这个结果可靠？"

#### 任务

1. **实现一个简单的贝叶斯回归**（10 分）

   用 PyMC 估计"优惠券对消费的影响"：
   - 数据：`df` 包含 `coupon_used`（处理变量）、`spending`（结果变量）、`activity`（混杂变量）
   - 先验：`alpha` ~ N(0, 10)，`beta_treat` ~ N(0, 10)，`beta_conf` ~ N(0, 10)
   - 似然：`spending` ~ N(alpha + beta_treat * coupon_used + beta_conf * activity, sigma)
   - 运行 MCMC（`pm.sample(3000, tune=2000, chains=4)`）

2. **收敛诊断**（5 分）
   - 用 `az.plot_trace` 画 trace plot（检查是否像"毛毛虫"）
   - 计算 R-hat（用 `az.rhat`），确保 < 1.01
   - 计算 ESS（用 `az.ess`），确保 > 400
   - 如果 R-hat > 1.05 或 ESS < 400，尝试增加采样量

3. **解释诊断结果**（5 分）
   - trace plot 告诉你什么？（链是否混合良好？是否平稳？）
   - R-hat < 1.01 意味着什么？
   - ESS > 400 意味着什么？
   - 如果诊断失败，你会怎么做？

**输入**：
```python
# 示例数据（或用你自己的数据）
import numpy as np
import pandas as pd

np.random.seed(42)
n = 500
coupon_used = np.random.binomial(1, 0.5, n)
activity = np.random.normal(50, 10, n)
spending = 100 + 30 * coupon_used + 0.5 * activity + np.random.normal(0, 20, n)

df = pd.DataFrame({
    'coupon_used': coupon_used,
    'activity': activity,
    'spending': spending
})
```

**输出要求**：
```python
# 你的代码应输出：
=== 后验摘要 ===
             mean    sd  hdi_3%  hdi_97%
alpha       101.2   2.8   95.8    106.5
beta_treat   29.8   4.9   20.6     39.2
beta_conf     0.5   0.1    0.3      0.7
sigma        19.8   0.6   18.7     21.0

=== 收敛诊断 ===
R-hat:
  alpha: 1.0001
  beta_treat: 1.0003
  beta_conf: 1.0002
  sigma: 1.0001

ESS (bulk):
  alpha: 12400
  beta_treat: 11800
  beta_conf: 12100
  sigma: 12500

结论：[你的诊断判断，100-150 字]
```

**评分点**：
- [ ] PyMC 模型定义正确（先验、似然、MCMC）
- [ ] 收敛诊断完整（trace plot、R-hat、ESS）
- [ ] 诊断结果解释正确（不是"数字越小越好"）
- [ ] 如果诊断失败，有合理的改进措施
- [ ] 代码可运行（固定随机种子）

**常见错误**：
- ❌ 只看结果，不检查收敛
- ❌ R-hat > 1.05 还在用结果
- ❌ 把 ESS 理解为"采样次数"（它是考虑自相关后的有效样本量）
- ❌ trace plot 异常却不诊断（如多条链分离）

**提示**：如果你遇到困难，可以参考 `starter_code/solution.py` 中的 `exercise_4` 函数。

---

### 习题 5：StatLab 贝叶斯升级（20 分）

**场景**：你的 StatLab 报告已经有因果推断章节（Week 13），但所有不确定性都是频率学派的（p 值、置信区间）。产品经理问："你能给我更直观的结论吗？"

#### 任务

1. **用贝叶斯方法重新估计关键参数**（10 分）

   选择你 StatLab 报告中的一个关键参数（如"优惠券的因果效应"），用 PyMC 实现：
   - 定义先验（弱信息先验：N(0, 10)）
   - 定义似然（包含处理变量和混杂变量）
   - 运行 MCMC 采样
   - 计算后验摘要（均值、95% HDI）

2. **先验敏感性分析**（5 分）

   测试三种先验（弱信息、强信息、无信息）：
   - 它们的后验均值是否接近？
   - 95% HDI 是否重叠？
   - 你的结论是否稳健？

3. **生成贝叶斯章节报告**（5 分）

   在你的 StatLab 报告（`report/report.md`）中添加一个贝叶斯章节，包含：
   - 研究问题（参数是什么？）
   - 后验分布摘要（均值、95% HDI、P(参数 > 0)）
   - 先验敏感性分析结果
   - 与频率学派的对比（效应估计、区间估计、解释差异）
   - 结论边界（能回答什么？不能回答什么？）

**输入**：
- 你自己的 StatLab 数据集（如 `data/coupon_data.csv`）

**输出要求**：
```markdown
## 贝叶斯推断

### 研究问题
本章用贝叶斯方法回答："优惠券对消费的因果效应是什么？"

### 因果效应的后验分布

**优惠券的因果效应**（因果系数 β_treat）：

| 指标 | 估计值 |
|------|--------|
| 后验均值 | **29.8** |
| 95% HDI（可信区间） | [20.6, 39.2] |
| P(效应 > 0) | **99.9%** |

**解读**：
- 优惠券对消费的因果效应最可能值为 **29.8**
- 效应有 **99.9%** 的概率为正（即有效）
- 95% 可信区间为 [20.6, 39.2]（给定数据和先验，参数有 95% 的概率在此区间内）

### 先验敏感性分析
...（表格或文字）

### 与频率学派的对比
...（表格或文字）

### 结论边界
...（能回答的 vs 不能回答的）
```

**评分点**：
- [ ] PyMC 模型定义正确（因果推断框架）
- [ ] 先验敏感性分析完整（至少三种先验）
- [ ] 报告结构清晰（研究问题 → 后验摘要 → 对比 → 边界）
- [ ] 解释准确（可信区间 vs 置信区间）
- [ ] 结论边界明确（不夸大贝叶斯的能力）

**常见错误**：
- ❌ 没有先验敏感性分析（只用一种先验）
- �] 报告只列数字，没有解释
- ❌ 混淆置信区间和可信区间
- ❌ 没有写清结论边界（夸大贝叶斯的能力）

**提示**：如果你遇到困难，可以参考 `starter_code/solution.py` 中的 `exercise_5` 函数和 `examples/06_statlab_bayesian.py`。

---

## 进阶作业（选做）

### 习题 6：层次模型（10 分）

**场景**：你有 10 个国家的 A/B 测试数据，大样本国家（美、英）结论明确，小样本国家（德、法）无法判断。如何让小样本国家"借力"大样本国家？

#### 任务

1. **实现层次模型**（7 分）
   - 用 PyMC 定义层次模型：`theta_i ~ Beta(mu * (1-sigma) / sigma, (1-mu) * (1-sigma) / sigma)`
   - 超先验：`mu ~ Beta(1, 1)`，`sigma ~ HalfNormal(0.1)`
   - 运行 MCMC 采样
   - 打印每个国家的后验均值和 95% HDI

2. **对比非层次模型**（3 分）
   - 单独分析每个国家（非层次模型）：小样本国家的 95% CI 会很宽
   - 层次模型：小样本国家的 CI 会变窄（向全球平均收缩）
   - 解释：层次模型如何"信息共享"？

**输入**：
```python
countries = ["美国", "英国", "德国", "法国"]
conversions = np.array([580, 560, 13, 10])
exposures = np.array([10000, 10000, 200, 200])
n_countries = len(countries)
```

**输出要求**：
```python
=== 非层次模型（单独分析） ===
美国: 均值=0.0580, 95% CI=[0.0533, 0.0629]
英国: 均值=0.0560, 95% CI=[0.0514, 0.0608]
德国: 均值=0.0650, 95% CI=[0.0355, 0.1055]  # 很宽！
法国: 均值=0.0500, 95% CI=[0.0243, 0.0895]  # 很宽！

=== 层次模型（信息共享） ===
美国: 均值=0.0580, 95% CI=[0.0534, 0.0626]
英国: 均值=0.0560, 95% CI=[0.0516, 0.0605]
德国: 均值=0.0550, 95% CI=[0.0440, 0.0660]  # 变窄了！
法国: 均值=0.0540, 95% CI=[0.0430, 0.0650]  # 变窄了！

全球平均 mu: 均值=0.056, 95% CI=[0.052, 0.060]
组间差异 sigma: 均值=0.002, 95% CI=[0.001, 0.004]

解释：[你的解释，100-150 字]
```

**评分点**：
- [ ] 层次模型定义正确（超先验、先验、似然）
- [ ] 收敛诊断通过（R-hat < 1.01）
- [ ] 对比非层次模型，说明 shrinkage 效应
- [ ] 解释信息共享机制（小样本向大样本学习）

**常见错误**：
- ❌ 层次模型定义错误（忘记 shape 参数）
- ❌ 没有对比非层次模型（单独分析）
- �] 只看数字，没有解释 shrinkage

**提示**：如果你遇到困难，可以参考 `starter_code/solution.py` 中的 `exercise_6` 函数和 `examples/05_hierarchical_model.py`。

---

### 习题 7：贝叶斯回归阅读心得（5 分）

**场景**：你在知乎上看到一篇博客《贝叶斯回归 vs OLS 回归》，评论区有人说"贝叶斯就是加正则化的回归"。

#### 任务

1. **阅读以下材料**（任选一个）
   - Chapter 1 of "Bayesian Data Analysis" (Gelman et al., 2013)
   - 或：一篇关于贝叶斯回归的中文博客（需提供链接）

2. **写一段 200-300 字的心得**
   - 贝叶斯回归和 OLS 回归的核心区别是什么？
   - "贝叶斯回归就是加正则化的回归"这句话对吗？为什么？
   - 贝叶斯回归在什么场景下有优势？（小样本？需要先验知识？）

**输出要求**：
```markdown
## 贝叶斯回归阅读心得

### 材料
- 标题：...
- 链接：...

### 核心区别
...

### "贝叶斯回归就是加正则化的回归"？
...

### 贝叶斯回归的优势场景
...
```

**评分点**：
- [ ] 准确理解贝叶斯回归和 OLS 的区别（后验分布 vs 点估计）
- [ ] 正确评价"正则化"的说法（数学上等价，解释不同）
- [ ] 优势场景合理（小样本、先验知识、不确定性量化）
- [ ] 字数符合要求（200-300 字）

**常见错误**：
- ❌ 说"贝叶斯回归更准确"（没有说明场景）
- �] 否认"正则化"说法（数学上确实等价）
- �️ 列优势但不解释原因

---

## AI 协作练习（可选）

> **注意**：这是可选练习。如果你选择做，提交时请包含你的审查报告，不要直接复制 AI 输出。

### 场景

你让 AI 生成一段"贝叶斯 A/B 测试的代码和结论"。

### AI 生成的代码（故意包含问题）

```python
import pymc as pm
import numpy as np

# 数据
conversions_A = 52
exposures_A = 1000
conversions_B = 58
exposures_B = 1000

# 贝叶斯 A/B 测试
with pm.Model() as model:
    # 先验：强信息先验（假设转化率都是 5% 左右）
    # Beta(52, 948) 对应均值约 0.052，标准差约 0.007
    theta_A = pm.Beta("theta_A", alpha=52, beta=948)
    theta_B = pm.Beta("theta_B", alpha=52, beta=948)

    # 似然
    obs_A = pm.Binomial("obs_A", n=exposures_A, p=theta_A, observed=conversions_A)
    obs_B = pm.Binomial("obs_B", n=exposures_B, p=theta_B, observed=conversions_B)

    # 采样（没有收敛诊断）
    idata = pm.sample(1000, chains=1)

# 计算"B 比 A 好"的概率
theta_A_samples = idata.posterior["theta_A"].values
theta_B_samples = idata.posterior["theta_B"].values
prob_B_better = (theta_B_samples > theta_A_samples).mean()

print(f"结论：B 比 A 好的概率是 {prob_B_better:.1%}")
```

### 你的任务

审查这段代码，找出至少 3 个问题：

**审查清单**：
- [ ] 先验设定合理吗？（强信息先验 Beta(1, 100) 假设转化率 1%，是否与数据一致？）
- [ ] MCMC 设置正确吗？（只有 1 条链、没有 tune、采样量 1000 够吗？）
- [ ] 收敛诊断做了吗？（有没有检查 R-hat、trace plot？）
- [ ] 代码能运行吗？（有没有明显的 bug？）
- [ ] 结论解释正确吗？（如果先验和结论冲突，如何处理？）

**提交物**：
1. 修复后的代码（你的版本）
2. 审查报告（100-200 字）：你发现了哪些问题？为什么它们是问题？你的修复是什么？

**评分**：
- 发现并修复 3 个问题：满分（5 分）
- 发现并修复 2 个问题：3 分
- 发现并修复 1 个问题：1 分

**常见 AI 错误**：
- ❌ 先验太强（强信息先验压倒了数据）
- ❌ 采样设置不合理（链太少、采样量不够、没有 tune）
- ❌ 没有收敛诊断（R-hat、ESS）
- ❌ 直接相信 AI 输出，没有审查

---

## 提交说明

### 提交内容

1. **代码文件**（必交）
   - `week14_assignment.py` 或 `week14_assignment.ipynb`
   - 包含所有习题的代码和运行结果

2. **分析报告**（必交）
   - `week14_report.md`
   - 包含所有习题的解释、决策建议、阅读心得

3. **StatLab 更新**（必交，习题 5）
   - 更新后的 `report/report.md`
   - 添加贝叶斯章节

4. **AI 审查报告**（选交）
   - `ai_review.md`
   - 如果做了 AI 协作练习

### 提交格式

```
week_14_submission/
├── week14_assignment.py          # 或 .ipynb
├── week14_report.md
├── report/
│   └── report.md                 # 包含贝叶斯章节
├── ai_review.md                  # 可选
└── README.md                     # （可选）运行说明
```

### 运行环境

- Python 3.8+
- 依赖包：`pymc>=5.0`, `arviz>=0.16`, `numpy`, `pandas`, `scipy`, `matplotlib`

### 评分标准

详见 `RUBRIC.md`。

---

## 提示与帮助

### 如果卡住了

1. **回顾本周章节**：
   - 第 1 节：频率学派 vs 贝叶斯学派
   - 第 2 节：先验设定与敏感性
   - 第 3 节：贝叶斯更新实战
   - 第 4 节：MCMC 采样与诊断
   - 第 5 节：层次模型

2. **参考示例代码**：
   - `starter_code/solution.py`：参考实现（不要直接复制）
   - `examples/01_bayesian_ab.py`：贝叶斯 A/B 测试
   - `examples/03_bayesian_regression.py`：贝叶斯回归
   - `examples/05_hierarchical_model.py`：层次模型
   - `examples/06_statlab_bayesian.py`：StatLab 贝叶斯版本

3. **检查测试**：
   - 运行 `pytest chapters/week_14/tests/` 检查你的代码
   - 测试文件会检查关键功能（后验计算、MCMC 采样等）

### 常见问题

**Q1：PyMC 报错 "SamplingError"**
- A：检查先验和似然是否合理（比如 Binomial 的 p 参数必须在 [0, 1]）

**Q2：R-hat > 1.05**
- A：增加采样量（`pm.sample(5000, tune=3000)`），或检查模型是否有问题

**Q3：ESS 太小（< 400）**
- A：增加采样量，或调整 `target_accept` 参数（如 `target_accept=0.95`）

**Q4：代码跑得太慢**
- A：减少采样量（如从 5000 降到 3000），或用 `chains=2`（最少 2 条链）

---

## 最后提醒

1. **固定随机种子**：在所有代码中设置 `np.random.seed(42)`，确保结果可复现

2. **先验敏感性分析**：不要只试一种先验就下结论

3. **收敛诊断**：MCMC 必须检查 R-hat 和 ESS，否则结果不可信

4. **解释清晰**：不要只列数字，要解释决策含义

5. **StatLab 更新**：别忘了在你的 StatLab 报告中添加贝叶斯章节

祝你好运！贝叶斯思维是从"统计计算"到"决策思维"的关键跃迁，本周作业会帮你完成这个跃迁。
