# 《Python 程序设计（Agentic Coding）》写作宪法

本文件是全书的**最高约束**。所有 subagents、skills、team mate 的输出都必须遵守。

## 目标与读者

| 项目 | 说明 |
|------|------|
| 读者 | 零基础（第一次学编程）或只会一点点 Python 的初学者 |
| 目标 | 用"工程化 + agentic 工作流"掌握 Python 基本功（从脚本到可维护的小工具） |
| 语言 | 中文；关键术语括注英文 |
| 课程结构 | 14 周，三阶段：入门基础 → 工程进阶 → 综合实战 |
| 设计哲学 | 经典教材的教学设计 + AI 时代的工程素养 |

---

## 全书叙事人格

本书的叙事声音是**一位有经验的编程老师坐在学生旁边**——亲切但不啰嗦，幽默但不油腻，严谨但不枯燥。

### 声音特征

| 维度 | 要 | 不要 |
|------|----|------|
| 语气 | 像朋友聊天："你试试这样写" | 像领导讲话："我们需要认识到" |
| 解释 | 用具体场景："你写了个计算器，但用户输入了'abc'——炸了" | 用抽象定义："异常是程序运行时的非正常状态" |
| 鼓励 | 承认困难："第一次见确实有点奇怪，多写几次就好" | 过度鸡汤："相信自己，你一定可以的！" |
| 幽默 | 适度自嘲和意外："Python 不会猜你想说什么——它又不是你妈" | 强行抖机灵、烂梗、emoji 堆砌 |

### 循环角色

全书使用 3 个循环角色增强代入感。角色详细设定见 `shared/characters.yml`。

| 角色 | 定位 | 典型出场方式 |
|------|------|-------------|
| **小北** | 零基础学生，代表读者 | "小北试着运行了一下，结果报错了……" |
| **阿码** | 好奇心强的同学，爱问"为什么" | "阿码举手：如果变量名用中文行不行？" |
| **老潘** | 工作多年的前辈，给工程视角 | "老潘说：在公司里我们从来不会这样写，因为……" |

**使用规则**：
- 角色不是每节必出现，但每章至少出现 2 次
- 角色用来制造对话感和多视角，不是装饰
- 角色性格必须前后一致（由 `consistency-editor` 检查）

---

## 全书贯穿项目线（"超级线"）

除了每周独立的贯穿案例（名片生成器、猜数字等），全书有一条**跨越 14 周的项目演进线**。

### 超级线：PyHelper — 你的命令行学习助手

读者从 Week 01 开始，逐周给 PyHelper 添加功能。到 Week 14 它变成一个可发布的 CLI 工具。

| 阶段 | 周次 | PyHelper 进展 |
|------|------|--------------|
| 入门 | 01 | 能打印一句鼓励的话 |
| 入门 | 02 | 能根据心情推荐学习建议（if/else） |
| 入门 | 03 | 把功能拆成函数，加菜单 |
| 入门 | 04 | 用字典存学习记录，能查询和统计 |
| 入门 | 05 | 把学习记录存到文件，下次打开还在 |
| 进阶 | 06 | 处理各种输入错误不崩溃 |
| 进阶 | 07 | 拆成多模块项目结构 |
| 进阶 | 08 | 给核心功能补全测试 |
| 进阶 | 09 | 支持搜索和过滤学习笔记（文本处理） |
| 进阶 | 10 | 学习记录改用 JSON 格式，支持导入导出 |
| 实战 | 11 | 用 dataclass 管理笔记和学习计划状态 |
| 实战 | 12 | 用 argparse 做完整 CLI（add/list/search/export） |
| 实战 | 13 | 用 agent team 协作完善文档和测试 |
| 实战 | 14 | Capstone 收敛发布 |

**超级线规则**：
- 每周 CHAPTER.md 末尾（小结之前）有一节 `## PyHelper 进度`，展示本周对 PyHelper 的改进
- 代码放在 `examples/` 最后一个编号（如 `05_pyhelper.py`）
- 超级线代码必须在上周基础上演进（不能每周从头写）
- 详细设计见 `shared/book_project.md`

---

## 认知负荷预算

每周引入的新概念数量有上限。超过预算的章节必须拆分或简化。

| 阶段 | 周次 | 新概念上限 | 回顾桥最低要求 |
|------|------|-----------|---------------|
| 入门基础 | 01-05 | 4 个/周 | 至少引用前 2 周的 2 个概念（Week 01 豁免） |
| 工程进阶 | 06-10 | 5 个/周 | 至少引用前 3 周的 2 个概念 |
| 综合实战 | 11-14 | 4 个/周 | 至少引用前 4 周的 3 个概念 |

### 概念管理

- 每周新概念在 `TERMS.yml` 登记，同步合入 `shared/glossary.yml`
- 全书概念图谱记录在 `shared/concept_map.yml`，标注首次引入周和计划复现周
- `syllabus-planner` 规划时必须检查本周新概念数是否超预算

### 回顾桥

**回顾桥**是指在新内容中自然地引用和强化之前学过的概念。不是生硬的"复习"，而是在新场景下让旧概念再次出场。

好的回顾桥："上周你用 `for` 循环遍历了列表——这周我们要遍历的不是列表，是文件里的每一行。同样的 `for`，不同的数据源。"

坏的回顾桥："回顾：上周我们学了 for 循环。for 循环的语法是……"（这是复习，不是桥）

---

## AI 辅助编程的渐进融合

AI 辅助编程不只是侧栏话题，而是贯穿全书的教学方法论。设计一条从"纯手写"到"人机协作"的渐进路径。

| 阶段 | 周次 | AI 融合程度 | 具体做法 |
|------|------|-----------|---------|
| 观察期 | 01-03 | 了解但不依赖 | 侧栏介绍 AI 编程工具的存在；强调"先理解原理" |
| 识别期 | 04-07 | 学会审视 AI 代码 | 作业中加入"AI 生成代码评审"练习（给一段 AI 写的代码，找 bug） |
| 协作期 | 08-10 | 用 AI 辅助测试和调试 | 作业中加入"用 AI 辅助写测试用例"或"让 AI 帮你调试"的可选挑战 |
| 主导期 | 11-14 | human-in-the-loop | 学生用 AI 结对编程完成项目，但必须理解和审查所有代码 |

**规则**：
- Week 01-03 的作业**禁止**要求使用 AI 工具
- Week 04+ 的 ASSIGNMENT.md 中可以有 `### AI 协作练习（可选）` 小节
- 每个 AI 协作练习必须包含"审查清单"——学生不能直接用 AI 输出，必须检查
- 详细路径设计见 `shared/ai_progression.md`

---

## 每周章包 Definition of Done (DoD)

对任意 `chapters/week_XX/`，发布前**全部**必须满足：

1. **文件齐全**：
   - `CHAPTER.md` / `ASSIGNMENT.md` / `RUBRIC.md` / `QA_REPORT.md`
   - `ANCHORS.yml` / `TERMS.yml`
   - `examples/` / `starter_code/solution.py` / `tests/`
2. **测试通过**：`python3 -m pytest chapters/week_XX/tests -q`
3. **QA 阻塞项清零**：`QA_REPORT.md` 的"阻塞项"下不存在未勾选 `- [ ]`
4. **术语同步**：`TERMS.yml` 中的 `term_zh` 必须已进入 `shared/glossary.yml`
5. **锚点完整**：`ANCHORS.yml` 的 `id` 周内唯一，`claim/evidence/verification` 齐全
6. **叙事质量**：`student-qa` 四维评分总分 >= 18/20（详见下方）
7. **认知负荷**：新概念数不超过本阶段预算；回顾桥数量达标
8. **超级线推进**：CHAPTER.md 包含 `## PyHelper 进度` 小节

上述规则由 `scripts/validate_week.py` 强制执行；`.claude/hooks/` 默认只做提示（非阻塞）。

如需把 hooks 作为"硬闸门"拦截任务完成/空闲事件，可在 Claude Code 的环境变量里设置：
- `TEXTBOOK_HOOK_STRICT=1`

### 叙事质量四维评分（student-qa 输出）

| 维度 | 分值 | 评什么 |
|------|------|--------|
| 叙事流畅度 | 1-5 | 结构有变化、过渡自然、不模板化 |
| 趣味性 | 1-5 | 有想继续读的冲动、有意外和共鸣 |
| 知识覆盖 | 1-5 | 概念准确、覆盖完整、代码可运行 |
| 认知负荷 | 1-5 | 难度适当、不超载、有回顾桥 |

**总分 >= 18 分才能 release。** 任一维度 <= 2 分视为阻塞项。

**修订回路规则（简化版：2 档处理）**：
- 评分 >= 18：轻量修订后通过（回传 prose-polisher 处理建议项）
- 评分 < 18：结构性重写（回传 chapter-writer 大幅改进）
- 最多 3 轮修订

### Git/Gitea 建议项（不作为硬闸门）

- `/release-week` 前建议工作区干净（`git status --porcelain` 为空）
- 至少 2 次提交（draft + verify）
- PR 描述引用本周 DoD + 验证通过信息
- 参考：`shared/gitea_workflow.md`

---

## 时效性约束（防止年份过时）

本书涉及大量 AI/技术动态数据（时代脉搏、AI 小专栏等）。为防止生成内容使用过时的年份：

1. **动态日期文件**：`shared/current_date.txt` 在每次流水线启动时由 lead agent 自动生成（`date '+%Y-%m-%d'`）。所有写正文的 agent **必须先读此文件**，获取当前日期。
2. **时代脉搏和 AI 小专栏**中引用的数据、事件、统计数字，必须与 `shared/current_date.txt` 中的年份一致（即"近 1-2 年"应基于当前年份往回推算）。
3. **`参考（访问日期：YYYY-MM-DD）`** 中的日期必须使用 `shared/current_date.txt` 中的实际日期，不要凭记忆填写。
4. **联网搜索查证**时（使用 `WebSearch` 内置工具 / `perplexity` MCP / Context7 MCP 等），搜索关键词应包含当前年份（如 `"GitHub Copilot statistics {当前年份}"`），不要使用模板示例中的旧年份。
5. **syllabus-planner** 在规划 AI 小专栏的"建议搜索词"时，也必须使用当前年份。

---

## ⚠️ 参考链接真实性（全局铁律）

**绝对禁止在任何产出文件中编造参考链接。** 这是全书最高优先级的约束之一。

### 禁止行为

- **禁止凭记忆拼 URL**：AI 模型记忆中的 URL 极不可靠，大量"看起来合理"的链接实际并不存在
- **禁止伪造学术论文链接**：如虚构的 `arxiv.org/abs/XXXX-XXXXX` 编号
- **禁止伪造新闻/报告链接**：如虚构的 Nature、Stanford、MIT 研究 URL
- **禁止伪造统计数据**：如编造"XX% 的开发者"这类具体数字
- **宁可不附参考、不给精确数字，也不能给虚假的**

### 正确做法

1. **使用搜索工具获取真实数据和 URL**（按优先级）：
   - **优先：研究缓存** → 检查 `chapters/week_XX/.research_cache.md`，这是 Lead agent 在流水线 Stage 2.5 预先搜索的成果
   - **优先：WebSearch**（Claude Code 内置工具，最可靠，无外部依赖）→ `WebSearch("搜索关键词")`
   - **备选：perplexity MCP** → `mcp__perplexity__perplexity_search({"query": "...", "recency": "year"})` （AI 增强搜索，带引用）
   - **备选：WebFetch** → `WebFetch("https://具体URL")` （抓取和验证特定网页内容）
   - **技术文档：Context7 MCP** → `mcp__plugin_context7_context7__query-docs(...)` （适合查证 Python/库的最佳实践）
   - **只使用搜索工具返回的 URL**，不要自行修改或拼接
2. **搜索失败时的兜底**：
   - 用模糊表述代替精确数字（如"超过千万"代替"1500 万"）
   - 写 `<!-- TODO: 需联网搜索 "[具体搜索词]" 补充数据和真实参考链接 -->`
   - 不附任何参考链接（空着好过造假）

### 适用范围

此规则适用于所有 agent 产出的所有文件，包括但不限于：
- `CHAPTER.md` 中的时代脉搏段落
- `CHAPTER.md` 中的 AI 时代小专栏
- `ASSIGNMENT.md` 中引用的外部资源
- 任何包含 `https://` 的正文内容

---

## 行文风格

详见 `shared/style_guide.md` + `shared/writing_exemplars.md`。

**三条铁律**：

1. **场景驱动**：先让读者感受到"我需要这个"，再引出概念。概念是答案，不是前提。
2. **贯穿案例**：每章一个渐进式小项目，每节推进一步，章末可运行。
3. **禁止模板感**：不要每节都用相同的子标题结构；不要 bullet list 堆砌做小结。

**质量闸门**：
- `student-qa` 四维评分总分 >= 18/20 才能 release
- 若正文模板化 → 运行 `/polish-week week_XX`（可做结构性改写）
- 代码块必须可运行（或注明"伪代码/节选"）
- 重要结论必须可验证 → 落到 `ANCHORS.yml`

### 章首导入（每章必须）

每章标题之后、学习目标之前，必须包含：

1. **引言格言**：与本章主题相关的名人名言/编程格言，Markdown blockquote 格式
2. **时代脉搏**：200-300 字导入段落，用近 1-2 年的 AI/技术事件引出本章主题，不加标题

详细格式和示例见 `shared/style_guide.md` 的"章首导入"章节。

### 写作元数据必须注释

CHAPTER.md 中的**写作元数据**（Bloom 标注、概念预算表、AI 专栏规划、角色出场规划、章节结构骨架等）**必须**用 HTML 注释 `<!-- ... -->` 包裹。规划阶段产出的所有中间产物都不能出现在渲染后的正文中。

详细清单见 `shared/style_guide.md` 的"写作元数据注释规范"章节。

### Context7 技术查证（写作前必做）

Python 及其生态持续演进。为确保代码示例是当前版本的正确写法，**所有写正文的 agent 必须在动笔前使用 Context7 MCP 查证本章涉及的核心技术点**：

1. 用 `resolve-library-id` 定位相关库
2. 用 `query-docs` 查询具体的最佳实践和 API 用法
3. 将查证结果融入写作，确保示例代码符合当前 Python 最佳实践

详细流程见 `shared/style_guide.md` 的"Context7 技术查证"章节。

## 术语与一致性

- 新术语先在当周 `TERMS.yml` 登记，再合入 `shared/glossary.yml`
- 全书概念图谱维护在 `shared/concept_map.yml`
- 中文为主，英文可选；定义必须短、清晰、可被新手复述
- 循环角色的使用必须与 `shared/characters.yml` 一致

## Team 协作约定（强制）

- 所有 task subject 必须以 `[week_XX]` 开头（hooks 依赖）
  - 示例：`[week_01] Draft chapter outline`
- Lead 建议开启 delegate mode：只拆任务与收敛，不写正文
- **所有写正文的 agent 必须先读 `shared/writing_exemplars.md`**
- **所有写正文的 agent 必须读 `shared/characters.yml`（循环角色）**
- 产出阶段的 teammate（Writer/Example/Assignment/Consistency/Error-fixer）完成任务前，建议确保本周校验通过（hooks 默认提示；开启 strict 后会拦截）
- **规划阶段的 syllabus-planner 不需要跑校验**——此时 ASSIGNMENT.md 等文件尚未产出，校验必然报错
